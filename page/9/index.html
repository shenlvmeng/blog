<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/favicon.png">
  <link rel="mask-icon" href="/blog/favicon.png" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shenlvmeng.github.com","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"N573WZGUR1","apiKey":"f4b654279103617a4cefb92a132ff0c3","indexName":"blog","hits":{"per_page":10}}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="Be sharp, my friend.">
<meta property="og:type" content="website">
<meta property="og:title" content="Shenlvmeng&#39;s Blog">
<meta property="og:url" content="http://shenlvmeng.github.com/blog/page/9/">
<meta property="og:site_name" content="Shenlvmeng&#39;s Blog">
<meta property="og:description" content="Be sharp, my friend.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="shenlvmeng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://shenlvmeng.github.com/blog/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Shenlvmeng's Blog</title>
  






  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Shenlvmeng's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shenlvmeng"
      src="/blog/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">shenlvmeng</p>
  <div class="site-description" itemprop="description">Be sharp, my friend.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">152</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">469</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/shenlvmeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;shenlvmeng" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/shenlvmeng" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;shenlvmeng" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://shenlvmeng.github.com/blog/2019/11/15/degit-improvement/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="shenlvmeng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shenlvmeng's Blog">
      <meta itemprop="description" content="Be sharp, my friend.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Shenlvmeng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/11/15/degit-improvement/" class="post-title-link" itemprop="url">degit认识和改造</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-11-15 21:51:58 / 修改时间：22:17:53" itemprop="dateCreated datePublished" datetime="2019-11-15T21:51:58+08:00">2019-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%B7%A5%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">工程</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2019/11/15/degit-improvement/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/15/degit-improvement/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>13 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>近日写了一个chrome插件的starter-boilerplate。但这类boilerplate被人们使用的方式常常是整合在cli库中。由于仓库本身的模板性质和git历史存在，并不合适使用npm分发或<code>git clone</code>快速搭建项目骨架。</p>
<p>碰巧此前学习svelte的时候接触到了<a target="_blank" rel="noopener" href="https://github.com/Rich-Harris/degit">degit</a>，degit做的事很简单，<strong>复制git仓库代码</strong>。这也正是一个称职的boilerplate发挥光和热的方式。</p>
<h2 id="degit使用"><a href="#degit使用" class="headerlink" title="degit使用"></a>degit使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">degit user/repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># these commands are equivalent</span></span><br><span class="line">degit github:user/repo</span><br><span class="line">degit git@github.com:user/repo</span><br><span class="line">degit https://github.com/user/repo</span><br><span class="line"></span><br><span class="line">degit user/repo my-new-project</span><br></pre></td></tr></table></figure>

<p>上面是一个degit的基本用法，类似<code>git clone</code>指定仓库地址和本地目录名，默认将项目当前<code>master</code>分支的代码拷贝到本地。还可以在仓库后使用<code>#</code>分隔，指定分支名、tag名或commit hash。目前（2019&#x2F;11&#x2F;12）degit支持github、gitlab、BitBucket以及Sourcehut，暂不支持私有仓库。</p>
<p>在一些情况下，我们可能希望在拷贝完代码后进行一些后置操作，如拷贝关联仓库或删除不必要文件等。对此，degit设计了<strong>actions</strong>来支持，可以在当前目录的<code>degit.json</code>中声明。目前actions只有<code>clone</code>和<code>remove</code>两种。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// degit.json</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;clone&quot;</span>,</span><br><span class="line">        <span class="string">&quot;src&quot;</span>: <span class="string">&quot;user/another-repo&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;remove&quot;</span>,</span><br><span class="line">        <span class="string">&quot;files&quot;</span>: [<span class="string">&quot;LICENSE&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="degit优势"><a href="#degit优势" class="headerlink" title="degit优势"></a>degit优势</h2><p>如README中提到的，degit和<code>git clone --depth 1</code>还是有所区别的：</p>
<ul>
<li><code>git clone</code>后，终归还是会有个<code>.git</code>目录，需要手动重置</li>
<li>degit在实现时增加了缓存策略，在有些情况下不需要重复下载代码，速度更快</li>
<li>“更少的字数”（<code>degit user/repo</code>而不是<code>git clone --depth 1 git@github.com:user/repo</code>）</li>
<li>灵活度更高，如前后置操作如actions的支持</li>
<li>更好的可扩展性，未来可以在degit基础上实现交互等更复杂的设计</li>
</ul>
<h2 id="degit原理"><a href="#degit原理" class="headerlink" title="degit原理"></a>degit原理</h2><p>那么degit快在哪里？它的思路借鉴于<a target="_blank" rel="noopener" href="https://github.com/vutran/zel">zel</a>和<a target="_blank" rel="noopener" href="https://github.com/lukeed/gittar">gittar</a>，即方便快捷地从git仓库中下载需要的源代码。原理上，<strong>利用某些git平台url的特定规则，从平台下载tar.gz包，再本地解压</strong>。</p>
<p>degit实现集中在<code>src/index.js</code>中。<code>src/bin.js</code>只用来实现cli部分的入口代码，<code>src/utils.js</code>则包含了一些工具函数。</p>
<h3 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h3><p>在<code>src/bin.js</code>中，流程分下面几步：</p>
<ol>
<li>利用<a target="_blank" rel="noopener" href="https://github.com/lukeed/mri">mri</a>做了基本的参数处理</li>
<li>实例化Degit对象，注册logger的监听方法</li>
<li>调用<code>clone</code>方法</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> d = <span class="title function_">degit</span>(src, args);</span><br><span class="line"></span><br><span class="line">    d.<span class="title function_">on</span>(<span class="string">&#x27;info&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(chalk.<span class="title function_">cyan</span>(<span class="string">`&gt; <span class="subst">$&#123;event.message.replace(<span class="string">&#x27;options.&#x27;</span>, <span class="string">&#x27;--&#x27;</span>)&#125;</span>`</span>));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    d.<span class="title function_">on</span>(<span class="string">&#x27;warn&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">            chalk.<span class="title function_">magenta</span>(<span class="string">`! <span class="subst">$&#123;event.message.replace(<span class="string">&#x27;options.&#x27;</span>, <span class="string">&#x27;--&#x27;</span>)&#125;</span>`</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    d.<span class="title function_">clone</span>(dest)</span><br><span class="line">        <span class="comment">// .then(() =&gt; &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#125;)</span></span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(chalk.<span class="title function_">red</span>(<span class="string">`! <span class="subst">$&#123;err.message.replace(<span class="string">&#x27;options.&#x27;</span>, <span class="string">&#x27;--&#x27;</span>)&#125;</span>`</span>));</span><br><span class="line">            process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Degit初始化"><a href="#Degit初始化" class="headerlink" title="Degit初始化"></a>Degit初始化</h3><p>对象实例包含下面几个成员，其中repo信息需要处理后才能拿到。</p>
<ul>
<li><code>src</code>，string，用户输入的仓库地址</li>
<li><code>cache</code>，boolean，是否使用缓存，来自命令行<code>-c</code>或<code>--cache</code>参数</li>
<li><code>force</code>，boolean，目标文件夹有内容时，是否覆盖，来自<code>-f</code>或<code>--force</code>参数</li>
<li><code>verbose</code>，boolean，是否打印详细日志，来自<code>-v</code>或<code>--verbose</code>参数</li>
<li><code>repo</code>，处理<code>src</code>拿到仓库的详情，包括<ul>
<li><code>site</code>，网页域名</li>
<li><code>user</code>，用户&#x2F;组织名</li>
<li><code>name</code>，仓库名</li>
<li><code>ref</code>，分支、tag、commit hash</li>
<li><code>url</code>，完整的HTTP url</li>
</ul>
</li>
<li><code>directiveActions</code>，actions配置对应的处理函数，包含<ul>
<li><code>clone</code>，递归处理src的仓库</li>
<li><code>remove</code>，调用<code>remove</code>方法移除指定文件</li>
</ul>
</li>
</ul>
<p>repo信息来自src经过正则匹配出的详细信息。由于要利用一些git平台的url拼接规则，需要排除已知平台以外的url。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支持的范围</span></span><br><span class="line"><span class="keyword">const</span> supported = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="string">&#x27;github&#x27;</span>, <span class="string">&#x27;gitlab&#x27;</span>, <span class="string">&#x27;bitbucket&#x27;</span>, <span class="string">&#x27;git.sr.ht&#x27;</span>]);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params">src</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> match = <span class="regexp">/^(?:https:\/\/([^/]+)\/|git@([^/]+)[:/]|([^/]+)[:/])?([^/\s]+)\/([^/\s#]+)(?:#(.+))?/</span>.<span class="title function_">exec</span>(</span><br><span class="line">        src</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DegitError</span>(<span class="string">`could not parse <span class="subst">$&#123;src&#125;</span>`</span>, &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;BAD_SRC&#x27;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> site = (match[<span class="number">1</span>] || match[<span class="number">2</span>] || match[<span class="number">3</span>] || <span class="string">&#x27;github&#x27;</span>).<span class="title function_">replace</span>(</span><br><span class="line">        <span class="regexp">/\.(com|org)$/</span>,</span><br><span class="line">        <span class="string">&#x27;&#x27;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 排除范围外的url</span></span><br><span class="line">    <span class="keyword">if</span> (!supported.<span class="title function_">has</span>(site)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DegitError</span>(</span><br><span class="line">            <span class="string">`degit supports GitHub, GitLab, Sourcehut and BitBucket`</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;UNSUPPORTED_HOST&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配出用户名、仓库名、分支/tag/commit hash名</span></span><br><span class="line">    <span class="keyword">const</span> user = match[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">const</span> name = match[<span class="number">5</span>].<span class="title function_">replace</span>(<span class="regexp">/\.git$/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> ref = match[<span class="number">6</span>] || <span class="string">&#x27;master&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完整的仓库地址，需要http开头的</span></span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`https://<span class="subst">$&#123;site&#125;</span>.<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        site === <span class="string">&#x27;bitbucket&#x27;</span> ? <span class="string">&#x27;org&#x27;</span> : site === <span class="string">&#x27;git.sr.ht&#x27;</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;com&#x27;</span></span></span></span><br><span class="line"><span class="subst"><span class="string">    &#125;</span>/<span class="subst">$&#123;user&#125;</span>/<span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; site, user, name, ref, url &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="仓库下载"><a href="#仓库下载" class="headerlink" title="仓库下载"></a>仓库下载</h3><p>下载仓库流程如下：</p>
<p><img src="https://s2.ax1x.com/2019/11/15/Mdbl6S.png" alt="degit流程"></p>
<h4 id="获取缓存信息"><a href="#获取缓存信息" class="headerlink" title="获取缓存信息"></a>获取缓存信息</h4><p>degit的缓存放在<code>/home</code>或<code>/tmp</code>下的<code>.degit</code>目录下，按照<code>site/user/name</code>的目录组织。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存目录</span></span><br><span class="line"><span class="keyword">const</span> base = path.<span class="title function_">join</span>(homeOrTmp, <span class="string">&#x27;.degit&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dir = path.<span class="title function_">join</span>(base, repo.<span class="property">site</span>, repo.<span class="property">user</span>, repo.<span class="property">name</span>);</span><br><span class="line"><span class="keyword">const</span> cached = <span class="title function_">tryRequire</span>(path.<span class="title function_">join</span>(dir, <span class="string">&#x27;map.json&#x27;</span>)) || &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>目录下有一个<code>map.json</code>和缓存的代码tar.gz包，包名格式为<code>&lt;commit-hash&gt;.tar.gz</code>。在map.json保存着此前使用过的分支名&#x2F;tag名&#x2F;简写commit名到commit hash的最新映射关系。形如下方：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;master&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4e3a4089b4f0275964eb10a432dc1c15526a0b4d&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这一步会尝试使用parse好的<code>site</code>、<code>user</code>、<code>name</code>属性找已有的缓存的<code>map.json</code>。没有找到时返回<code>&#123;&#125;</code>。</p>
<h4 id="获取commit-hash"><a href="#获取commit-hash" class="headerlink" title="获取commit hash"></a>获取commit hash</h4><p>这一步分两种情况;</p>
<ul>
<li>使用缓存时，直接从上一步拿到的<code>map.json</code>里面找<code>ref</code>对应的commit hash</li>
<li>不使用缓存时，需要从远端仓库拿分支名&#x2F;tag名到commit hash的对应关系（使用<code>git ls-remote</code>完成）。之后格式化为结构化数据并从中寻找<code>ref</code>对应的commit hash。如果中途失败，则fallback到使用缓存的方式。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchRefs</span>(<span class="params">repo</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; stdout &#125; = <span class="keyword">await</span> <span class="title function_">exec</span>(<span class="string">`git ls-remote <span class="subst">$&#123;repo.url&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stdout</span><br><span class="line">            .<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            .<span class="title function_">filter</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">            .<span class="title function_">map</span>(<span class="function"><span class="params">row</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> [hash, ref] = row.<span class="title function_">split</span>(<span class="string">&#x27;\t&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 格式化过程</span></span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 错误处理</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一步若未找到hash，则无法构造下载的url，从而需要抛出错误。</p>
<h4 id="构造下载地址"><a href="#构造下载地址" class="headerlink" title="构造下载地址"></a>构造下载地址</h4><p>根据不同的git平台固定的源码tar.gz归档url规则，构造下载的url，这也是degit思路的基础。目前支持gitlab、bucket、github风格的url。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 即将下载的tar.gz文件路径</span></span><br><span class="line"><span class="keyword">const</span> file = <span class="string">`<span class="subst">$&#123;dir&#125;</span>/<span class="subst">$&#123;hash&#125;</span>.tar.gz`</span>;</span><br><span class="line"><span class="comment">// 下载的url</span></span><br><span class="line"><span class="keyword">const</span> url =</span><br><span class="line">    repo.<span class="property">site</span> === <span class="string">&#x27;gitlab&#x27;</span></span><br><span class="line">        ? <span class="string">`<span class="subst">$&#123;repo.url&#125;</span>/repository/archive.tar.gz?ref=<span class="subst">$&#123;hash&#125;</span>`</span></span><br><span class="line">        : repo.<span class="property">site</span> === <span class="string">&#x27;bitbucket&#x27;</span></span><br><span class="line">        ? <span class="string">`<span class="subst">$&#123;repo.url&#125;</span>/get/<span class="subst">$&#123;hash&#125;</span>.tar.gz`</span></span><br><span class="line">        : <span class="string">`<span class="subst">$&#123;repo.url&#125;</span>/archive/<span class="subst">$&#123;hash&#125;</span>.tar.gz`</span>;</span><br></pre></td></tr></table></figure>

<h4 id="创建目录并下载"><a href="#创建目录并下载" class="headerlink" title="创建目录并下载"></a>创建目录并下载</h4><p>不使用缓存时，会在创建缓存目录并下载。另外，指定<code>-f</code>或<code>--force</code>参数，会覆盖已有文件路径。最后使用https模块下载文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">cache</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fs.<span class="title function_">statSync</span>(file);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="title function_">mkdirp</span>(path.<span class="title function_">dirname</span>(file));</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">fetch</span>(url, file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新缓存"><a href="#更新缓存" class="headerlink" title="更新缓存"></a>更新缓存</h4><p>下载成功会更新本地缓存，保证以后使用缓存时能使用尽量新的包。</p>
<ol>
<li>当前使用包的commit hash如果和指定分支&#x2F;tag&#x2F;commit hash对应的hash一致，则不需要更新</li>
<li>在需要更新时，检查老的hash是否还有使用，如果没有使用，则清除hash对应的tar.gz包</li>
<li>更新map.json里的对应关系</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateCache</span>(<span class="params">dir, repo, hash, cached</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cached[repo.<span class="property">ref</span>] === hash) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> oldHash = cached[repo.<span class="property">ref</span>];</span><br><span class="line">    <span class="keyword">if</span> (oldHash) &#123;</span><br><span class="line">        <span class="keyword">let</span> used = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> cached) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cached[key] === hash) &#123;</span><br><span class="line">                used = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!used) &#123;</span><br><span class="line">            <span class="comment">// we no longer need this tar file</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fs.<span class="title function_">unlinkSync</span>(path.<span class="title function_">join</span>(dir, <span class="string">`<span class="subst">$&#123;oldHash&#125;</span>.tar.gz`</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cached[repo.<span class="property">ref</span>] = hash;</span><br><span class="line">    fs.<span class="title function_">writeFileSync</span>(</span><br><span class="line">        path.<span class="title function_">join</span>(dir, <span class="string">&#x27;map.json&#x27;</span>),</span><br><span class="line">        <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(cached, <span class="literal">null</span>, <span class="string">&#x27;  &#x27;</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解压tar-gz包"><a href="#解压tar-gz包" class="headerlink" title="解压tar.gz包"></a>解压tar.gz包</h4><p>创建cli中输入的目标目录，并将已下载到缓存中tar.gz包解压到目标路径下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">mkdirp</span>(dest);</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">untar</span>(file, dest);</span><br></pre></td></tr></table></figure>

<h4 id="actions处理"><a href="#actions处理" class="headerlink" title="actions处理"></a><code>actions</code>处理</h4><p>如果在当前目录下获取到了<code>degit.json</code>，则执行后续的<code>clone</code>或<code>remove</code>操作。</p>
<ul>
<li>clone，在目标目录下继续一遍clone流程</li>
<li>remove，删除指定文件或文件夹</li>
</ul>
<h2 id="degit改造"><a href="#degit改造" class="headerlink" title="degit改造"></a>degit改造</h2><p>degit虽好，但从上面也可以看到，支持仓库比较有限，且不支持私有仓库。在公司内部，无法从url推断git仓库类型时，degit就无法工作了。不过，借助degit本身的设计，稍微改造上面提到的“degit初始化”，“构造下载地址”部分，就可以让degit通过传参url风格的形式支持私有仓库。</p>
<ul>
<li>新增<code>-s</code>或<code>--style</code>命令行入参，表示git仓库url的风格，目前设计有github、gitlab、bitbucket这几个degit原始就支持的形式。</li>
<li>解析仓库地址信息时，若有style入参，则先判断是否在上述允许范围内；保留原有从域名解析style的部分，新增若未解析出style，则从入参里取；最后再抛出不支持的仓库地址错误</li>
<li>解析返回数据结构中，新增<code>style</code>字段表示url风格，原有的<code>site</code>为避免歧义，直接使用域名代替原有的域名前缀</li>
<li>在构造下载地址时，直接根据style字段拼接url</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params">src, style</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (style &amp;&amp; !supportedGitStyle.<span class="title function_">has</span>(style)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DegitError</span>(<span class="string">`degit supports styles of github, gitlab, bitbucket`</span>, &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;UNSUPPORTED_STYLE&#x27;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> site = match[<span class="number">1</span>] || match[<span class="number">2</span>] || match[<span class="number">3</span>] || <span class="string">&#x27;github.com&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> gitStyle =</span><br><span class="line">        style ||</span><br><span class="line">        (match[<span class="number">1</span>] || match[<span class="number">2</span>] || match[<span class="number">3</span>] || <span class="string">&#x27;gitlab&#x27;</span>).<span class="title function_">replace</span>(<span class="regexp">/\.(com|org)$/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!supportedGitRepo.<span class="title function_">has</span>(gitStyle)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DegitError</span>(</span><br><span class="line">            <span class="string">`degit supports GitHub, GitLab, Sourcehut and BitBucket without -s/--style parameters`</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;UNSUPPORTED_HOST&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> user = match[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">const</span> name = match[<span class="number">5</span>].<span class="title function_">replace</span>(<span class="regexp">/\.git$/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> ref = match[<span class="number">6</span>] || <span class="string">&#x27;master&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`https://<span class="subst">$&#123;site&#125;</span>/<span class="subst">$&#123;user&#125;</span>/<span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; site, user, name, ref, url, <span class="attr">style</span>: gitStyle &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拼接url处</span></span><br><span class="line"><span class="keyword">const</span> url =</span><br><span class="line">    repo.<span class="property">style</span> === <span class="string">&#x27;gitlab&#x27;</span></span><br><span class="line">        ? <span class="string">`<span class="subst">$&#123;repo.url&#125;</span>/repository/archive.tar.gz?ref=<span class="subst">$&#123;hash&#125;</span>`</span></span><br><span class="line">        : repo.<span class="property">style</span> === <span class="string">&#x27;bitbucket&#x27;</span></span><br><span class="line">        ? <span class="string">`<span class="subst">$&#123;repo.url&#125;</span>/get/<span class="subst">$&#123;hash&#125;</span>.tar.gz`</span></span><br><span class="line">        : <span class="string">`<span class="subst">$&#123;repo.url&#125;</span>/archive/<span class="subst">$&#123;hash&#125;</span>.tar.gz`</span>;</span><br></pre></td></tr></table></figure>

<h3 id="可能存在的问题"><a href="#可能存在的问题" class="headerlink" title="可能存在的问题"></a>可能存在的问题</h3><p>绝大多数私有仓库，都会对用户身份做校验，直接访问tar.gz链接会报401错误。这需要根据不同的内部平台自己做处理了。</p>
<p>因为特殊原因，改造后的包和代码不提供。</p>
<p><em>–END–</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://shenlvmeng.github.com/blog/2019/11/02/social-psychology-part-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="shenlvmeng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shenlvmeng's Blog">
      <meta itemprop="description" content="Be sharp, my friend.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Shenlvmeng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/11/02/social-psychology-part-4/" class="post-title-link" itemprop="url">社会心理学 Part 4 - 应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-02 21:48:37" itemprop="dateCreated datePublished" datetime="2019-11-02T21:48:37+08:00">2019-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-11-15 22:26:05" itemprop="dateModified" datetime="2019-11-15T22:26:05+08:00">2019-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%80%9D%E8%80%83/" itemprop="url" rel="index"><span itemprop="name">思考</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2019/11/02/social-psychology-part-4/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/02/social-psychology-part-4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>参考《社会心理学》 David G. Myers 第8版</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://shenlvmeng.github.io/blog/2019/07/26/social-psychology-part-1/">社会心理学 Part 1 - 导论 &amp; 社会思维</a><br><a target="_blank" rel="noopener" href="https://shenlvmeng.github.io/blog/2019/08/07/social-psychology-part-2/">社会心理学 Part 2 - 社会影响</a><br><a target="_blank" rel="noopener" href="https://shenlvmeng.github.io/blog/2019/09/24/social-psychology-part-3/">社会心理学 Part 3 - 社会关系</a></p>
</blockquote>
<h2 id="临床领域的应用"><a href="#临床领域的应用" class="headerlink" title="临床领域的应用"></a>临床领域的应用</h2><p>有时候你会遭遇生活中不顺的事情，这时<em>关注自我的焦虑会让你的情绪更加糟糕</em>。临床心理学将社会心理学一些概念和社会中实际应用连接起来。</p>
<h3 id="临床诊断的误差"><a href="#临床诊断的误差" class="headerlink" title="临床诊断的误差"></a>临床诊断的误差</h3><p>与非临床心理学家相比，临床心理学家更欢迎依赖于感受而非公式、统计分析的认识方式。<em>临床诊断</em>也是社会决策的一种，所以也会受到之前提到的错觉影响。我们需要提前了解可能导致错误印象的原因，以避免严重的误诊。</p>
<ul>
<li><strong>相关错觉</strong>，当研究领域难以做到定量时，就容易形成假相关性。查普曼等人的实验发现，假如学生或心理学家<strong>期望</strong>得到一种相关，那么他们大多数能得到这种相关。</li>
<li><strong>事后聪明和过分自信</strong>，人们在先入为主时很容易陷入过分自信，另外人们很容易从结论倒推到线索，形成事后聪明；事先知道某人自杀的被试更倾向于从材料中<em>预见到</em>他的自杀行为。</li>
<li><strong>自我证实的诊断</strong>，由于临床心理健康工作者可以自由选择询问问题，人们也往往会提供符合临床医生期望的信息。斯奈德和斯旺发现，人们总是寻找能够验证某一特质的信息来做测验，当面对一堆结构化的题目可以选择时，即使是最有经验的心理治疗师，在测验被试是否外向时，也会倾向于选择那些更容易引起外向行为的问题。</li>
<li><strong>统计预测优于临床预测</strong>。面试就是一个例子。在能进行访谈的情况下，临床心理学家的预测会更为差劲。对此的一个解释是，<em>我们高估了自己的认知能力</em>。</li>
</ul>
<p>要避免上面的误区就要相信数据，依赖于记录而非记忆，结合科学方法来验证假设——系统的观察和实验。</p>
<h3 id="心理问题"><a href="#心理问题" class="headerlink" title="心理问题"></a>心理问题</h3><h4 id="抑郁"><a href="#抑郁" class="headerlink" title="抑郁"></a>抑郁</h4><p>Alloy和Abramson的实验发现，抑郁的学生能准确地认识自己的控制程度。这种<strong>抑郁现实主义</strong>似乎说明，普通人往往夸大自己的能力和受欢迎程度，抑郁的人则有更清醒的认识，他们身份并没有体现出普通人的过分利己、控制错觉、对未来的不现实预期。良好的心理健康状况，正是建立在能把事情看得比实际好一些，并能在黯淡的现实中看到光明的能力上。</p>
<p>抑郁还体现在<strong>消极的解释风格</strong>，抑郁的人更倾向于将失败和挫折的原因归结为<strong>稳定的</strong>、<strong>普遍的</strong>和<strong>内在的</strong>。抑郁心境带来负面思维，负面思维又可以导致抑郁心境，形成恶性循环。有时这种负面思维可以使我们在面对未来生活时采用更好的策略，而抑郁倾向的人则总是自我关注的反思和自责。</p>
<p>压力导致的思虑受到消极归因的过滤和影响，很容易导致抑郁，有消极归因风格的人更容易在遇到不好的事情是变得抑郁。相反，当人们不那么关注自己而是将注意力集中在自身外的事情上时，会更容易得到快乐。抑郁是负性认知的原因和结果。</p>
<h4 id="孤独"><a href="#孤独" class="headerlink" title="孤独"></a>孤独</h4><p>孤独不等于孤单。感到孤独是感到被一个群体排斥、不被周围人喜欢、不能分享自身感受、与周围环境格格不入。男性更容易在被群体孤立时感到孤独，女性则是在被剥夺了一段亲密关系后更容易感到孤独。这似乎也验证了，男性的关系往往是<strong>肩并肩</strong>的，而女性的关系往往是<strong>面对面</strong>的。</p>
<p>孤独更容易让人产生负面认知，由于自我表露困难，他们蔑视自我表露太快太多的人，他们往往过度敏感，而且自尊较低。与不孤独的人相比，他们在和陌生人聊天时，更多谈论自己的事情而很少关心谈话对象的情况。</p>
<h4 id="焦虑"><a href="#焦虑" class="headerlink" title="焦虑"></a>焦虑</h4><p>社会焦虑，即<em>当我们想给他人留下好印象，但又怀疑自己能否做到的时候，我们就会感到焦虑</em>。比如：</p>
<ul>
<li>和身居高位的人交往</li>
<li>在一个评价场景下</li>
<li>过分敏感</li>
<li>身处一个新奇的没有概念的情境中，对社交规则并不熟悉</li>
</ul>
<p>这种情形下的自然倾向就是小心翼翼的自我保护：谨言慎行，不过分自信，和善且保持微笑。害羞是一种以过度敏感和担心别人想法为特征的社会焦虑。这种倾向的极端就是偏执狂，他们常常高估了其他人对自己的关注和评价程度。</p>
<p>为了减少这种社会焦虑，有些人会求助于酒精，通过酒精降低自我意识而达到减轻焦虑的效果。酒精滥用和焦虑也可以具有自我保护的功能，为自己贴上焦虑、害羞、酗酒的标签，就能为失败提供借口。但如果我们给害羞的人提供另一种更为方便地解释他们焦虑和失败的说法，他们就很可能放弃上面那种策略，从而变得不再害羞。</p>
<h4 id="疾病"><a href="#疾病" class="headerlink" title="疾病"></a>疾病</h4><p>在工业时代。至少一半的死亡和行为联系在一起。</p>
<p><strong>对疾病的反应</strong></p>
<ul>
<li>一旦发现症状，我们通常会用熟悉的疾病模式去解释，医科学生有时候会把病人的症状归结为最近学习的疾病模式</li>
<li>有些疾病是<strong>社会性构造</strong>的，如女性在经期前两三天，会更多感受到抑郁、紧张和易怒。实际上，这些感受会时常出现，但在生理周期临近时，就会被归结为经前综合征（PMS）。那些<strong>回忆</strong>自己经前情绪不佳的女性，在以记录的每日报告中并未表现出和其他时候的差别</li>
<li>人们认为症状来自于身体而不是心理时，他们会更愿意寻求治疗。女性比男性更多地报告症状，一方面她们对自己的内在状况更关注，另一方面，她们更愿意承认自己是软弱的，并寻求帮助</li>
<li>医生为病人开出的治疗方案更易理解时，病人更愿意接受治疗指示。如有40%存活几率就比有60%不能存活几率要更容易被接受</li>
</ul>
<p><strong>情绪与疾病</strong></p>
<p>心脏病和一种好斗的、缺乏耐心的以及易怒（很重要的一点）的人格相关联。消极情绪导致了慢性病人中抑郁和焦虑的高发率。</p>
<p>习得性无助的动物反应更消极，血液中检查表现出免疫反应更低。同样地，经受高度压力体验的人更易患病。</p>
<p>乐观主义者——那些对好事有稳定、普遍、内在解释的人通常比悲观主义者活得长。健康行为——运动、良好的营养条件、不酗酒都是促进乐观主义者长寿的基本因素。有研究者相信，积极的、充满希望的归因放个是一剂良药，著名的<strong>安慰剂效应</strong>就是一个应用（你认为一种治疗会起作用，那么它就会起作用）。</p>
<h3 id="社会心理治疗"><a href="#社会心理治疗" class="headerlink" title="社会心理治疗"></a>社会心理治疗</h3><p>社会心理学的治疗是不存在的，有的是利用社会心理学原则的现有治疗技术。下面是一些例子。</p>
<h4 id="外显行为引发内在变化"><a href="#外显行为引发内在变化" class="headerlink" title="外显行为引发内在变化"></a>外显行为引发内在变化</h4><p>态度来源于行为。我们即使不能通过意志力控制我们的感情，也能够通过行为来间接影响它。实验发现，我们说过的有关自己的话，能够影响我们的感觉，被实验者引导写自我赞美散文的被试表现出了更高的自尊。</p>
<p>对选择的知觉也很重要，被提醒是自愿选择减肥计划的儿童，表现出更高的责任感，也获得了更好的减肥效果。</p>
<h4 id="打破恶性循环"><a href="#打破恶性循环" class="headerlink" title="打破恶性循环"></a>打破恶性循环</h4><p>通过改变环境，训练个体更加积极的行为方式，转变消极思维，可以改善抑郁、孤独、社会性焦虑等等情况。</p>
<ul>
<li><strong>社会技能训练</strong>让个体可以在安全情境下练习新的行为，随着个体开始享受应对自如的好处，一个更加积极的自我知觉就可以形成。在人们在被引导下做出改变，他们才会倾向于归因于<em>自己的努力</em>而非他人的帮助，从而认可自己是有社会能力的。而这是咨询做不到的。</li>
<li>有些情况下，人们拥有社会技能，但是身边吹毛求疵的人是他们认为没有。<strong>解释风格疗法</strong>帮助他们通过每日记录，将成功的一部分归因于内在，失败的一部分归因于外在，从而利用改变归因改善了他们的消极情绪</li>
</ul>
<h4 id="利用内在归因"><a href="#利用内在归因" class="headerlink" title="利用内在归因"></a>利用内在归因</h4><p>一旦人们有所提高，将其归因于<strong>受自己控制</strong>的因素而非外在时，效果最为持久。相反，强制性手段会引发最强烈和迅速的行为改变，但是随着强制性手段消失，改变也会很快消失。</p>
<p>在一个减肥计划的实验中，被要求将饮食计划归因于自己的一组在减肥后保持了减肥效果。因为他们<strong>相信自己做到了</strong>。</p>
<h4 id="利用社会影响"><a href="#利用社会影响" class="headerlink" title="利用社会影响"></a>利用社会影响</h4><p>使用周到的<strong>中心途径</strong>提供更持久的态度和行为转变（说服）。因此，在治疗中，不要引起病人对专家表面上的同意，而是要改变病人自己的思维。治疗师的任务只是提供意见，给出有说服力的论证，并提出适当的问题来引导积极有利的想法。</p>
<p>引用哲学家帕斯卡在1620年《思想录》中的一句话：</p>
<blockquote>
<p>人们通常对他们自己发现的道理，比由别人发现的更加深信不疑</p>
</blockquote>
<h3 id="社会关系促进心理健康"><a href="#社会关系促进心理健康" class="headerlink" title="社会关系促进心理健康"></a>社会关系促进心理健康</h3><p>亲密关系会更多带来健康和幸福，而不是疾病。</p>
<p>亲密关系可以预测健康，那些给予最多社会支持的人寿命更长。这么来看，付出比仅仅是索取对自己更好。相反失去人际纽带则会增大患病可能性。在超过80个研究中，心血管及免疫系统的良好运行和社会支持呈现正相关。因此当我们遇到不快乐的事情时，朋友的建议、帮助、安慰的确是一剂良药。积极应对相比抑制情感，更有助于避开疾病风险。</p>
<p>贫困和收入不平等的地区，人们的寿命也相对较短。</p>
<p>除了健康，亲密关系也会带来幸福感。在个人主义国家中，那些报告集体主义倾向的人幸福感也相对较高。友谊和婚姻都能促进幸福感。大量的研究结果证明，大多数有依恋关系的人比没有的人更为幸福。已婚者报告感到更幸福，对生活的满意度也更高。当然，与是否结婚相比，更重要的是婚姻质量，幸运的是，大部分的已婚者婚姻是幸福的。</p>
<p>为什么已婚的人普遍更加幸福？一方面，已婚者更可能享受一种<strong>持久的、支持性的、亲密的人际关系</strong>，且更少感到孤独；另一方面，婚姻提供了配偶和伴侣的角色，这可以提供<strong>自尊的额外来源</strong>。举例，当工作失败时，我们还可以认为自己是一个好丈夫和一个好父亲。</p>
<p>提升幸福感有些可以考虑的地方：</p>
<ul>
<li><strong>控制你的时间</strong>，幸福的人感觉到他们能掌控自己的生命，这从他们对时间的掌握开始</li>
<li><strong>寻找合适的工作和休闲，发挥你的技能</strong></li>
<li>参加运动，获得健康身体</li>
<li><strong>保证充足睡眠</strong>，从而获得积极和精力旺盛的生活</li>
<li><strong>优先考虑亲密的人际关系</strong>，同时也要珍视这样的关系，不要认为他们对你好是理所当然</li>
<li><strong>关注自我以外的事</strong>，向需要帮助的人伸出援手</li>
<li>照顾自己的<strong>精神自我</strong></li>
</ul>
<h2 id="司法领域的应用"><a href="#司法领域的应用" class="headerlink" title="司法领域的应用"></a>司法领域的应用</h2><h3 id="目击者的证词可靠吗"><a href="#目击者的证词可靠吗" class="headerlink" title="目击者的证词可靠吗"></a>目击者的证词可靠吗</h3><p>证词的说服力受到生动性影响。</p>
<ul>
<li>生动的轶事和个人证词往往比强有力、抽象的信息更有说服力。实际上，目击者的生动解释很难被从陪审员的脑中抹除。</li>
<li>但是，目击者描述的生动并不代表描述的正确性。甚至有时，对细节描述较差的目击者反而能提供最准确的信息。</li>
</ul>
<p>目击者证词并不总是正确的，在研究中证实，目击者常因过于自信而有失准确。而这种自信让陪审员觉得证词更可靠。除非条件非常合适，最烦外貌特征非常显著，否则目击者确信程度和证词准确性只有中等程度相关。毕竟人眼不是摄像机，在视角、表情、光线上的细微差别人是不易察觉到的；同时，我们的记忆也是我们当时所知觉到的，一部分是基于我们的预期、看法和当前知识。</p>
<p>另外，在<strong>误导信息</strong>影响下，目击者可以回忆起错误的过去，并坚信记忆是真实的。<strong>重述</strong>也能使人们更容易相信回忆起来的东西，如接受了被告律师采访后，目击者给法官的证词更偏向被告。</p>
<p>人的记忆是不准确的，给予目击者证词的不同反馈，也会影响之后目击者的认识和证词。</p>
<h4 id="提高证词准确性"><a href="#提高证词准确性" class="headerlink" title="提高证词准确性"></a>提高证词准确性</h4><ul>
<li>开放式、没有立场的答案很简单的问题</li>
<li>充足的不受打断的时间回想</li>
<li><strong>准确的辨识总是自动的涌现的不太费力的</strong></li>
<li>在列队指认时明确他们看到的人可能在、也可能不在这个队列里，让目击者一次只看一个人，只给出“是”或“不是”这样简单的回答</li>
<li>使用上面的经验训练陪审团</li>
</ul>
<h3 id="影响陪审团判断的因素"><a href="#影响陪审团判断的因素" class="headerlink" title="影响陪审团判断的因素"></a>影响陪审团判断的因素</h3><p>陪审团能撇开偏见，以事实为根据，达成一致的判决。此时，事实起决定性作用。但是在做<em>社会决策</em>时，如被告是否有意犯罪，就会受到其他因素影响。</p>
<h4 id="被告特征"><a href="#被告特征" class="headerlink" title="被告特征"></a>被告特征</h4><ul>
<li>地位较高的被告常得到更为宽大的处理</li>
<li>漂亮的人们看起来更像好人</li>
<li><strong>在证据不足或很模糊时</strong>，审判会受到被告外表的影响。如果被定罪，没有吸引力的人使人们觉得更加危险，特别是性侵犯案件</li>
<li>和陪审团的相似性会带来好感，从而激发陪审团的同情心</li>
</ul>
<h4 id="法官指示"><a href="#法官指示" class="headerlink" title="法官指示"></a>法官指示</h4><ul>
<li>法官给陪审团的提示可能并不会达到预期效果，如提醒陪审团忽略不被允许的证据，如被告此前的负面事件。即使陪审员事先发誓保证公正性也不能避免这种影响。</li>
<li>有时，法官的声明反而会造成陪审员的逆反。</li>
</ul>
<p>所以法官通常会<strong>事先提醒</strong>陪审团注意某些特定类型的证据是无关的。</p>
<h3 id="陪审员个体如何受影响"><a href="#陪审员个体如何受影响" class="headerlink" title="陪审员个体如何受影响"></a>陪审员个体如何受影响</h3><h4 id="陪审员的理解"><a href="#陪审员的理解" class="headerlink" title="陪审员的理解"></a>陪审员的理解</h4><ul>
<li>律师以叙事这样生动的形式展示证据时，陪审员最易被说服</li>
<li>法官给予的标准法律术语可能并不能让陪审员理解，从而易走说服外部途径的人容易感情用事，做出过早的判断</li>
<li>陪审员对统计信息意义的理解有限</li>
</ul>
<h4 id="陪审团的选择"><a href="#陪审团的选择" class="headerlink" title="陪审团的选择"></a>陪审团的选择</h4><ul>
<li>审讯律师可以通过排除对自己委托人有偏见的陪审员获得令人满意的审判结果。不过，正如全书最开始提到，态度和个人特征也并不总能预测判决</li>
<li>陪审员公开做公正誓言和法官促使其公正的指示，都可以使绝大多数陪审员遵循公正准则</li>
<li>只有证据模糊时，陪审员的个性和总体态度才产生影响</li>
</ul>
<h4 id="“死刑认定”陪审员"><a href="#“死刑认定”陪审员" class="headerlink" title="“死刑认定”陪审员"></a>“死刑认定”陪审员</h4><p>倾向于死刑定罪的陪审员往往更加专断——更加严厉和具有惩罚性，无视可以减轻罪责的情况，对社会底层的人也更加傲慢。</p>
<h3 id="群体因素对陪审员的影响"><a href="#群体因素对陪审员的影响" class="headerlink" title="群体因素对陪审员的影响"></a>群体因素对陪审员的影响</h3><p>群体影响在陪审团中起着作用。群体裁决通常是最初被至少2&#x2F;3陪审员支持的选择。没有达到时，陪审团往往会悬置不决。</p>
<p>但少数派影响也是存在的。如果占少数的陪审员能够保持一致，坚持不懈，信心十足，他们将最有说服力，特别是在成功引起倒戈时。社会地位高的男性陪审员往往是其中最具有影响力的。另外，支持无罪的少数派会比支持顶嘴的少数派拥有更多成功机会。</p>
<p>受到群体极化影响，高专断小组在最初建议建立惩罚时，商议后会更为严厉；相反，低专断小组商议后会更加宽大。</p>
<h2 id="社会心理学和可持续发展的未来"><a href="#社会心理学和可持续发展的未来" class="headerlink" title="社会心理学和可持续发展的未来"></a>社会心理学和可持续发展的未来</h2><h3 id="全球危机"><a href="#全球危机" class="headerlink" title="全球危机"></a>全球危机</h3><p>人口爆炸、工业化导致的生态恶化带来全球危机，促使我们需要选择可持续发展的生活方式：</p>
<ul>
<li>提高科技效率和农业生产率，发展生态科技</li>
<li>控制消费和人口数量，以公共利益取代走向极端的个人主义和物质主义。倡导公共的思维方式，鼓励学校个性化教育</li>
</ul>
<h3 id="物质主义和财富"><a href="#物质主义和财富" class="headerlink" title="物质主义和财富"></a>物质主义和财富</h3><p>我们大多数人都认为财富和幸福之间必然存在着某种联系。的确，当人们感到不确定、不安全和贫困时，物质主义，即崇尚金钱和财富的观念会比较流行。缺乏安全感时，人们在得到一些新的占有物时常常能获得暂时的情绪提升。70年代以来，物质主义日益膨胀，精神信仰在日益消退。</p>
<p>然而幸福感和财富并不是严格挂钩的：</p>
<ul>
<li>发达国家中会有更多感到满意的人，但是人均GDP超过8000美元的国家中，国家财富和幸福感之间的关系就不存在了</li>
<li>对于富有的人，金钱既可以增加快乐也可以减少快乐</li>
<li>个人<strong>持久</strong>的幸福感并不随个人财富增多而增强。发达国家的经济增长并没有带来明显的民众信心提高</li>
</ul>
<h4 id="为何物质主义不能让人满意"><a href="#为何物质主义不能让人满意" class="headerlink" title="为何物质主义不能让人满意"></a>为何物质主义不能让人满意</h4><p>越是为财富努力奋斗的人体幸福感越低，转而<strong>追求亲密感，个人成长和为社会事业奋斗的人会体验更高质量的生活</strong>。为什么更优越的物质条件没有让我们更快乐呢？有两个主要原因。</p>
<p>一是<strong>人类的适应能力</strong>，第一章中提到，我们通常会<strong>低估</strong>自己的适应能力。<strong>适应水平现象</strong>意味着成功和失败，满意和不满都是相对于当下状态而言的。如果我们不断成功，我们会很快适应成功，以前的良好事件现在会变成中性事件，以前的中性事件现在让人感到失落。Brickman和Campbell指出，“当我们沉浸在某总成就带来的满足感时，它会迅速消退，并以一种冷漠感和更高的努力程度取代”。</p>
<blockquote>
<p>支出增长以适应收入增长 —— 帕金森第二定律</p>
</blockquote>
<p>另一个是<strong>社会比较</strong>的广泛存在。就像高考和大学志愿一样，人类的判断是由比较得出的。我们感觉到的好坏也依赖于我们和谁比较。所以说，社会贫富差距较小时，收入更均等，身边没有人明显超过自己，人民幸福感会得到提升。<strong>向上社会比较</strong>又会带来相对剥夺，从而让人一直处于不满意的状态。</p>
<h3 id="社会心理学给予的帮助"><a href="#社会心理学给予的帮助" class="headerlink" title="社会心理学给予的帮助"></a>社会心理学给予的帮助</h3><ul>
<li>调整适应，正确认识社会比较，有时可以<strong>向下社会比较</strong></li>
<li><strong>后物质主义</strong>逐渐显露，新一代人开始成熟起来，对人际关系、自然平衡的关注在逐渐增加。当今社会中出现了两大潮流：寻找精神港湾和更深入和有意义的追求。</li>
<li>用行动提高生活质量<ul>
<li>亲密、支持性的关系</li>
<li>团体信仰</li>
<li>积极的特质</li>
<li>集中精力（投入精神）于热爱的事业或兴趣</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://shenlvmeng.github.com/blog/2019/09/24/social-psychology-part-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="shenlvmeng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shenlvmeng's Blog">
      <meta itemprop="description" content="Be sharp, my friend.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Shenlvmeng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/09/24/social-psychology-part-3/" class="post-title-link" itemprop="url">社会心理学 Part 3 - 社会关系</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-24 22:56:20" itemprop="dateCreated datePublished" datetime="2019-09-24T22:56:20+08:00">2019-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-11-02 21:49:04" itemprop="dateModified" datetime="2019-11-02T21:49:04+08:00">2019-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%80%9D%E8%80%83/" itemprop="url" rel="index"><span itemprop="name">思考</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2019/09/24/social-psychology-part-3/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/09/24/social-psychology-part-3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>21k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>34 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>参考《社会心理学》 David G. Myers 第8版</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://shenlvmeng.github.io/blog/2019/07/26/social-psychology-part-1/">社会心理学 Part 1 - 导论 &amp; 社会思维</a><br><a target="_blank" rel="noopener" href="https://shenlvmeng.github.io/blog/2019/07/26/social-psychology-part-2/">社会心理学 Part 2 - 社会影响</a><br><a target="_blank" rel="noopener" href="https://shenlvmeng.github.io/blog/2019/11/02/social-psychology-part-4/">社会心理学 Part 4 - 应用</a></p>
</blockquote>
<p>这部分主要讨论社会中个体是如何联系的。</p>
<h2 id="偏见"><a href="#偏见" class="headerlink" title="偏见"></a>偏见</h2><p><em>人们对于肥胖者就有明显的偏见：缺少魅力、不太聪明、不够成功、缺少修养。</em></p>
<h3 id="界定偏见"><a href="#界定偏见" class="headerlink" title="界定偏见"></a>界定偏见</h3><ul>
<li><strong>偏见</strong>即对一个群体及其个体成员预先的负面判断</li>
<li>它是一种<strong>态度</strong></li>
<li><strong>负面评价是偏见的标志</strong></li>
<li>它源于行为辩解的需要，或是负面的<strong>刻板印象</strong></li>
</ul>
<p>刻板印象是对人群先入为主的推测，比如南方人感性，北方人粗犷。本身反映了文化或生理对人群的一种期望，并无大碍。但刻板印象<em>过度概括</em>或明显错误时，就形成了偏见。<strong>偏见的行为表示称为歧视</strong>。歧视包括种族歧视、性别歧视等等。</p>
<h4 id="种族偏见"><a href="#种族偏见" class="headerlink" title="种族偏见"></a>种族偏见</h4><p>关于种族偏见有下面一些研究结果：</p>
<ul>
<li>多数人只能看到其他人身上的偏见</li>
<li><strong>人们在最亲密的社交领域会表现出最明显的偏见</strong>，如婚姻、看病。</li>
<li>种族偏见随着年代发展，文化多样性深入，逐渐由明面表示变成较难察觉的内隐态度。这些态度以一种潜意识的体现。</li>
<li>偏见有一些微妙的隐式表示，如过度的种族敏感性、对成功赞扬过度，对过失批评过度等</li>
</ul>
<h4 id="性别偏见"><a href="#性别偏见" class="headerlink" title="性别偏见"></a>性别偏见</h4><p>性别的刻板印象不仅持有印象的人有，<strong>刻板化群体成员也接受这种刻板印象</strong>。比如，视男性为领导者的刻板印象。刻板印象并不是偏见，只是为有的偏见提供支持。除了坏的刻板印象外，也有好的刻板印象。比如，<strong>大部分人更喜欢女性而非男性</strong>， 即<em>女性妙效应</em>。</p>
<p>类似种族偏见，性别偏见已由堂而皇之转为微妙的偏见。</p>
<h3 id="社会情境"><a href="#社会情境" class="headerlink" title="社会情境"></a>社会情境</h3><p>偏见的来源复杂，社会来源是一部分。</p>
<ul>
<li><strong>不平等的社会地位滋生偏见</strong>。偏见可以帮助有钱有势的人将其经济和社会特权合理化。我们敬重地位高的人具有的能力，同时也喜爱那些能欣然接受自己较低地位的人</li>
<li><strong>社会支配性取向</strong>会影响偏见的接受程度。社会支配性高（即控制欲强）的人乐于接受偏见，比如反对破坏阶级等级的政策</li>
<li>权威人格的人，在孩提时期往往经历过苛刻的规矩。这可能会导致他们压抑自己的敌意和冲动，并将之投射到外群体身上</li>
<li>调查发现，宗教和偏见的相关并不能得出因果关系</li>
<li>偏见在被社会接受后，会有许多人随着<em>从众</em>走上相同的道路</li>
<li>有些社会制度也在不知不觉支持着偏见。比如，杂志和报纸上的男性照片多数专注于面部，而女性则不到1&#x2F;3，因为面孔突出的人被认为更有智慧、抱负和主见。电影、电视上的形象能会强化盛行的文化态度。</li>
</ul>
<h3 id="动机根源"><a href="#动机根源" class="headerlink" title="动机根源"></a>动机根源</h3><h4 id="挫折与攻击：替罪羊理论"><a href="#挫折与攻击：替罪羊理论" class="headerlink" title="挫折与攻击：替罪羊理论"></a>挫折与攻击：替罪羊理论</h4><p><strong>我们遭遇挫折的原因令人胆怯或莫名其妙时，往往会转移敌对方向</strong>。因此，往往繁荣时期更容易维护民族和睦。现实群体冲突理论认为有同样需求的物种竞争将最大化。如，敌视黑人的偏见在经济地位和黑人最接近的拜仁身上最为强烈。</p>
<h4 id="社会同一性理论：感觉比他人优越"><a href="#社会同一性理论：感觉比他人优越" class="headerlink" title="社会同一性理论：感觉比他人优越"></a>社会同一性理论：感觉比他人优越</h4><p>我们在社会中的自我感觉不仅仅包含自己，还包含自己的社会群体。我们将自己和群体联系在一起获得自尊，将自己群体和其他群体比较，并偏爱自己的群体。即<strong>社会同一性</strong>。</p>
<p>人们具有<strong>内群性偏见</strong>，即群体内比群体外好。这也是人们寻求积极自我概念的一个表现形式。当我们群体规模较小、经济地位较低时，我们会更容易表现出内群性偏见。即便是毫无逻辑依据的群体意识，也能产生内群性偏见，比如掷硬币的正反。当我们的群体表现较好时，我们会更强烈地认同该群体，从而使自己感觉更好；相反在表现不好时，内群性偏见就不那么明显。</p>
<p>偏见本身就可以让人获得高人一等的感觉，这本身就是一种心理学收益。对比自尊没有受到威胁的被试，体验到挫折感的学生对自己学校的评价更高；被引发出不安感的被试，在评价他人工作时更加苛刻。甚至，<strong>思考自己的死亡问题</strong>也会引发人们足够的不安全感以强化<em>内群体偏好</em>和<em>外群体偏见</em>。自尊受到威胁时，人们会诋毁外群体，已恢复自尊和社会同一性。相反，一旦归属感得到满足，人们就会更为接纳外群体。</p>
<p>综上，那么怎么避免偏见的动机呢？</p>
<p>首先，深植于潜意识中的偏见没那么好压抑。但也并非完全无法避免，比如产生内疚感，从内在角度出发避免偏见。</p>
<h3 id="认知根源"><a href="#认知根源" class="headerlink" title="认知根源"></a>认知根源</h3><p>知觉错觉是我们解释世界技巧的副产品。刻板印象是我们简化复杂世界的副产品。</p>
<h4 id="类别化"><a href="#类别化" class="headerlink" title="类别化"></a>类别化</h4><p>我们简化环境的方法之一就是分类。刻板印象也是类别化的一种体现。实际场景中还有些因素让我们依赖刻板印象：</p>
<ul>
<li>时间紧迫</li>
<li>心事重重</li>
<li>疲惫不堪</li>
<li>情绪激昂</li>
<li>年轻气盛而无法欣赏多样性</li>
</ul>
<p>实际上，我们会借助一些典型特征对眼前的人<strong>自发类别化</strong>，如中年商人，知识分子等。偏见建立在分类的基础上。</p>
<p>在我们把人划分成群体时，有可能会夸大群体内部的一致性和群体间的差异性，即<strong>外群体同质效应</strong>。，比如从群体决策中高估一个群体的全体一致性。我们越是熟悉一个社会群体，就越能看到起内部的多样性。比如，<strong>与我们自己种族的人相比，其中种族的人看起来更为相像</strong>。</p>
<h4 id="独特性"><a href="#独特性" class="headerlink" title="独特性"></a>独特性</h4><p>具有<em>独特性的人</em>，身上的优点和缺点都会被夸大。吸引我们注意力的人，看似对所发生的一些具有更大的责任。除了注意到独特的人，人们也会关注的那些违背期望的人。</p>
<p>作为独特的人本身，我们有时会错误认为，他人对我们的反应是针对我们的独特性而来，从而曲解他人的行为方式。因此即使双方都是善意的，一个强势的人和一个弱势的人之间自我意识的相互作用也会令双方紧张。同时，人们的<strong>污名意识</strong>会提醒自己在多大程度预期他人对他们产生刻板印象。</p>
<p><em>独特的案例</em>也会加深刻板印象。人们倾向于从个别生动案例来作出概括。独特、极端的案例具有吸引注意力的的效果。因此我们的对一个群体了解越少，就越容易受到少数生动案例的影响。刻板印象假定群体成员和个人特征间存在某种相关性，这其中自然存在虚假相关。</p>
<h4 id="归因"><a href="#归因" class="headerlink" title="归因"></a>归因</h4><p>人们的归因错误也影响着偏见的形成。比如我们总是热衷于将人们的行为归因于他们的内在倾向，而较为忽略重要的情境力量。</p>
<p><strong>利群偏差</strong></p>
<p>我们倾向于关注内群体的积极行为和忽视外群体的。内群体成员的积极行为往往被描述成一种普遍品质，而外群体成员则常被描述成一个特定的、孤立的行为。这在强调谦虚的群体或地位较低的群体中会不那么明显。</p>
<p>责备受害者可以起到为指责者本人优越地位辩护的作用。责备的出现是因为人们把外群体的失败归结于群体成员的内在品性有问题。</p>
<p><strong>公正世界现象</strong></p>
<p>当观察者无力改变受害者命运时，他们就会否定和贬低受害者。公正世界现象即指人们认为“我是一个公正的人，生活在一个公正的世界，因此这个世界的人们得到的是他们应得的东西”（可怜之人必有可恨之处）。这样的认识使人们有贬低受害者的倾向。</p>
<h3 id="偏见的后果"><a href="#偏见的后果" class="headerlink" title="偏见的后果"></a>偏见的后果</h3><h4 id="长期保留的刻板印象"><a href="#长期保留的刻板印象" class="headerlink" title="长期保留的刻板印象"></a>长期保留的刻板印象</h4><p><strong>我们的预断会引导我们的注意、判断和记忆</strong>。在刻板印象形成后，如果群体成员行为验证了期望，则会加深印象；相反，我们会对特殊情况闪烁其词。在现实中的体现就是，你无论怎么努力都无法摆脱某人对你的评价，一旦某人<em>预期</em>和你见面不愉快时，误会就很可能发生。</p>
<p>同时，当群体中出现特殊个体不符合刻板印象时，我们会通过分出一个子类的方式来保证自身认识的自洽，即<strong>再分类法</strong>和<strong>再分群法</strong>。子类作为群体的一部分获得承认。</p>
<h4 id="自我实现的预言"><a href="#自我实现的预言" class="headerlink" title="自我实现的预言"></a>自我实现的预言</h4><p>社会信念会自我验证，偏见会对其对象产生影响，向自我实现的方向发展。</p>
<h4 id="刻板形象威胁"><a href="#刻板形象威胁" class="headerlink" title="刻板形象威胁"></a>刻板形象威胁</h4><p>他人的刻板印象会威胁到个体表现，从而进一步印证刻板印象。比如，在暗示女性“没头脑”的刻板印象后，其在数学等理科表现上会变差。相反，正面的刻板印象可以促进成绩。</p>
<h4 id="个体判断的偏差"><a href="#个体判断的偏差" class="headerlink" title="个体判断的偏差"></a>个体判断的偏差</h4><p>幸运的是，这种偏差有，但是<strong>人们在评价个体时，往往比评价个体构成的群体更为积极</strong>。因为往往群体成员琐碎但生动的信息效果上好于群体泛泛的信息。</p>
<p>不过<strong>强烈而且显然相关</strong>的刻板印象还是会影响我们对个体的判断。同时，刻板印象会影响我们对事件的解释，这在我们对某人的信息模棱两可时较为明显。</p>
<p>在人们的行为违背了我们的刻板印象时，人们会做出比较极端的评价。</p>
<h2 id="攻击行为"><a href="#攻击行为" class="headerlink" title="攻击行为"></a>攻击行为</h2><p>攻击行为即意图伤害他人的身体行为或言语行为。攻击行为按目的不同还可以分为两类：<strong>敌意性攻击行为</strong>由愤怒引起，以伤害为目的；<strong>工具性攻击行为</strong>只是把伤害作为达到其他目的的一种手段。</p>
<h3 id="理论基础"><a href="#理论基础" class="headerlink" title="理论基础"></a>理论基础</h3><h4 id="生物学"><a href="#生物学" class="headerlink" title="生物学"></a>生物学</h4><p><strong>本能论</strong>认为人类的攻击行为源自自我破坏的原始冲动，这种冲动运用到他人身上时，成为了攻击行为。<strong>进化心理学</strong>认为攻击行为对于获取资源、抵抗攻击、威吓甚至干掉情敌、防止配偶不忠都是一种有效的策略，可以帮助他们的基因得到更高的保留几率。</p>
<p><strong>遗传基因</strong>和<strong>神经系统</strong>都对攻击行为有影响作用。另外，生物化学因素也会有影响，如激素和酒精。睾丸激素可以刺激人的攻击行为，神经递质5-羟色胺可以控制冲动，缺乏5-羟色胺的人群自我约束力较低，更愿意承担风险。</p>
<h4 id="挫折-攻击理论"><a href="#挫折-攻击理论" class="headerlink" title="挫折-攻击理论"></a>挫折-攻击理论</h4><p>最早对攻击行为的心理学解释理论是<strong>挫折——攻击理论</strong>，即挫折总会导致某种形式的攻击行为。而攻击能量并非总是朝向挫折源，当对方会表示反对或惩罚时，我们会将敌意转移到<em>安全</em>的目标上。</p>
<p>而后人们发现，并不是所有挫折都会指向攻击行为，也有一些其他因素会导致攻击行为。伯科威茨认为原有理论夸大了挫折和攻击行为间的关联，他认为<strong>挫折产生的只是愤怒——攻击行为的一种情绪预备状态，一旦有共计线索出现就会诱使人们产生攻击行为</strong>。愤怒起源于某个有其他行为选择的人阻挠了我们实现目标。</p>
<blockquote>
<p>“当不幸看上去不可避免时，人们可以耐心地承受；一旦人们感到他们可以摆脱这些不幸，它们就变得令人无法忍受了。 —— 托克维尔 1856</p>
</blockquote>
<p><em>挫折</em>和<em>剥夺</em>是两个要区分开的概念。挫折是指一个人得不到有吸引力的或是值得追求的目标；挫折是指他未能从这个对象上获得<strong>原本预期可以</strong>得到的快乐。这也是为什么生活水平改善并不会消除攻击行为，反而有所促进。当预期和现实有差距时，挫折感便产生了，<strong>即期望和实际所得间的差距产生挫折感</strong>。<strong>相对挫折</strong>是指我们把自己和他人比较时带来的挫折感。因此，电视、广告甚至朋友圈中描绘的幸福生活也是挫折感的一个可能来源。</p>
<h4 id="社会学习理论"><a href="#社会学习理论" class="headerlink" title="社会学习理论"></a>社会学习理论</h4><p>这种理论认为学习同样可以引导攻击行为。</p>
<p>人们可以习得攻击行为的回报，此时，攻击行为变成了为了得到特定回报而采取的手段。比如，恐怖主义可以让无职无权的极端分子获得全世界的关注。通过观察别人，人们也可以进行同样的学习，尤其是未成年的孩子。观察攻击行为不仅降低了他们的自我控制，还教会了他们怎样去攻击。身体富有攻击性的儿童往往来自惯用体罚的家长；得不到父亲关怀的孩子，暴力犯罪的可能性更高。</p>
<p>文化对攻击行为也有所影响，来自崇尚荣誉的文化的人，更易拥有攻击性的心理倾向。</p>
<h3 id="影响因素"><a href="#影响因素" class="headerlink" title="影响因素"></a>影响因素</h3><p>攻击行为的诱发因素有<strong>厌恶事件</strong>、<strong>唤醒</strong>、<strong>媒体</strong>、<strong>群体氛围</strong>。</p>
<h4 id="厌恶事件"><a href="#厌恶事件" class="headerlink" title="厌恶事件"></a>厌恶事件</h4><p>厌恶事件即引起厌恶感受的体验：</p>
<ul>
<li>疼痛</li>
<li>不适的炎热</li>
<li>受攻击</li>
<li>过度拥挤</li>
</ul>
<p>在动物身上的实验表明，遭受的待遇越残酷，它们对同伴施加的行为就越残忍。电击、炎热、“心理疼痛”（受挫）都可以引发攻击。厌恶的气味、香烟味、空气污染和攻击行为都有联系，但是环境因素中<em>炎热</em>是研究较多的。炎热高温会提升报复行为的几率和唤起我们带有敌意的想法。另外，收到攻击或侮辱很容易引起攻击行为。</p>
<h4 id="唤醒"><a href="#唤醒" class="headerlink" title="唤醒"></a>唤醒</h4><p>性唤醒和愤怒等其他形式的唤醒形式是可以相互增强的。挫败、酷热或侮辱性的情境都会提高我们的唤醒水平，这种情况一旦发生，唤醒状态就会和敌对想法、情绪一起构成攻击行为</p>
<h4 id="攻击线索"><a href="#攻击线索" class="headerlink" title="攻击线索"></a>攻击线索</h4><p>前文说过，在攻击线索的触发下，攻击行为最容易发生。<strong>枪支</strong>就会启动敌对性想法和惩罚性判断。它不仅让暴力成为可能，也可以刺激它的发生。枪支不只是提供线索，同时也能拉大攻击者和受害者的距离，让我们更为残忍。</p>
<h4 id="媒体影响：色情文学与性暴力"><a href="#媒体影响：色情文学与性暴力" class="headerlink" title="媒体影响：色情文学与性暴力"></a>媒体影响：色情文学与性暴力</h4><p>色情小说中的色情情节会：1）歪曲女人对性攻击的真实态度；2）增加男人对女人的攻击行为。在实验室实验中，连续观看3周性暴力电影后，男性被试对性暴力的焦虑水平显著下降，表现出对家庭暴力受害者更少的同情，且对受害者受伤程度估计偏低。</p>
<p>色情小说也会导致男性对女性实际的攻击行为。反复观看以强迫性行为为特征的色情影片容易导致：</p>
<ul>
<li>性伴侣吸引力下降</li>
<li>对通奸和女性对男性的性顺从更容易接受</li>
<li>对女性感知更容易从性的角度出发</li>
</ul>
<p>因此，在媒体意识教育中，需要能够让受众重新认识女性对性暴力的真实态度</p>
<h4 id="媒体影响：电视-amp-游戏"><a href="#媒体影响：电视-amp-游戏" class="headerlink" title="媒体影响：电视 &amp; 游戏"></a>媒体影响：电视 &amp; 游戏</h4><p>20世纪末，人们在电视上花的时间越来越多。<em>宣泄</em>假说认为观看暴力节目可以帮助人们释放被压抑的敌意，实际是这样么？</p>
<p>在看电视和行为的<em>相关研究</em>和实验研究中表明，电视和暴力<strong>不仅有相关关系，也有因果关系</strong>，即观看暴力会导致攻击增加。尤其是，当一个<strong>有魅力的人因正当原因实施适当暴力，这种暴力未受惩罚也未表现出伤害</strong>时，观看暴力节目的效果最为显著。暴力节目在三方面增加攻击行为：</p>
<ul>
<li>暴力节目会造成<strong>唤醒状态</strong></li>
<li>观看暴力会使人们<strong>降低抑制</strong></li>
<li>媒体内容会引起<strong>模仿</strong></li>
</ul>
<p>电视上的<strong>亲社会行为</strong>虽然也可以教孩子学习积极行为，但是节目中的攻击行为远远超出爱抚行为。电视在影响行为的同时，也影响着人的思想：</p>
<ul>
<li>重复观看暴力节目会产生<strong>脱敏作用</strong>，即对暴力的情绪敏感度下降。而暴力、尖叫、裸露镜头在电视节目中越来越常见</li>
<li>类似节目会<strong>改变知觉</strong>。看电视多的人会更容易夸张周围世界暴力发生的频率，更害怕人身攻击，更容易产生<em>脆弱感</em></li>
<li>观看暴力节目会启动潜意识中的相关认知，如对攻击性词汇更敏感</li>
</ul>
<p>类似地，电子游戏中的暴力血腥内容也在增多，且相比电视节目，参与感更强， 且会从攻击中获得奖赏，更易诱导人们做出攻击性行为和更富侵略性。和非暴力游戏比，玩暴力游戏时：</p>
<ul>
<li>唤醒水平提高</li>
<li>引发攻击性思维</li>
<li>唤醒攻击性情绪</li>
<li>诱发攻击性行为</li>
<li>减少亲社会行为</li>
</ul>
<p>过度地模拟暴力行为会促使攻击性倾向增强，而非宣泄暴力情绪。</p>
<h4 id="群体影响"><a href="#群体影响" class="headerlink" title="群体影响"></a>群体影响</h4><p>正如群体极化中提到的，群体通过<strong>责任扩散</strong>使攻击行为增大。服从的压力和去个体化使群体成员的自我认同在自身完全投入群体后逐渐消失。群体思维动员一个群体或文化做出异乎寻常的举动是常见现象。如对卢旺达图西族人的大屠杀。群体可以强化攻击倾向。</p>
<h3 id="如何减少攻击"><a href="#如何减少攻击" class="headerlink" title="如何减少攻击"></a>如何减少攻击</h3><p>分析了攻击的影响因素后，如何减少攻击行为呢？</p>
<p><strong>宣泄</strong>即释放聚集的攻击能量。在亚里士多德时代就有宣泄的说法，不过社会心理学家一致认为，与弗洛伊德等人的猜想相反，通过暴力行为不能实现宣泄，反而会增加攻击性。同样的，<strong>表达敌意会导致更多敌意</strong>。</p>
<p>如果攻击行为是习得的，那么减少厌恶体验可以减少攻击行为。</p>
<ul>
<li>避免给人们错误的、不可达到的预期，适当奖励合作性的非攻击性行为</li>
<li>如果要惩罚，需要的是<strong>惩罚的必然性而非严厉性</strong>。提高逮捕率而非刑期会更显著地带来犯罪量减少</li>
<li><strong>体罚会产生消极作用</strong>，根据以前的观点，很强的外部原因并不能内化孩子的行为。可以在孩子很小时奖励敏感性和合作，用非暴力的方式教育孩子达到此目的，积极地表达观点（“清理完你的房间，你就可以出去玩了”而不是“如果不清理好房间，你就别想出去玩”）</li>
<li>减少电视和电影上野蛮、色情、缺乏人性的表演</li>
<li>增加武器（如手枪）的获取难度，避免攻击性刺激</li>
</ul>
<p>有一种观点认为，当类似问题经常出现时，要追根溯源思考根本原因而非表面原因——改造我们的文化，挑战那些腐蚀年轻人的社会毒瘤和重建我们的道德根基。</p>
<h2 id="亲密关系：喜欢和爱"><a href="#亲密关系：喜欢和爱" class="headerlink" title="亲密关系：喜欢和爱"></a>亲密关系：喜欢和爱</h2><p>人和人之间终生的相互依赖性使人际关系成为我们生存的关键。我们会有一种强烈的<strong>归属需要</strong>，即与他人建立持续且亲密关系的需要。</p>
<ul>
<li>从进化角度看，相互依存才能使族群得以繁衍生息</li>
<li>正是因为人们渴望爱和被爱，才会在<em>化妆品、服装和塑形</em>上有巨额投入</li>
<li>社会关系的损伤会影响情绪。人们被拒绝时，会感到抑郁和生活乏味。相反，当我们感到被亲密关系支持时，会更加健康和快乐。</li>
<li>死亡会提醒我们更重视归属需要，重视与他人的关系并与我们所爱的人保持亲密</li>
<li>即使在虚拟世界里，被一个永远不可能见面的人拒绝，也会引起挫败感。这种创伤感会在大脑内有真实的生理对应</li>
</ul>
<p>可见，内心深处的归属需要得不到满足时，就会使我们感到不安。</p>
<h3 id="造就友谊和吸引的因素"><a href="#造就友谊和吸引的因素" class="headerlink" title="造就友谊和吸引的因素"></a>造就友谊和吸引的因素</h3><p><strong>接近性</strong>、<strong>外表吸引力</strong>、<strong>相似性</strong>、<strong>被喜欢的感觉</strong>。</p>
<h4 id="接近性"><a href="#接近性" class="headerlink" title="接近性"></a>接近性</h4><p>接近性相对于产生敌意，更容易产生喜欢。对比<strong>地理距离</strong>，<strong>功能性距离</strong>——人们生活轨迹相交的频率才是关键。有研究者猜测，只要是经常在一起，我们会爱上几乎是任何一个与自己有着大致相同的人格特征并且会回报我们感情的人。</p>
<p>接近诱发喜欢的其中一个原因就是<strong>易得性</strong>——更易产生相互交往。近距离会使人感到亲近。更甚者，仅仅是对相互交往的<strong>预期</strong>就可以引发喜欢。对一个人约会的预期也能促进喜欢。</p>
<p><strong>曝光效应</strong></p>
<p>各种实验表明，熟悉并不会引发轻视。实际上，<strong>熟悉诱发了喜欢</strong>。各种新异刺激——无意义音节、汉字、音乐片段、面孔——的<strong>曝光</strong>都能提高人们对它们的评价。</p>
<ul>
<li>不同语言和年龄的人都偏好自己名字中的字母或母语中频繁出现的字母</li>
<li>人们对熟悉的面孔评价更高，人们更喜欢镜子中镜像版的自己</li>
<li><strong>人们喜欢和自己相关的事物</strong>，如倾向于居住和自己名字相关的城市或选择和名字相关的职业</li>
<li>广告商和政治家们利用这个效应，即使人们对某商品或候选人没什么倾向性，仅仅通过简单的重复（电梯广告的病毒式营销），也可以增加商品销量或得票率。</li>
<li>在广告或政治标语中，通常使用简短的slogan代替唱片大陆，突出候选人名字或商品关键价值</li>
</ul>
<p>Zajonc通过实验发现，人们的直接感受并不借助于意识存在。他认为，<strong>情绪相比于思维是更即时的东西，情绪半独立于思维，可以先于认知</strong>。曝光效应会引发愉快的情绪，但是当重复没完没了时也会引起兴趣减弱。</p>
<p>1990华盛顿州的一次法官选举中，在没有开展竞选活动的情况下，名不见经传的候选人Charles Johnson因为姓名更熟悉战胜了Keith Carlo。</p>
<h4 id="外表吸引力"><a href="#外表吸引力" class="headerlink" title="外表吸引力"></a>外表吸引力</h4><p>人们都说外貌不重要，但行为上却不总是这样。现在的很多研究表示：<em>外貌的确是很重要的</em>。从某个角度说，美貌的确是一种财富。</p>
<p><strong>约会相关</strong></p>
<p>年轻女士的外表吸引力可以<strong>中度预测</strong>她约会的次数，而一位男性的外表对他约会的次数相关性则要小一些。哲学家罗素认为：<strong>“整体上来说，女人倾向于因性格而爱上男人，男人则倾向于因外表而爱上女人”</strong>。哈特菲尔德在明尼苏达大学的实验证实了这一点：<strong>男人的确更在意异性的外表吸引力</strong>。某位女性外表吸引力越大，男性就越喜欢他；当然，男性的外表吸引力也有童颜的效果。美貌使人愉悦。</p>
<p><strong>匹配现象</strong></p>
<p>人们一般与和自己同等吸引力的人结为伴侣。人们在选择伴侣上，尤其是<em>终身伴侣</em>上，倾向于选择不仅在智力，而且在外表吸引力方面和自己匹配的人。</p>
<p>外表上的匹配有利于良好关系的发展和维持。但是很多夫妻的吸引力并不匹配，却仍然幸福。这种情况下，吸引力较差的一方常常有其他方面的品质予以补偿。<strong>男性通常强调自己的财富和地位，并且希望寻求年轻和有吸引力法女性；女性则相反</strong>。</p>
<p><strong>刻板印象</strong></p>
<p>在儿童中，老师们倾向于认为那些有吸引力的孩子在学习上更聪明。所谓的<strong>巴特·辛普森效应</strong>即大多数人都认为，长相一般的孩子，他们的才干和社交技能都不如那些漂亮的同龄人。同时，在其他方面都<em>几乎相同</em>的情况下，我们仍会猜测漂亮的人更快乐、性感热情、更开朗、聪明和成功。这就是<strong>外表吸引力的刻板印象</strong>——美的就是好的。</p>
<p>小时候的童话里，白雪公主是善良且美丽的，而巫婆则是邪恶和丑陋的。尽管两者间并不会有明显相关性。</p>
<p>也是因为这样的刻板印象存在，20世纪70年代后，妇女在化妆品和整容方面的投资大大增加，对自己外貌深感不满的人也越来越多。Michael Kalick在1977年让学生们观看8位女士整形手术前后的照片，结果表明，被试不仅认为女女士们在术后更具吸引力，也认为她们更善良、敏锐、性感热情、更具责任感。</p>
<p>在城市化进程加快的背景下，人和人接触的时间越来越短暂，能给人留下第一印象的外表吸引力就显得愈发重要。在面试中，吸引力和外表修饰影响着第一印象甚至薪水。</p>
<p>之前我们提高过的<em>自我实现的预言</em>在这里也发挥着作用。研究表明，有吸引力的孩子和青年，某种程度他们的确不那么拘谨，更加外向且社交技能更强。从而在正反馈下变得更受欢迎。</p>
<p>长得漂亮没有坏处么？哈特菲尔德等人认为漂亮也会带来不快的性骚扰、同性的嫉妒和排斥，错误归因他人的欣赏。</p>
<p><strong>如何衡量吸引力</strong></p>
<p>讽刺的是，真正的吸引力是完美的平均——由计算机平均出来的平均面孔就很有吸引力。它们也会带来一种熟悉感。</p>
<p>从生物学角度讲，健康、年轻等富有生殖能力的女性特征以及能提供资源、保护能力的男性特征被认为具有吸引力。男性希望女性要有适度的外表吸引力，而女性则希望男性拥有财富和地位，且两性都喜欢有爱心的人和聪明的人。这是进化和文化共同造就的。从深层角度讲，我们的潜意识也被本能影响着。</p>
<p><strong>社会比较</strong>会影响吸引力评估。</p>
<ul>
<li>刚看过描述有吸引力异性作品的被试对比对照组对异性的评价更低</li>
<li><strong>性唤起</strong>会<strong>暂时性</strong>使异性看起来更具吸引力</li>
<li>对比效应在女性上更为明显</li>
<li>情人眼里出西施。我们会认为<strong>我们喜欢的人</strong>以及<strong>和我们相似的人</strong>具有吸引力。人们爱得越强烈，就越不觉得任何其他异性吸引人</li>
</ul>
<h4 id="相似-or-互补"><a href="#相似-or-互补" class="headerlink" title="相似 or 互补"></a>相似 or 互补</h4><p>找一个性格相似的人还是性格互补的人做伴侣？实验显示，</p>
<ul>
<li>丈夫和妻子间相似性越大，他们就越幸福且不容易离婚</li>
<li>某人态度的相似性会引发我们的喜欢。</li>
<li>人们喜欢和他们想法一致和言行一致的人。模仿可以促进和谐。</li>
<li>人们渴望相似伴侣的愿望要远远强于渴望漂亮伴侣的愿望</li>
</ul>
<p>相反，不同态度对喜欢的抑制甚于相似态度对喜欢的促进。态度一致性有助于人们促进和维持亲密关系。在恋人这样的亲密关系外，<strong>思想</strong>上的相似产生的吸引力比肤色的相似性更重要。不过这个世界是具有文化和思想多样性的，我们也需要尊重和欣赏这种差异，求同存异。</p>
<p>人格特质上的互补可以引发吸引么？研究者考察了这个问题，发现在各个方面，<strong>相似性仍然是主导因素</strong>。互补性产生的对比效果可能使一方感受更糟糕，如一个悲观的人和乐天的人在一起。另一方面，我们通常也不会认为那些表现出和我们相反的不好的特征的人是具有吸引力的。</p>
<h4 id="喜欢我们的人"><a href="#喜欢我们的人" class="headerlink" title="喜欢我们的人"></a>喜欢我们的人</h4><p>喜欢通常是相互的（*Really?<em>）。接近性和吸引力可以影响我们最初被谁吸引，相似性会影响长期的吸引。一个人喜欢他人的程度可以反过来预测对方喜欢他的程度（</em>Really?*）告知某些人他们被被人喜欢或仰慕时，他们就会产生一种回报的情感。因为通常来说，<strong>缺点比优点更具影响力</strong>，在我们评价别人和别人反过来评价我们时，<strong>消极消息占比都更多</strong>。</p>
<ul>
<li>坏心情比好心情更能影响我们的思维和记忆</li>
<li>坏事比一件好事更能产生更持久的效应</li>
<li>坏名声比好名声更易获得，且更难摆脱</li>
<li>糟糕的健康状态产生的痛苦远大于舒服产生的快乐</li>
</ul>
<p>奉承通常会使人感觉良好，但我们会认为<strong>批评比表扬更真诚</strong>。在赞美违背了事实后，我们很容易<em>归因</em>到别有用心的动机上。在一项实验中，被试大学生们被要求给出和女&#x2F;男朋友在一起的原因，那些注意力被引到外在原因的人，相对于引到内在原因的人，会表现出对恋人更少的爱恋和结婚可能性。</p>
<p>人们在自尊受到创伤的拒绝后，会表现出反弹行为——对伴侣评价更高，陷入更加激情的恋爱。相反，在获得尊重时，实验发现个体<strong>逐渐</strong>获得尊重，且推翻了目标任务原先的批评时，个体会更喜欢这个目标人物。批评之后的赞美之词才更为可信。频繁的赞扬可能会失去价值。因此，对比“过度赞扬”，<strong>保持坦率而真诚的关系——相互尊重、彼此接纳、保持忠诚——更可以让对方感到满意</strong>。真诚对营造两人间的良好关系很重要。</p>
<h4 id="关系中的回报"><a href="#关系中的回报" class="headerlink" title="关系中的回报"></a>关系中的回报</h4><p>吸引涉及两方——被吸引的一方和吸引他人的一方。“我喜欢XXX，是因为和她在一起感觉如何如何”。可以将这个观点总结为简单的<strong>吸引的回报理论</strong>：<strong>我们喜欢那些回报我们或与我们得到回报相关的人</strong>。推广一点，我们还喜欢和那些能<strong>让我们心情愉悦</strong>的人交往。这种<strong>“联系——喜欢”</strong>在多个实验中都被证实。</p>
<ul>
<li>舒适的环境能激发被试对被评价者的好感</li>
<li>如果你希望维系和伴侣的关系，那么继续把你们的关系和美好事物联系起来很重要</li>
<li><strong>接近性</strong>带来报偿，因为这种友谊付出的时间和精力都较小</li>
<li>我们喜欢<strong>有吸引力</strong>的人，因为他们身上可贵的品质能让我们受益</li>
<li>他人观点和我们<strong>相似</strong>，也会让我们觉得得到了回报。我们尤其喜欢<strong>那些被我们说服的，并开始认同我们观点的人</strong></li>
<li>我们喜欢被人喜欢和被人所爱</li>
</ul>
<h3 id="爱情"><a href="#爱情" class="headerlink" title="爱情"></a>爱情</h3><p>爱情比喜欢更复杂。对爱情的研究首先也要建立界定和衡量的手段。Sternberg认为爱情由激情、亲密和忠诚组成：</p>
<ul>
<li>激情 + 亲密 &#x3D; 浪漫之爱</li>
<li>激情 + 承诺 &#x3D; 游戏之爱</li>
<li>亲密 + 承诺 &#x3D; 友谊之爱</li>
</ul>
<p>激情之爱即热恋状态——强烈渴望和对方在一起的一种状态。研究表明，持续的目光接触、点头和微笑都是激情之爱的标志。哈特菲尔德认为：<strong>任何一种生理唤醒状态最终都可以被归因为某种情绪</strong>。激情之爱就是我们在生理上被有吸引力的人唤醒所感知到的心理体验。这么来看，任何一种可以增加兴奋感的东西都应该可以增强对爱情的感受。沙科特和辛格提出的<strong>情绪两因素理论</strong>认为，当处于兴奋状态的男性对女性做出反应时，他们<strong>很容易把自己的某些生理唤醒错误地归因于这位女性</strong>。一些研究表明，生理唤醒可以促进罗曼蒂克式的反应。</p>
<ul>
<li><strong>观看恐怖电影、乘坐过山车、体育锻炼、饮酒、畅谈等促进生理唤醒的活动都有同样效果</strong>，特别是对那些我们觉得有吸引力的人</li>
<li>夫妻双方共同完成一项可以提高激活水平的活动后，会对其关系的总体情况报告更高的满意度</li>
</ul>
<p>和通常的观念相反，许多研究发现，其实<strong>男人比女人更容易坠入情网</strong>。相比于女性，男性很少技术一段即将迈入婚姻的爱情关系。但是，热恋中的女性也会有和伴侣一样多的感情投入，甚至更多。女性似乎比男性更注重友谊中的亲密感，也会更多关心她们的伴侣。而男性则更多地想到恋爱中的嬉戏以及性的方面。</p>
<h4 id="伴侣之爱"><a href="#伴侣之爱" class="headerlink" title="伴侣之爱"></a>伴侣之爱</h4><p>尽管激情之爱可以热火朝天，但终归还是会平静下来。如果一段亲密的感情经受得住时间的考验，那么它最终就会成为稳固而温馨的爱情，哈特菲尔德称为<strong>伴侣之爱</strong>（companionate love）。伴侣之爱相对平和，是一种深沉的情感依恋。</p>
<p>和吸毒的戒断效应以及抗药性很像，浪漫爱情会有产生之初的高峰和逐渐消退的趋势。曾经很大刺激的用量现在变得效果轻微了，然而一旦停止用药，并不能使你恢复原先状态，而是会引发强烈的戒断反应。那些分手、离异的人会吃惊的发现，虽然早已对另一半失去强烈爱恋，但分开后，生活居然如此空虚。</p>
<p>自由恋爱的夫妻在5年以上，会觉得彼此的“有爱情”的感觉越来越少，相反，那些包办婚姻的夫妇则报告逐渐增长的爱情体验。当然整体上，自由选择伴侣的女性更多地感到快乐。在过去20年陡然增高的离婚率，至少部分源自人们越来越多强调强烈积极的情绪体验在生活中的重要性。这一点在偏向集体主义的文化则并中不明显。热恋中的相互迷恋逐渐减退还有一个重要原因是，夫妇得到了孩子，使他们不能再只关注彼此。在孩子独立离开家庭后，一些失去的浪漫感觉又会重新出现，父母可以重新关注彼此。</p>
<h3 id="促进亲密关系的因素"><a href="#促进亲密关系的因素" class="headerlink" title="促进亲密关系的因素"></a>促进亲密关系的因素</h3><h4 id="依恋"><a href="#依恋" class="headerlink" title="依恋"></a>依恋</h4><p>爱情不仅是一种选择的体验，也是一种生物性驱使。我们的归属需要具有适应性意义，合作促进我们种族的生存和基因的传递。婴儿期对成人的依赖增强了人类间的联系。<strong>与他人的亲密依恋关系构成了一个人生活的核心</strong>，人们都是通过这些亲密依恋关系来获得力量和享受生活的。</p>
<p>所有的依恋都有一些共有因素，双方的理解、提供和接受支持、重视并享受和相爱的人在一起。当然激情之爱还会有些其他特征：身体上的亲昵、排他性的期待以及对爱人的强烈迷恋。依恋在婴儿期还可以再细分为三种大类：</p>
<ul>
<li><strong>安全性依恋</strong>，大约七成以上，在母亲在场时能舒适地玩耍，母亲离开后变得紧张，母亲回来时跑向母亲并继续玩耍。这种婴儿在成人后会更容易接近别人，不会太过依赖或被抛弃而苦恼。这样的恋人也更容易将关系维持在令人满意和持久的状态。</li>
<li><strong>回避型依赖</strong>，大约两成，这类婴儿在和母亲分离或重逢时，虽然有内部的生理唤醒，但极少表现出悲伤。这类婴儿成人后往往会回避亲密关系，并对这种关系表现出较少兴趣，并倾向于摆脱这种关系。他们更易涉及<strong>一夜情</strong>，而较少有爱情。</li>
<li><strong>不安全型依赖</strong>，约一成。在陌生环境下，这类婴儿会充满焦虑地粘在母亲身边。母亲离开后会哭泣。母亲回来后，他们会表现出冷漠和敌意。成年后，焦虑——矛盾型人格使他们对别人不够信任，产生<strong>较强的占有欲和忌妒心</strong>。他们与同一个人的关系会反复出现破裂的情况。</li>
</ul>
<p>这种早期依恋方式也能形成<em>内部工作模式</em>，或关于人与人之间相互关系的独特思考方法。观察发现，敏感、反应型的母亲会让孩子对世界的可靠性形成基本信任感，有利于培养安全型依恋的孩子。</p>
<h4 id="公平"><a href="#公平" class="headerlink" title="公平"></a>公平</h4><p>吸引的公平原则：你和你伴侣从感情中所得应该和你们投入的成正比。处于<em>长期的公正</em>关系的人不在乎短期的公正。对他们来说，这些只是“社交债务”的产生和偿还。<strong>不斤斤计较</strong>是友谊的标志。</p>
<p>对公平的知觉也很重要。处于公平关系的人往往满意度更高，知觉到的不公平可以预测婚姻紧张和对婚姻生活的不满意度。知觉到不公平是一个<strong>正反馈</strong>过程：觉得不公平的一方会更加沮丧和苦恼，从而加剧感受到不公平。</p>
<h4 id="自我表露"><a href="#自我表露" class="headerlink" title="自我表露"></a>自我表露</h4><p>在美满婚姻或亲密友谊中，信任会取代顾虑，使我们更容易展现自己，而不必担心失去友情和爱情。这一特点表现为<strong>自我表露</strong>。</p>
<p>被他人挑选为表露对象通常是很令人高兴的事。相反，如果缺乏发展这种亲密关系的机会，我们就容易感到孤独的痛苦。对于那些我们期望与之有更多交往的人，我们会更多自我表露，且<strong>安全型依恋的人会比其他类型自我表露更多</strong>。而且表露间存在<strong>表露互惠效应</strong>，一个人的自我表露会引发对方的自我表露，我们会对那些敞开胸怀的人表露更多，但是亲密关系的发展也不会立即而来（否则就显得不够谨慎和可靠）。它更像跳舞，我表露一点，你表露一点，一次不要太多，有一个持续的相互回应的过程。亲密关系的增加会创造很强的激情感觉，到亲密关系稳定后，激情就相对较小。</p>
<p>有些人——主要是女性——特别善于使人“敞开心扉”，她们可以轻易地引发他人亲密的自我表露。这类人似乎都是好的倾听者。心理学家Rogers称这种人为“促进成长”的听众，表露自己情感，倾听他人情感。</p>
<p>这样的自我表露有助于我们扔掉面具，表现真实的自己——培植爱情的方式。对他人敞开心扉可以是人们间的交往更加愉快。经常敞开心扉的夫妻或情侣会报告更高的满意度且保持更长久的爱情。两个自我相互联系、相互倾诉、相互认同；两个自我保持个性，又共享很多活动，为彼此的相同之处感到愉悦并相互支持——这就是爱情的精髓。</p>
<h3 id="亲密关系如何结束"><a href="#亲密关系如何结束" class="headerlink" title="亲密关系如何结束"></a>亲密关系如何结束</h3><p>人们将自己不满意的婚姻关系和想象中可从别处获得的支持和情感相比，选择离婚的人越来越多。</p>
<h4 id="离婚"><a href="#离婚" class="headerlink" title="离婚"></a>离婚</h4><p>相对于集体主义中，结婚更意味着承担责任；个人主义者则因为“我们彼此相爱”。个人主义者期待婚姻中有更多激情和个人的自我实现。那些结婚时就已考虑成熟且打算长相厮守的人，确实会有更健康、稳定而长久的婚姻。</p>
<p>符合下面条件的夫妇通常不会离婚：</p>
<ul>
<li>20岁后结婚</li>
<li>都在稳定的双亲家庭里长大</li>
<li>结婚前谈了很长时间恋爱</li>
<li>接受过较好且相似的教育</li>
<li>有稳定收入</li>
<li>居住在小城镇或农场</li>
<li>结婚前没有同居或怀孕过</li>
<li>彼此间有虔诚的承诺</li>
<li>年龄、信仰和受教育水平相似</li>
</ul>
<h4 id="分离过程"><a href="#分离过程" class="headerlink" title="分离过程"></a>分离过程</h4><p>对于深入和长久的依恋关系，离开是一个过程，而不是一个事件。Baumeister &amp; Wotman的报告显示，在数月或数年后，拒绝别人的爱，比被拒绝更能够唤起更多痛苦。痛苦中来自伤害别人的内疚，对心碎恋人的执着的不安，也来自不止如何反应。</p>
<p>在婚姻关系令人痛苦时，有下面4种反应：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>被动的</th>
<th>主动的</th>
</tr>
</thead>
<tbody><tr>
<td>建设性</td>
<td><strong>忠诚</strong>：等待改善</td>
<td><strong>表达</strong>：试图改善关系</td>
</tr>
<tr>
<td>破坏性</td>
<td><strong>忽略</strong>：无视对方</td>
<td><strong>退出</strong>：结束婚姻关系</td>
</tr>
</tbody></table>
<p>健康的婚姻不见得没有冲突，而是夫妻双方能够调和差异。<strong>痛苦和争吵并不能预测离婚</strong>（几乎所有夫妇都经历过冲突）。真正能预测婚姻危机的因素是<strong>冷漠、希望破灭和无助</strong>。</p>
<p>相反，婚姻成功的夫妻有时能从沟通训练中获益，学会避免恶意侮辱，平息怒火，不讲冲突矛头只指向个人。幸福的夫妻间会减少抱怨和责难，增加肯定和赞同，腾出时间表达彼此观点，每天一起祈祷和休闲，并以此改善关系。类似地，持久的凝视等<strong>模仿相爱的行为能够激发爱情</strong>。Sternberg认为，通过扮演和表达爱意，最初的浪漫和激情能够发展成持久的爱情。</p>
<p>在现代生活中，亲密而持久的婚姻关系正在减少。人们需要付出努力才能防止爱情减退。爱情是在内心决定去爱一个人并对其做出长相厮守的承诺；爱情是可以经营的，它需要相爱的人共同去培育。</p>
<h2 id="利他"><a href="#利他" class="headerlink" title="利他"></a>利他</h2><p>利他主义（Altruism）：自私自利的反义词。</p>
<h3 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h3><p>从观察角度和解释层次上，大致分为下面3类：</p>
<table>
<thead>
<tr>
<th>理论</th>
<th>解释层次</th>
<th>外在帮助</th>
<th>内在帮助</th>
</tr>
</thead>
<tbody><tr>
<td><strong>社会交换</strong></td>
<td>心理学</td>
<td>帮助的外在回报</td>
<td>内疚-&gt;帮助的情感补偿</td>
</tr>
<tr>
<td><strong>社会规范</strong></td>
<td>社会学</td>
<td>互惠规范</td>
<td>社会责任规范</td>
</tr>
<tr>
<td><strong>进化理论</strong></td>
<td>生物学</td>
<td>互惠</td>
<td>亲缘选择</td>
</tr>
</tbody></table>
<h4 id="获得回报，避免惩罚"><a href="#获得回报，避免惩罚" class="headerlink" title="获得回报，避免惩罚"></a>获得回报，避免惩罚</h4><p>包括社会交换理论在内的几种理论都认为，帮助行为可以使施与者和接收者共同受益，并产生社会性商品的交换——爱、服务等。</p>
<p><strong>社会交换</strong></p>
<p>帮助行为的有些回报是外部的，比如，商人捐款以获得良好形象，让顺路人搭车已获得赞赏。我们会最热心地帮助对我们<strong>有吸引力</strong>或<strong>渴望得到其赞许</strong>的人。当然，给予对方情感支持，也会让自己产生积极心境。志愿者行为也能有益于成年人的精神状态甚至健康状况。</p>
<p>这种收益分析看起来有些有失身份，难道我们没有“纯粹”的利他行为吗？斯金纳在1971年对帮助行为的分析提到，“只有当我们不能解释别人做好事的原因时，我们才会因此信任他们。只有当我们找不到外在解释时，我们才会把行为归因于他们内在的品质而不是外部原因”。</p>
<p><strong>内部回报</strong></p>
<p>很多时候，帮助行为也会来自内部原因，比如助人者的情绪状态或个人品质。接近一个痛苦的人，我们也会感到痛苦，从而实施帮助也会减轻自己的<strong>痛苦感</strong>。痛苦仅是一个例子，除了痛苦外，<strong>内疚</strong>也是我们想尽量摆脱的消极情绪。实验显示，人们会<strong>尽其所能消除内疚感，减少不良感受，恢复自我形象</strong>。</p>
<ul>
<li>违规行为会引发被试的负罪感，从而倾向于帮助行为，将功补过</li>
<li>说了谎的被试更乐意无偿付出一点时间提供帮助</li>
</ul>
<p>我们在犯错后的行善愿望表明，我们既需要减轻个人的内疚感，也需要<strong>恢复动摇了的积极的自我形象</strong>。即使我们的内疚感是他人所不知的，我们也会用行动来减轻它。除了利他行为外，内疚感还能促使人们坦白、道歉，避免再犯错误，还会使人更敏感，增进亲密关系。</p>
<p>除了内疚感，<strong>消极情绪</strong>也对利他行为有影响，但有趣的是，儿童和成人的影响正好相反：</p>
<ul>
<li>消极情绪减少儿童的帮助行为</li>
<li>消极情绪促进成人的帮助行为</li>
</ul>
<p>Cialdini等人推测，利他行为带来自我满足和内在回报这一认知来自<em>社会化过程</em>，所以在成人身上很明显，而儿童却没有体现，虽然儿童也有共情能力。实验结果和“人生来自私”的观点不谋而合，孩子们随着年龄增长，学会站在他人角度看待问题，帮助行为也随之发展起来。不过，个别消极情绪例外，如<strong>愤怒</strong>或<strong>极度的悲伤</strong>的人会处于强烈的自我关注时期，从而抑制了对他人的付出。只有注意力被引到他人的被试才认为帮助别人特别有意义。</p>
<p>和消极情绪相反，<strong>快乐的人更乐于帮助别人</strong>。这一点不论在儿童还是成人身上都是如此。因为帮助行为能够维持好的心境，同时积极的心境又会产生积极想法和饱满的自尊。快乐的门槛很容易达到，<strong>从害怕到轻松的心境</strong>也很容易引发帮助行为，如被误诊、或误开罚单。不过随着快乐的心境逐渐消逝，助人性也随之降低。</p>
<p><strong>社会规范</strong></p>
<p>这里说的规范即<em>社会期望</em>。人类社会中一个普遍的道德准则是<strong>互惠规范</strong>，即<strong>对于曾帮助我们的人，我们应该予以帮助，而不是伤害</strong>。这种支持性的联系，信任和合作行为保证了团体的正常运作。当人们不能给予回报时，他们可能会因为接受了援助而感到受威胁和被贬低。因此，骄傲、自尊心强的人通常不愿意寻求帮助。</p>
<p>另一条重要的社会规范是<strong>社会责任规范</strong>，即<strong>人们应该帮助那些需要帮助的人</strong>。一些实验表明，即使帮助者不为人知，或不能期待任何回报，他们也会帮助那些需要帮助的人。至于如何鉴别“需要帮助的人”，<strong>归因</strong>很重要。如何一个人穷困潦倒是因为自身原因（懒，不道德），社会规范会让他们自食其果；如果相反是因为环境原因，他们就会得到关怀和帮助。这一规范使人们帮助那些最需要帮助和最应该得到帮助的人。</p>
<p>女性在被知觉为更柔弱和更具依赖性上，会得到男性更多的帮助。而女性对不同性别的求助者则一视同仁。男性会更多地帮助那些<strong>外表有吸引力</strong>的女性，而不是那些外表不具吸引力的人。女性不仅特定场景下能获得更多帮助，她们在身体和精神上也需求更多帮助。</p>
<h4 id="进化心理学"><a href="#进化心理学" class="headerlink" title="进化心理学"></a>进化心理学</h4><p>我们的基因驱使我们采用让其存活能力最大化的生活方式（来自<a target="_blank" rel="noopener" href="https://shenlvmeng.github.io/blog/2018/11/22/selfish-gene/">《自私的基因》</a>观点），<strong>亲缘保护</strong>和互惠就是。<strong>亲缘选择</strong>让我们偏袒那些和自己拥有相同基因的人，我们的子女和亲兄弟间有天然的基因相似性，所以可以说帮助近亲是我们的本性。亲缘保护还决定了种族内的群体偏好，这也是导致诸多冲突的根源。</p>
<p>生命体帮助他人，也是因为它期待着得到回报性的帮助。不作出互惠行为的个体则会被抛弃和排斥。互惠在<strong>小的、与外界隔离的群体中更好地发挥作用</strong>（可能因为相互信赖更强）。因此，互惠行为在偏远乡村比在大城市发生得更多。互惠特征能保持至今有一个进化的原因：群体间竞争时，相互支持、互惠的群体比不互惠的群体能维持更长时间。</p>
<h4 id="真正的利他"><a href="#真正的利他" class="headerlink" title="真正的利他"></a>真正的利他</h4><p>上面我们从内在（避免痛苦）和外在（获得回报或逃脱惩罚）分析了利他的动机，似乎还存在着由<strong>共情</strong>引发的真正的利他行为，即帮助别人的意愿不仅受利己考虑影响，也会来自无私的考虑。<strong>当我们感到和某人有关联时，就会产生共情</strong>。这也是为什么从众中提到个性化的受害者更能引人共鸣。实验发现，共情被唤起的人通常会施与帮助。但是<strong>如果同时知道有别的方式能让我们好受些，我们就不太可能帮助别人</strong>。</p>
<p>巴特森和其同事认为共情导致的利他行为有利有弊，缺点之一是会引起偏爱、不公正的帮助行为，并对广泛的公共利益冷漠。</p>
<h3 id="何时会提供帮助"><a href="#何时会提供帮助" class="headerlink" title="何时会提供帮助"></a>何时会提供帮助</h3><p>在场人数、个人情绪、价值观念、时间紧迫度都会影响帮助行为。</p>
<h4 id="在场人数"><a href="#在场人数" class="headerlink" title="在场人数"></a>在场人数</h4><p>在更多人在场的情况下，受害者较少有机会得到帮助。在旁观者增多时，任何一个旁观者都会更少注意到事件发生，更少把它解释为紧急情况，更少认为自己有采取行动的责任。</p>
<p><strong>注意</strong></p>
<p>在群体人数较多时，群体中的个人会较少注意紧急情况的发生。</p>
<p><strong>解释</strong></p>
<p>如从众一章中所说的“信息影响”，在对环境不够熟悉时，<strong>每个人通常会以他人行为作为现实情况的线索</strong>。另一方面，这种错觉又被<strong>透明错觉</strong>所助长，透明错觉指出我们通常会<strong>高估</strong>他人了解我们内心状态的能力。因为，我们对自己情境的关心会来的更明显，对自身情绪也更敏感，所以会以为他人能很容易发现。在这两种错觉的叠加下，我们往往会忽视或误解需要帮助的线索。</p>
<p>对行为的解释很重要，一个尝试打开车锁的人到底是小偷还是被锁在门外的人，我们对其的解释会影响我们的反应，帮助抑或报警。陌生人之间的暴力也会得到更多的干预行为。</p>
<p><strong>责任归属</strong></p>
<p>人群变大时，帮助情境会变模糊。相反，当紧急情况很清晰时，群体中的人提供帮助的可能性就远小于独处的人。这也在一定程度上解释了，为什么城里人通常比乡村人不愿意帮助别人，在大城市因遇到需要帮助的人太多，会产生“同情疲劳”和“感官超载”。另外，责任扩散也是原因之一，群体中个人感觉到的责任被分散。</p>
<p>在一项实验中，面对面的被试由于有<strong>表情交流</strong>，要比背对背的被试更容易提供帮助。相对相互孤立的群体，相互联系的群体会提供更多帮助。</p>
<h4 id="他人的示范作用"><a href="#他人的示范作用" class="headerlink" title="他人的示范作用"></a>他人的示范作用</h4><p>亲社会的榜样可以促进利他行为。目睹令人感动的善举，常常会引发一种升华的状态：胸腔被温暖和激情膨胀的特殊感，令人们战栗、流泪、喉咙抽紧。孩子不仅听从耳濡的教诲，也从目染的行为中学习道德观。</p>
<h4 id="时间压力"><a href="#时间压力" class="headerlink" title="时间压力"></a>时间压力</h4><p><strong>时间充裕且认为自己的角色无关紧要</strong>的被试会放弃事务停下来提供帮助。</p>
<h4 id="相似性"><a href="#相似性" class="headerlink" title="相似性"></a>相似性</h4><p>上一章提到，相似性引起喜欢，我们也更多地对那些跟我们相似的人产生共情。在实验中，被试对和自己有相似特征的面孔更信任和慷慨。相似性也会引起同种族的偏爱行为，不过，由于很少有人希望明确表现出偏见，所以实验中这种偏爱倾向没那么明显。</p>
<h3 id="谁会提供帮助"><a href="#谁会提供帮助" class="headerlink" title="谁会提供帮助"></a>谁会提供帮助</h3><ul>
<li><strong>人格特征</strong>。具有较积极情绪，较高共情能力和高自我效能感的人更易提供帮助。不过助人性的个体特征没那么明显，需要和<strong>特定情境</strong>结合在一起分析。当受助者是陌生人且情境有危险性时，男性更常伸出援手。而在安全的场景下，如志愿者或花时间的陪伴，女性更乐意一些。尤其是基于亲密关系的关心而不是帮助陌生人。</li>
<li><strong>宗教信仰</strong>。在长期帮助上，如志愿者工作和慈善捐款，宗教信仰有更好的预测性。在各种社会团体中，宗教团体的成员和公民参与的各种形式有最紧密的联系。</li>
</ul>
<h3 id="如何增加帮助行为"><a href="#如何增加帮助行为" class="headerlink" title="如何增加帮助行为"></a>如何增加帮助行为</h3><p>根据上面对帮助行为的分析，可以从个人角度和社会角度去做。</p>
<h4 id="个人角度"><a href="#个人角度" class="headerlink" title="个人角度"></a>个人角度</h4><p>去除对利他行为的抑制。<strong>减少模糊性，提高责任感</strong>。个人化的方式能使人感到不是匿名的，因而有更高的责任感，任何能让旁观者变得凸显个人特征的事情——个人请求、目光接触、告知姓名、会面预期——都增加了帮助的可能性。同时，自我意识更高的人更经常将理想付诸于实践。</p>
<p>另一方面，可以<strong>引起内疚和对自我形象的关心</strong>。<strong>留面子（door-in-the-face）</strong>是利用前者的手段，先提出较过分的请求，在被拒绝后，利用拒绝者的内疚提出想要的请求通常会被满足。比如，研究者先提出一个非常大的请求——承诺为不良儿童做为期两年的无偿咨询，在被全部拒绝后，从侧面切入：“好吧，如果你不愿意，这点小事你愿意帮忙吗？”。Cialdini和Schroeder提供了引发个体关注自我形象的方法：<strong>请求非常微小的帮助</strong>，以至于不好意思被拒绝。因为此时拒绝，通常证明自己的自私。</p>
<h4 id="社会角度"><a href="#社会角度" class="headerlink" title="社会角度"></a>社会角度</h4><ul>
<li><strong>教化道德包容</strong>，避免道德排除，利他主义社会化的第一步就是去除天然的内群体偏爱</li>
<li><strong>树立利他主义榜样</strong>，亲社会的电视榜样所起的所用远大于发社会榜样的作用</li>
<li><strong>归因为利他主义动机</strong>，给予一种行为超过适度的反馈时，个体可能将行为归于奖励这一外在动机。在没有报酬和潜在社会压力时，如果答应帮助别人，会产生最强的无私感。但这不意味着不能有褒奖，意外的褒奖能令人感到胜任和有价值，需避免的是过度的滥用的奖励。助人行动能够促进把自己看作“富有同情心和乐于助人的人”，而这种知觉又反过来促进了进一步的帮助行为</li>
<li><strong>习得的利他主义</strong>，即在了解上面这些会影响帮助行为的因素后，人们就会意识到群体情境对帮助行为的一些抑制作用，从而去避免</li>
</ul>
<h2 id="冲突和和解"><a href="#冲突和和解" class="headerlink" title="冲突和和解"></a>冲突和和解</h2><p>冲突是<strong>被知觉到</strong>的行为或目标的不相容。无论冲突的双方能否正确感知对方的行为，他们总会认为一方的获益就是另一方的损失。但从另一方面来看，冲突体现了<strong>参与、承诺和关心</strong>。在能够被理解和解决的情况下，冲突可以<strong>促进人际关系的变化和发展</strong>。从积极意义上讲，<em>和平</em>是创造性处理冲突得到的结果。</p>
<h3 id="冲突是如何产生的"><a href="#冲突是如何产生的" class="headerlink" title="冲突是如何产生的"></a>冲突是如何产生的</h3><p>冲突来自于多种方面，实际上，不论是人与人的，还是国与国的冲突，其产生原因都是大体相似的。</p>
<h4 id="社会困境"><a href="#社会困境" class="headerlink" title="社会困境"></a>社会困境</h4><p>社会困境即<strong>个人利益和集体利益</strong>相互冲突，在个体追逐自己的私利时，避免不了地损害了集体的或其他团头的利益。<strong>囚徒困境</strong>和<strong>公共地悲剧</strong>就是两个典型案例。</p>
<p><strong>囚徒困境</strong>即，两个囚犯有守口如瓶和指认对方两种选择，对于个人来讲背叛对方总能得到更好的结果，但实际上双方都选择对个体更差的策略时，能获得更大的收益。囚徒困境有一个限制条件： 双方<strong>只做1次决策</strong>，所以没有长远考虑的机会。军备竞赛等囚徒困境的实际案例频繁地发生在现实生活中，无条件地信任他人和采取合作态度反而会让自己陷入被动。</p>
<p><strong>公共地悲剧</strong>即个人对公共资源的过度滥用，比如共同放牧的草原等。在经济学角度讲，一个人对公共资源的使用减少了他人的使用，这种<strong>负外部性</strong>使每个人对公共资源的成本评估较低，从而造成滥用。这也是为什么，<strong>当一种资源未获得明确分配时，人们往往不自觉地消费更多</strong>。</p>
<p>当然也有人，如亚当·斯密认为，从某一方面，由于每个人都试图通过努力使自己利益最大化，这一过程也会使整个社会产值达到最大。</p>
<p>有一些手段可以缓解这种个人利益和集体利益的冲突：</p>
<ul>
<li>设立管理条例</li>
<li>设置税和管理费等，提高人们的评估成本</li>
<li><strong>缩小群体规模</strong>，在一个较小的团体中，人们能更明确地感到自我责任和自己对集体的影响，更容易从集体获得满足感。从而更为节制。因此，也有些政治理论家和社会心理学家建议将公共资源划分为较小的单位。</li>
<li>在小范围内的公共资源，可以采用<strong>沟通</strong>的方式，开放、坦诚而明确的交流可以消除不信任，产生合作行为</li>
<li>在社会范围倡导利他规范，当合作行为可以<strong>明显增进公共福利</strong>时，个人就更可能表现出符合社会规范的行为</li>
</ul>
<h4 id="竞争"><a href="#竞争" class="headerlink" title="竞争"></a>竞争</h4><p>竞争是个人和个人之间极为常见的引发冲突的因素。竞争可以加强知觉到的差异，并<strong>引发更多的攻击行为</strong>。在谢里夫的山贼洞夏令营实验中，分胜负的竞争活动带来了激烈的冲突、对别组成员的歧视、组内强烈的团结意识和集体荣誉感。另外，群体极化又会加剧冲突。</p>
<p>在以下两种情况下，竞争更易于引发冲突：</p>
<ul>
<li>人们知觉到诸如金钱、工作岗位等资源时<strong>有限</strong>，<strong>零和</strong>时</li>
<li>一个明显成为潜在竞争者的外部团体</li>
</ul>
<h4 id="知觉到的不公正"><a href="#知觉到的不公正" class="headerlink" title="知觉到的不公正"></a>知觉到的不公正</h4><p>每个人对于公平的定义都不同，大体上可以分为<strong>根据付出分配</strong>和<strong>根据需要分配</strong>（共产主义）。</p>
<p>在实验中，人们通常不会<em>主动</em>要求对自己或自己所在团体给予优待，但是当他们接受更多好处时，往往会欣然接受，并相信他们获得的就是他们应得的。占了便宜的个人和小组，有的会产生<strong>负罪感</strong>，从而引发道歉或提供补偿，有的则通过贬低他人的付出来缓解自己的罪恶感。对于那些利益受损者，他们或<strong>接受并认同</strong>，或<strong>寻求其他补偿</strong>，或<strong>通过报复</strong>来获得心理平衡。</p>
<p>有意思的是，一个人越是对自我投入评价越高，就越会感到怀才不遇且意图报复。女性更经常视自己和男性平等时，她们的相对剥夺感也越强。</p>
<h4 id="误解"><a href="#误解" class="headerlink" title="误解"></a>误解</h4><p>本章开头介绍冲突概念时，特意强调了“被知觉到”一词。实际上，由于下面一些因素，我们经常有误解的不一致性。</p>
<ul>
<li><strong>自我服务偏见</strong>会高估自己做的好事，却不为自己做的坏事负责任</li>
<li><strong>自我合理化</strong>让人们倾向于否认自己的错误</li>
<li><strong>基本归因偏差</strong>使冲突的双方都把对方的敌意行为归因于他们邪恶的品质</li>
<li><strong>群体思维</strong>会在群体中固化利己、自我合理化和群体偏见，从而形成难以改变的<strong>刻板印象</strong>。</li>
</ul>
<p>在冲突双方的眼里，对方的形象都是被扭曲的：</p>
<ul>
<li>把自己的目标看得最重要</li>
<li>为“我们”感到骄傲，贬低“他们”</li>
<li>坚信自己利益被损害</li>
<li>强调对集体的热爱、团结和忠诚</li>
<li>鼓励自我牺牲，压制批评</li>
</ul>
<p><strong>镜像知觉</strong></p>
<p>在冲突中，扭曲的误解可以达到惊人的一致性，如美苏冷战中双方国民对对方国家的印象。在冲突被双方知觉到时，至少有一方对另一方存在误解，伴随自我证实的预言，双方的敌意程度会在恶性循环中加深。这种负面的<strong>镜像知觉</strong>很多时候会成为通往和平的障碍——冲突的一方认为和自己持相反立场的攻击者的攻击动机显示了他们嗜血的本性，而与自己信仰相同的攻击者则不过是自卫或还击而已。</p>
<p>津巴多指出，冲突会将世界一分为二，即好人和坏人，非黑即白，冲突中对立的双方常常<strong>夸大这种差异</strong>。换位思考可以缓解这种趋势，但绝非易事。激化冲突的另一错误观念是“领导邪恶——民众善良论”，即领导阶级是邪恶的，他们控制和操纵着善良的民众。在台独、港独问题上就能很容易发现这点。</p>
<p><strong>简单化思维</strong></p>
<p>冲突形势越紧张，理智的思考变得困难。对敌人的看法也会变得更简化和刻板，如经验式的判断。在大战爆发、军事冲突、革命前，发起攻击的领导者会表现出愈加简化的思维方式，有个原因是这样更有助于传达给群众，和让群众理解。</p>
<p><strong>知觉转化</strong></p>
<p>误解程度会伴随冲突程度起伏变化。比如国家间的关系也会影响国民对其他国家的认识和观念。</p>
<p>从上面可以发现，在我们能够抛开偏见，并解决实际存在的分歧时才能结束冲突。一个忠告是，<strong>在冲突中不要认为别人和你在价值观和道德上格格不入</strong>，进行换位思考。</p>
<h3 id="获得和平"><a href="#获得和平" class="headerlink" title="获得和平"></a>获得和平</h3><p>上面提到冲突因何而起（社会困境、激烈竞争、知觉到的不公正、误解），解决冲突也有4个建议，简称4C：</p>
<ul>
<li>接触，contact</li>
<li>合作，cooperation</li>
<li>沟通，communication</li>
<li>调和，conciliation</li>
</ul>
<h4 id="接触"><a href="#接触" class="headerlink" title="接触"></a>接触</h4><p>在紧张程度不是很高时，可以通过接触增进相互了解，以期获得和平。</p>
<ul>
<li>接近性和曝光效应使我们更喜欢接触更多的人</li>
<li>“行为验证态度”让我们暗示自己，达到缓和效果</li>
</ul>
<p>以种族隔离为例，种族接触可以减少种族歧视，实验发现，在种族以外，<strong>接触也能够预测偏见的减少</strong>。但是，情况不总是这样，很多国际学生交流项目并不能使学生对居住国产生所预期的积极影响。接触也需要有一些其他限制条件配合才能改善种族态度，如<strong>友谊</strong>和<strong>平等接触</strong>。</p>
<p>和其他群体建立的友谊的人，往往容易对这些群体产生积极的态度，这种情感纽带降低了焦虑。友谊是成功接触的关键。另外，接触需要是平等的，如果接触是竞争性的，或不平等的，那么结果反而会恶化，比如主人和仆人，狱警和囚犯。反例则是同事、同学、邻居等。种族多样化引起的非正式班内互动可以促进致力提高和对差异化的更大程度接受。</p>
<h4 id="合作"><a href="#合作" class="headerlink" title="合作"></a>合作</h4><p><strong>共同的外部威胁</strong>或<strong>超级目标</strong>可以建立起内部团结和合作。</p>
<p>民族间的冲突会提高民族自尊心，在战争时期面对一个明确的外部威胁时，我们的群体归属感会极度高涨，小布什在911时期的民众支持率从51%飙升到90%。因为这一点，甚至有时候，领导人会<strong>刻意创造出一个假想敌来提高民族凝聚力</strong>，奥威尔《1984》里的老大哥就是这么做的。在现实生活中，一个共同的强大的敌人也是一种强大的凝聚力量，《三体》中三体星人的入侵就带来了全人类的空前凝聚。</p>
<p>另一种凝聚力量是<strong>超级目标</strong>，即集中力量办大事。谢里夫实验中，最后通过修复水管、解决骑车抛锚等问题，又降低了团员们的敌意，使他们变回了朋友。成年人和谢里夫实验中的小男孩是一样的。一起工作对分解小团体，建立一个更大的更具包容性的团体很有用。当然，合作需要是<strong>成功的</strong>，失败的合作反而会恶化冲突。</p>
<p>由于人们天然的社会性，我们的自我概念中除了我是谁，还包括我们的社会同一性，即我们是谁，能强化自我概念和自豪感，我们“是谁”也暗示了我们“不是谁”。<strong>内群体偏见</strong>有时会造成冲突，并在群体极化下演变成暴力行为，比如球迷间的斗殴。伴随成功，人们的群体认同也会高涨，电竞战队获胜会为它带来更多粉丝。为了促进“内群体一致性”，很多学校都强制要求身着校服，消除小群体竞争，增进合作。</p>
<p>除了上面两例，<strong>合作性学习</strong>也能够改善个体间关系，减少冲突，改善种族态度。相对于传统的、充满竞争的学校里学习的学生，在学习参加混合民族学习小组的学生，有更好的种族态度。合作性学习有助于建立更亲密接触，产生户主和支持的关系。“拼图”式学习即把学生分为小组，拆分任务为小部分，组内每个学生各自承担一部分，自行学习后将学习成果教授给其他成员，共同完成对学习材料的学习。其中每个小组成员都会感受到自己的必要性，这种相互帮助的气氛也使成员对同伴更加喜爱。</p>
<p>上面提到的共同敌人、超级目标和合作性学习总结起来就是，<strong>为实现一个目标而进行平等的接触</strong>。</p>
<p>我们每天都在处理各种各样的社会身份，我们的自豪感需要我们用户更广泛群体、民族的身份认同。在种族多元化的文化中，尤其是历史并不悠久的国家中，种族身份和国家身份同时存在，人们需要平衡它们之间的关系。有时需要通过提出一致的理想来推广公民身份的认同，如美国的“合众为一”。</p>
<h4 id="沟通"><a href="#沟通" class="headerlink" title="沟通"></a>沟通</h4><p>沟通也可以分为几种形式：<strong>谈判</strong>，<strong>调解</strong>，<strong>仲裁</strong>。</p>
<p>谈判并不总能达到双赢的结果，有时迟到的协议会造成双输的后果</p>
<p>第三方调解人可以让冲突双方做出让步并挽回面子。调解人需要让他们暂时放弃冲突中的自身需求，把非输既赢变成“双赢”。克制的沟通可以减少自我证实的误解，有时<strong>建设性地解决冲突比保持沉默能带来更多和谐</strong>。</p>
<p>那么如何界定建设性的争吵呢：</p>
<ul>
<li>不要过早道歉</li>
<li>不要保持沉默，或逃离现场</li>
<li>不要引入无关话题</li>
<li>不要人身攻击</li>
<li>不要假装同意</li>
<li>要私下争吵，避开他人</li>
<li>要清晰界定问题</li>
<li>要接受对自己的反馈</li>
<li>澄清自己的态度，直面问题</li>
<li>提问以引导对方表达其观点</li>
<li>等待对方平静下来</li>
<li>提出双方都满意的建议</li>
</ul>
<p>冲突达到建设性结果，一定程度建立在<em>信任</em>的基础上。双方互不信任时，就需要第三方调解的介入。调解人需要建立一种情境，帮助双方理解对方，并感到被对方理解。中立的第三方还可以提出双方都接受的建议。</p>
<p>如果冲突连调解都无法解决，就需要<em>仲裁</em>来给出一个确定方案，大多数的争论者都会陷入过度乐观，即相信仲裁结果对自己有利。</p>
<h4 id="和解"><a href="#和解" class="headerlink" title="和解"></a>和解</h4><p>和解是双方面的，单方的妥协让步是行不通的。Charles Osgood提出了GRIT方案：逐步（Graduat），互惠（reciprocat），主动（initiative）地减少紧张（tension reduction）。GRIT要求一方在宣布希望调和的愿望时，做出一些小的意在降低冲突的行为。和解行动并不需要发起者在某一领域做出大的牺牲，但是要保持“坚定、公平、友善”。在实验室里进行的长期的两难实验中，“投桃报李”策略被证明是成功的（《自私的基因》中也有提到）。</p>
<p>和解行动可以使双方从紧张的台阶下来，使接触、合作、沟通重新变得可能。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://shenlvmeng.github.com/blog/2019/09/16/tour-to-lijiang-and-dali/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="shenlvmeng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shenlvmeng's Blog">
      <meta itemprop="description" content="Be sharp, my friend.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Shenlvmeng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/09/16/tour-to-lijiang-and-dali/" class="post-title-link" itemprop="url">丽江、大理之行 —— 彩云之南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-16 20:30:42" itemprop="dateCreated datePublished" datetime="2019-09-16T20:30:42+08:00">2019-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-09-24 00:45:58" itemprop="dateModified" datetime="2019-09-24T00:45:58+08:00">2019-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%B8%B8%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">游记</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2019/09/16/tour-to-lijiang-and-dali/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/09/16/tour-to-lijiang-and-dali/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>流水账向，记念总是充满未知和惊喜的旅程。</p>
</blockquote>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>计划旅行总是件头疼的事情，尤其是没有人可以帮你分担的时候。因为时间限制排除了青海湖骑行和西南游行后，最终目的地确定为某凯10年前去过的丽江。另一方面，某凯领导身先士卒地因加班倒下，这次中秋佳节某凯得以顺利加入我的出游计划，可喜可贺。</p>
<h2 id="Day-1-出发"><a href="#Day-1-出发" class="headerlink" title="Day 1: 出发"></a>Day 1: 出发</h2><blockquote>
<p>丽江的天气预报都是骗人的</p>
</blockquote>
<p><strong>路线：北京T2航站楼 -&gt; 昆明三义机场 -&gt; 昆明站 -&gt; 丽江站 -&gt; 大研古城</strong></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtrLt.jpg" alt="起床.jpg"></p>
<p>由于北京往返云南的航班实在有限，来回的旅途不甚方便。为了赶早上8:50去昆明的飞机，我又回到了当初学科目二的起床时间5:20。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtHoT.jpg" alt="昆明机场.jpg"></p>
<p>幸运地是，飞机没有延误，让我顺利地在14:30前从昆明机场赶到了昆明站，甚至还抽出了半个小时去了个德克士。</p>
<p>动车开至大理时，天气便阴沉起来，山区里的雾从视野边缘沿着山势蔓延而下。在山区中穿行的火车从远处看一定甚为壮观。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtArq.jpg" alt="火车外.jpg"></p>
<p>丽江站位于市郊边缘（比机场好点），虽然公交仅需1元，但是苦于没有零钱，只能打滴滴到大研古城。到附近的九洲饭店时，几乎和下午3点出发的某凯同时到达。对于普通游客来说，住宿上有两个选择：<strong>大研古城</strong>和<strong>束河古城</strong>。个人比较推荐大研，位于城区内，交通食宿方便。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtuiF.jpg" alt="客栈.jpg"></p>
<p>来云南怎能不尝下<strong>野生菌火锅</strong>，还未煮熟，鲜味就伴着蒸汽飘了出来。店家特意叮嘱煮沸后5分钟再吃，应该也是怕我们中招。另外，这家店的酥肉一点不输北方。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtQz9.jpg" alt="野生菌火锅.jpg"></p>
<p>丽江和大理气候很湿润，四季如春，夏天最热30度出头，冬天最冷也在10度以上，但是昼夜的温差较大，早晚要注意保暖。着装上，长袖长裤正常春秋装即可。丽江下雨没个准儿，天气预报可信度不高，建议随身带伞。来丽江前，一周都是雨的天气预报还是挺让人绝望的。幸运的是，最终几天里只有第一天晚上下了雨。</p>
<h2 id="Day-2-雪山"><a href="#Day-2-雪山" class="headerlink" title="Day 2: 雪山"></a>Day 2: 雪山</h2><blockquote>
<p>吸氧？不存在的。</p>
</blockquote>
<p><strong>路线：甘海子 -&gt; 蓝月谷、白水河 -&gt; 冰川公园 -&gt; 登顶 -&gt; 大研古城</strong></p>
<p><strong>玉龙雪山</strong>和周边的景点很值得一逛。不过有几点对于第一次来这里的游客不大友好：</p>
<ul>
<li>线上购票入口不透明，可以在<strong>丽江旅游集团</strong>公众号上购买，大索道票价140元，购买时需要选择时段，每天有限额，卖完即止。强烈建议提前购买。除了索道外，进入景区还要另收取80元门票，可以在<strong>游云南</strong>微信公众号上购买，入园时要出示购票二维码。</li>
<li>需要准备防寒服和氧气瓶。丽江城区海拔2500m，雪山园内海拔3000m+，索道顶海拔4500m。体质较弱的人可能会有高原反应，更何况在索道顶上还有数千级台阶爬到4680m的最高点（并不是山顶）。另外山顶阴晴不定，气温在10度以下，需要防寒防雨服。但是防寒服和氧气瓶的租用收费也不大透明，古城里和山脚下都有租的地方，价格不一。</li>
<li>园内景点相距很远，雪山索道、蓝月谷、云杉坪、牦牛坪之间必须坐摆渡车来往。坐车的地点指引不明显，没有人带很容易懵逼。</li>
</ul>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt3s1.jpg" alt="山.jpg"></p>
<p>个人很推荐报一日游的小团前往，网上搜到的都是纯玩团，6-7人成团，价格从200+到300+不等。司机会帮你完成上面不透明的订票、防寒服&#x2F;氧气租用、景点接驳指引等环节。甚至还包含午餐（但是要注意午餐时当地人推荐的当地特色，比古城里卖的贵很多）。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtILq.jpg" alt="蓝月谷1.jpg"></p>
<p>一般的路线会先路过<strong>甘海子</strong>。甘海子是一片高原草甸，平时没有起雾时能看到牦牛吃草。由于我们上午出发时，有个团员迷路，到达园内的时间稍晚。安排上就先去了<strong>蓝月谷</strong>、白水河。蓝月谷是雪山下的一条自然河流，水的蓝色来源于里面的铜离子。配合山景颇有感觉。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtkMn.jpg" alt="蓝月谷2.jpg"></p>
<p>吃完饭，下午开始爬山，爬玉龙雪山必须要坐<strong>大索道</strong>才能到达<strong>冰川公园</strong>，索道起点3306m，海拔在4500m，10分钟的时间爬升近1000m。整个爬升过程可见到山上植被从松柏到草甸再到山岩再到冰川的过渡，手里的相机根本停不下来。山间阴晴不定，有时恍如置身仙境，不知被云还是雾包裹，对面索道上的缆车也仿佛穿梭云间。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtZZV.jpg" alt="索道缆车.jpg"></p>
<p>索道顶便是登山步道起点，登山步道到最高处爬升100m，到4680m处，出于保护目的，无法到山顶。栈道两旁遍是风化的山岩，稍往上走，就能看见宏伟的冰川，瞬间就明白“玉龙”二字的由来。由于是淡季，栈道上的人并不多，都身着防寒服，边吸氧边向上爬。说到吸氧，个人体验青壮年男性1瓶即可，我和某凯1人1瓶下山后还吸了几天都没吸完……</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt7wV.jpg" alt="雪山1.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt5yn.jpg" alt="雪山2.jpg"></p>
<p>不过一会儿，山上雨势便大。我们几人乘索道返回甘海子坐上返回古城的面包车，由于疲惫，一行几乎无言。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFNCTK.jpg" alt="一个酒店.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtdRH.jpg" alt="古城2.jpg"></p>
<p>我们订的民宿位置精妙，位于狮子山半山腰，下午回来后就顺带逛了下古城。大研古城属于开发得比较彻底的，城区里面商业气息很是浓厚。不过配合着狮子山的地形以及玉河的水势，复古又现代的石巷还是颇有特点。许是我一时喜欢喧闹，天色渐晚，灯火通明人声熙攘又让古城的商业化没那么可憎。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt8qx.jpg" alt="古城1.jpg"></p>
<p>晚饭吃的是土鸡米线 + 鸡蛋牛奶醪糟，座位就在河边，不时有凉风拂过，不失为一种惊喜。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFNpex.jpg" alt="醪糟.jpg"></p>
<h2 id="Day-3-古城"><a href="#Day-3-古城" class="headerlink" title="Day 3: 古城"></a>Day 3: 古城</h2><blockquote>
<p>吃一堑长一智</p>
</blockquote>
<p><strong>路线：大研古城 -&gt; 黑龙潭公园 -&gt; 束河古镇 -&gt; 酒吧</strong></p>
<p>原定计划是去<strong>虎跳峡</strong>，虎跳峡是长江的一小段，分三部分：上虎跳、中虎跳、下虎跳。其中上虎跳开发比较完善，有两个成规模景区，分别位于江的两岸，由丽江和香格里拉开发。其中丽江侧游客较少，体验稍好。中虎跳、下虎跳适合徒步多日玩耍体验。逼逼叨叨这么多，最终得知，最近（9月13日）赶上雨季，危险系数太高，景区不开门，计划成功泡汤。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtxyR.jpg" alt="狮子山1.jpg"></p>
<p>腾出的一天，领略了白天的大研古城和稍显青涩的束河古镇。古城内的大型景点并不多，<strong>狮子山</strong>和<strong>木府</strong>算是两个。前者门票35，后者门票40，不算太贵。狮子山是木府的后山，是丽江城区内的制高点，在万古楼顶楼可以纵览古城新城的任何角落，以及边缘的群山，甚是过瘾。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFttIO.jpg" alt="狮子山2.jpg"></p>
<p>木府是明清时期丽江地区统治阶级木氏土司政府所在地，也是《鹿鼎记》的故事发生地。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtJZ6.jpg" alt="木府万卷楼.jpg"></p>
<p>白天的古城撇去游客，但看小巷、流水、房檐，在配上肉眼可见的流云，还是另有感觉。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtco8.jpg" alt="大研古城1.jpg"></p>
<p>随便拍上一张，若是好好PS一番，就是一副大片。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt1MR.jpg" alt="灯笼.jpg"></p>
<h3 id="番外篇：狗"><a href="#番外篇：狗" class="headerlink" title="番外篇：狗"></a>番外篇：狗</h3><p>古城里的狗，大多以最舒服的姿势趴在地上，对外物无甚兴趣。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFNiFO.jpg" alt="狗1.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtBQA.jpg" alt="狗2.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtwzd.jpg" alt="狗3.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtOW4.jpg" alt="狗4.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFteaT.jpg" alt="狗5.jpg"></p>
<p>在去午饭的路上品尝了6.6元的奶茶，茶味很浓，蛮有特色。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtqFU.jpg" alt="奶茶.jpg"></p>
<p>随后沿着玉河水系上溯，景区外的玉河两岸更是安静祥和。午餐品尝了<strong>黑山羊</strong>火锅，顺便见识了粑粑和纳西族月饼（疑似）。两人面对大众点评优惠三人餐，毫无疑问地败下阵来。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtixs.jpg" alt="纳西族月饼.jpg"></p>
<p>饭后就便逛了<strong>黑龙潭公园</strong>，公园是市民公园的性质，有山有水，可以来抱着放松身心的心态来逛逛，后山属于健身路线，较少有游客涉足，且要登记身份避免走失。本身不收门票，但需要检查古城维护费收据，1人50元，如果之前在其他景点交过，展示证明即可。如果从公园北侧小口进入，则没有人查验（我们从北门出去后路过才发现……）。有意思的是，在公园最北端有个小湖，颜色和蓝月谷的别无二致。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt6df.jpg" alt="黑龙潭公园.jpg"></p>
<h3 id="番外篇：谜之健身器材"><a href="#番外篇：谜之健身器材" class="headerlink" title="番外篇：谜之健身器材"></a>番外篇：谜之健身器材</h3><p>园内有一处年久失修的健身器材，很是抽象。光看造型，完全无法联想其使用方式。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtMRJ.jpg" alt="器材1.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFN9w6.jpg" alt="器材2.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtYdK.jpg" alt="器材3.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtvl9.jpg" alt="器材4.jpg"></p>
<p><strong>束河古镇</strong>较远，需要打车前往。一般在南门落客。一天内<strong>特定时间段</strong>（游客较多的时段）需要买门票。在吸取了狮子山和黑龙潭的教训后，我们发现有些门票是可以<em>合理避过</em>的。从南大门右边的小路和左边停车场、派出所进入古镇不检查门票。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFNFYD.jpg" alt="风铃.jpg"></p>
<p>和大方华丽的姐姐大研相比，束河像是还不经世事的妹妹，刚学会化妆，便往脸上一顿浓妆艳抹。束河古镇里的路较宽，拐弯都比较规规矩矩，水流除了西边一条河外，镇里的河略窄。也许是位置较偏的缘故，游客比较少。除了<strong>四方听音</strong>和<strong>飞花触水</strong>等几个小广场外，较少有游客聚集。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtKG4.jpg" alt="四方听音.jpg"></p>
<p>北侧的<strong>九鼎龙潭</strong>和<strong>放生桥</strong>处的水极清澈，令人想捧起一抔洗把脸。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtDsI.jpg" alt="九鼎龙潭.jpg"></p>
<p>对比之下，南边<strong>哈里谷</strong>区域却一片荒芜，店门紧缩，院内一片荒草，原本酒吧街内的河流或干涸或绿得浑浊。除了一些拍婚纱照的新人和玩耍的本地小孩外，甚至连游客都没有。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtzO1.jpg" alt="哈里谷1.jpg"></p>
<p>不敢想象，夜幕降临后这里会是什么样。曾经，这里繁华的时候，若都是酒吧，人流来往，处处欢歌，还有流水桥廊还有楼上路上买醉的人，应该是很美妙了。只可惜如今蚊蝇滋生，死寂一片。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtUiD.jpg" alt="哈里谷2.jpg"></p>
<p>古镇里卖银、买玉的手艺人很多，工匠街一带更多，可能是淡季外加游客有限，才下午五点街上就没了人烟。</p>
<p>百度地图误我，又逛了鸡肋都比不上的景点后，我们打车回到了大研。</p>
<p>丽江古城里的清吧染上景区的风格，都浮夸无比。似乎没个驻唱就无法开店（虽然事实很可能是这样）。甚至有的酒吧没有鸡尾酒的选择，啤酒配上这种氛围，我怎么想怎么感觉怪怪的。好歹也是农历八月十五，我们在大众点评上找了一个看似靠谱的酒吧就杀了过去。</p>
<p>物价虚高，没有零食，花生24元一碟，不续，诚意稍显不足。有驻唱算是有点氛围上的弥补（私心觉得如果是jazz、民谣风格的就更妙），要求不能太高。只可惜，这里喝啤酒和看风景的客更多，歌手几次互动，响应者寥寥。真是不解风情。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtjSJ.jpg" alt="酒.jpg"></p>
<p>穿插着各种交流感情，几杯下去，微醺。挺好。</p>
<h2 id="Day-4-拉市海"><a href="#Day-4-拉市海" class="headerlink" title="Day 4: 拉市海"></a>Day 4: 拉市海</h2><p><strong>路线：拉市海 -&gt; 邮局 -&gt; 网吧</strong></p>
<p>由于假期有限，规划在丽江的3天半里就没有计划<strong>泸沽湖</strong>，第4天就去了相对较近的<strong>拉市海</strong>，拉市海湿地近年已不让在湖里划船，湖边的相关设计占比就多了起来。去拉市海的公交一样比较麻烦，所以我们还是报了半日游的团。行程较为简单：骑马 + 吃饭 + 湖边拍照。</p>
<p>只可惜骑马的造型不大雅观，只敢自己珍藏。路上牵马的纳西族马夫倒是挺有意思。他看上去60出头，格外健谈，也许是和游客呆多了，俏皮话和段子也是一个接一个。侃天之余还说起之前在藏区的当兵经历，感慨国家进步之快和维尼的英明，疯狂吐槽影帝时期种种不满。中间还教了了我们几个纳西族的短语。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt4Qs.jpg" alt="自拍.jpg"></p>
<p>大研附近的邮局有限，古城内的邮局在深处，民主路上的一个较容易找到，下午寄完明信片方才3点。等好不容易拿了首胜从网吧走出时，已晚上八点半。晚上的烤小瓜（西葫芦）是个惊喜。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFNwkT.jpg" alt="小瓜.jpg"></p>
<h2 id="Day-5-大理"><a href="#Day-5-大理" class="headerlink" title="Day 5: 大理"></a>Day 5: 大理</h2><blockquote>
<p>云原来也能这么好看</p>
</blockquote>
<p><strong>路线：洱海公园 -&gt; 海心亭 -&gt; 奥林匹克广场</strong></p>
<p>囿于穷，回北京得在大理转机，幸得大理一日走马观花。在大理火车站附近顺便点了一些特色菜：<strong>饵丝</strong>、<strong>大救驾</strong>、<strong>水性杨花</strong>。后两个店家没有了，不过饵丝是用大米做的和米线口感较像的面食，不过更细。大救驾貌似是腾冲名小吃，用饵块做的。“水性杨花”则是丽江的一种水生植物。别的不说，饵丝看上去还挺不错，对我口味。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFNa7V.jpg" alt="饵丝.jpg"></p>
<p>明珠广场顶上可以看到洱海南面的大片城区，不过被洱海公园的山挡着看不到洱海。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFt2FS.jpg" alt="明珠广场.jpg"></p>
<p><strong>洱海公园</strong>是免门票的市民公园，园内的小型动物园虽比较鸡肋，但猴山却格外有意思，整个后山面积很大，里面猴子、猫、飞鸟和谐相处，蛮有趣味。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtmIU.jpg" alt="猴山.jpg"></p>
<p>临到山茶园，远处的苍山有乌云越过山脊向下蔓延，山和云形成的层次感甚为壮观。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtLYF.jpg" alt="苍山.jpg"></p>
<p>在山茶园的风花雪月亭向下望，渔家女雕像后的洱海一览无余，只教人心情舒畅。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtEq0.jpg" alt="风花雪月亭.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtTe0.jpg" alt="渔家女雕像.jpg"></p>
<p>雕像所在的广场上，可以坐在海边尽情享受湖光山景，气温不高不低，常有微风左右相伴，真是片伊甸园般的景象。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtP2j.jpg" alt="洱海1.jpg"></p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtRJg.jpg" alt="洱海2.jpg"></p>
<p>时间还多，我们一直跨过洱河走到了蝴蝶形状的奥林匹克广场方才兴尽而止。有时间，真应该上苍山、大理古城里去看看。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtfzj.jpg" alt="奥林匹克广场.jpg"></p>
<h2 id="Day-6-END"><a href="#Day-6-END" class="headerlink" title="Day 6: END"></a>Day 6: END</h2><p>每一次旅行都是一种经历，感受异地的生活节奏、自然风光和人文风情。这次的行程虽然稍显短促，但也带着满满的伴手礼和记忆踏上归途。同时，还解决了2个困扰我数月的难题。</p>
<p>飞机上，云层之下的洱海显得更为壮观。</p>
<p><img src="https://s2.ax1x.com/2019/09/23/uFtyeP.jpg" alt="飞机上的洱海.jpg"></p>
<p><em>–END–</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://shenlvmeng.github.com/blog/2019/09/10/php-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpg">
      <meta itemprop="name" content="shenlvmeng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shenlvmeng's Blog">
      <meta itemprop="description" content="Be sharp, my friend.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Shenlvmeng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2019/09/10/php-note/" class="post-title-link" itemprop="url">（旧文）PHP语言介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-09-10 21:02:17 / 修改时间：21:04:17" itemprop="dateCreated datePublished" datetime="2019-09-10T21:02:17+08:00">2019-09-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2019/09/10/php-note/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/09/10/php-note/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>38k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:03</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p><a target="_blank" rel="noopener" href="//php.net">php.net</a></p>
</blockquote>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>PHP来源于工程PHP&#x2F;FI，由Rasmus Lerdorf创建于1995年，起初只是一套简单的Perl脚本，名字叫做“Personal Home Page Tools”，语法也和Perl很像，随着用户的增加，改进为用C语言实现。1997年，Andi Gutmans 和 Zeev Suraski 重写了代码，推出第三版，PHP&#x2F;FI也演变成PHP（PHP: Hypertext Preprocessor）。注意，这是一个递归的缩写。</p>
<p>1999年，由两人改进的更具模块化的“Zend Engine”引入PHP，在结合了许多新功能后，2000年5月发布官方版PHP 4.0。如今广泛使用的5.x版本从2004年起发布。5.x版本支持完整的面向对象模型。目前的最新版本已经到了7.x版本（直接从稳定的5.6版跃迁）。</p>
<p>由于丰富的PHP主要用于服务端的脚本程序，就像其他的CGI程序，如收集表单，生成网页，发送&#x2F;接收Cookie等。除此以外，PHP还用于命令行脚本，编写桌面应用程序。这两种开发可能会用到PHP的拓展库。由于解析器的存在，PHP的跨平台能力很好。 </p>
<p>关于php的绝大多数内容都可以在<a target="_blank" rel="noopener" href="//php.net">php.net</a>上找到，上面介绍的历史也是如此。本文的绝大多数内容更是如此。</p>
<h2 id="安装和配置"><a href="#安装和配置" class="headerlink" title="安装和配置"></a>安装和配置</h2><p>在通常情况下，php用于服务器端脚本，安装配置较之Javascript复杂很多。在Unix环境下，假设服务器环境（如Apache, Nginx等）已经安装完毕，可以通过configure脚本安装配置。Windows环境下，通过MSI文件安装配置PHP和所有内置以及PECL拓展库。此外Mac OS X，云平台等安装各有不同，详见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/install.php">官方教程</a>。</p>
<p>配置文件（<code>php.ini</code>）在PHP启动时被读取，作为服务器模块版本的PHP，仅在服务器启动时读取1次，作为CGI和CLI版本，每次调用都会读取。用户亦可自定义自己的<code>user.ini</code>文件。PHP的有些指令可以在PHP脚本中用<code>ini_set()</code>设定，有些只能在<code>php.ini</code>或<code>httpd.conf</code>中设定。这些是由指令的模式决定的，模式有4种：<code>PHP_INI_USER</code>, <code>PHP_INI_PERDIR</code>, <code>PHP_INI_SYSTEM</code>, <code>PHP_INI_ALL</code>。具体见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/configuration.changes.modes.php">文档</a>。</p>
<p>PHP作为Apache模块运行时，还可以用<code>php_value</code>, <code>php_flag</code>, <code>php_admin_value</code>, <code>php_admin_flag</code>命令设置。</p>
<h2 id="第一段代码"><a href="#第一段代码" class="headerlink" title="第一段代码"></a>第一段代码</h2><p>与C等语言通过代码输出HTML不同的是，PHP页面本身就是HTML，你也完全可以像通常建立HTML页面那样创建和编辑PHP页面，只不过其中嵌入了<code>&lt;?php</code>和<code>?&gt;</code>包裹的PHP代码。与Javascript不同的是，PHP运行在服务端，用户无从得知脚本是如何运行的。</p>
<p>值得一提的是，除了上述的开始和结束标记，使用<code>&lt;script language =&quot;php&quot;&gt;&lt;/script&gt;</code>或者asp风格的短标记<code>&lt;?=</code>, <code>&lt;%=</code>也行（<em>不建议</em>）。在这一对标记之外的内容都会被PHP解析器忽略。可以在脚本中通过<code>phpinfo()</code>打印php的整体配置信息。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在html语句中嵌入php语句时，尽量做到将业务逻辑和展示语句隔离开对维护php工程有着极大的好处。</p>
<h2 id="特性参考"><a href="#特性参考" class="headerlink" title="特性参考"></a>特性参考</h2><h3 id="PHP标识"><a href="#PHP标识" class="headerlink" title="PHP标识"></a>PHP标识</h3><p>如上文中提到，PHP通过<code>&lt;?php</code>和<code>?&gt;</code>分隔php脚本，在<code>php.ini</code>激活<code>short_open_tag</code>配置后，支持使用短标记作为分隔符。<strong>如果文件内容为纯PHP代码，最好在文末删除结束标记，以免打印意料之外的空白</strong>。如下示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line"><span class="comment">// ... more code</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Last statement&quot;</span>;</span><br><span class="line"><span class="comment">// stop here</span></span><br></pre></td></tr></table></figure>

<p>PHP使用<strong>分号</strong>作为分隔符，支持C，C++，Perl风格的注释。即<code>//</code>，<code>/**/</code>和<code>#</code>。</p>
<h3 id="类型-amp-类型转换"><a href="#类型-amp-类型转换" class="headerlink" title="类型 &amp; 类型转换"></a>类型 &amp; 类型转换</h3><p>PHP的原始数据类型有<strong>boolean，integer，float，string，array，object，resource，NULL</strong>。其中前4种为标量，第5，6中为复合类型。resouce表示资源，<strong>NULL表示无类型</strong>。PHP中<strong>float也称为double</strong>。在确保代码易读性上，还有mixed，number和callback几种伪类型。需要注意的是，PHP和Javascript一样，类型往往根据上下文确定。</p>
<h4 id="boolean"><a href="#boolean" class="headerlink" title="boolean"></a>boolean</h4><p>和JavaScript类似。</p>
<p>只有TRUE或FALSE，除了false以外，还有下列假值：</p>
<ul>
<li>0</li>
<li>0.0</li>
<li>‘’</li>
<li>“0”</li>
<li>[],</li>
<li>{}（仅4.0）</li>
<li>NULL</li>
</ul>
<p>其余均为真值（包含任何resource）。和Javascript类似，支持&#x3D;&#x3D;&#x3D;全等。</p>
<h4 id="integer"><a href="#integer" class="headerlink" title="integer"></a>integer</h4><p>有十进制，十六进制，八进制，二进制表示。除十进制外，分别以<code>0</code>, <code>0x</code>, <code>0b</code>开头。5.0.5后最大值可以用常量<code>PHP_INT_MAX</code>设置。<strong>整数溢出时会被解释为float</strong>。<strong>注意：八进制中传递非法数字后，后面数字会被忽略</strong>。类型转换时，可以使用<code>intval()</code>。在浮点数过大，分数强制转换和其他类型转换时，结果未定义。</p>
<h4 id="float"><a href="#float" class="headerlink" title="float"></a>float</h4><p>又称为double和real，支持科学记数法。运算时精度有限，高精度要求下参考任意精度数学函数和gmp函数。在比较大小时需要谨慎，可以采用相减之差和最大容忍度比较的方法作折衷。常量<code>NAN</code>表示浮点计算中不可描述的值，为float类型，不等于任何其他变量，甚至自身。可以用<code>is_nan()</code>检查。</p>
<h4 id="string"><a href="#string" class="headerlink" title="string"></a>string</h4><p>和JavaScript区别较大。</p>
<ul>
<li>PHP字符串的字符占1个字节，因此不支持Unicode。字符串最长可达2GB</li>
<li>表示字符串有4种方法，<strong>单引号，双引号，heredoc和nowdoc</strong>。<ul>
<li>单引号下，只转义单引号和反斜线，其余字符均为plain text，支持多行；</li>
<li>双引号下，对换行回车制表符等特殊字符进行转义，还会对变量解析（$xxx）的形式（和Javascript相似）。</li>
<li>Heredoc结构里，在&lt;&lt;&lt;符号后提供一个标识符然后换行，接下来是字符串本身，字符串后另起一行用前面定义的标识符作为结束标志。中间内容的处理方式同双引号。</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&lt;&lt;&lt;EOD</span></span><br><span class="line"><span class="string">Example of string</span></span><br><span class="line"><span class="string">spanning multiple lines</span></span><br><span class="line"><span class="string">using heredoc syntax.</span></span><br><span class="line"><span class="string">EOD</span>;</span><br></pre></td></tr></table></figure>

<p>5.3.0以后，可以使用heredoc结构初始化静态变量和类的属性以及常量。nowdoc结构类似于单引号版的heredoc，但是跟在<code>&lt;&lt;&lt;</code>之后的标识符要用单引号括起来，多用在不解析特殊字符的大段文本中。在双引号或heredoc结构中，变量会被解析，简单语法下，PHP解析器会去组合尽量多的标识形成一个合法的<strong>变量名</strong>。复杂语法下，<code>$</code>符号的<strong>外侧或里侧</strong>会紧贴<code>&#123;&#125;</code>，来实现更复杂的变量表达式。</p>
<p>字符串中的字符可以用<code>[]</code>或者<code>&#123;&#125;</code>（不建议）访问。下标超出字符串长度时，会将<strong>多出的长度用空格填充</strong>。另外，字符串使用<code>.</code>连接。使用<code>strval()</code>转换变量为字符串，boolean会转成<code>&quot;1&quot;</code>或<code>&quot;&quot;</code>。integer和float作字面转换。**array总转换成<code>&quot;Array&quot;</code>**。object总转换成”Object”。NULL总转变成<code>&quot;&quot;</code>。</p>
<p><code>serialize()</code>可以串行化大部分PHP值。字符串转为数值时，类似Javascript的<code>parseInt()/parseFloat()</code>，试图从头转换直到遇到不合法字符，支持科学记数法。区别在于PHP中失败时返回<code>0</code>而不是<code>NAN</code>。</p>
<p>关于string的更多介绍，参加<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.types.string.php#language.types.string">官方文档String</a>一章。</p>
<h4 id="array"><a href="#array" class="headerlink" title="array"></a>array</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$array</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;foo&quot;</span> =&gt; <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span> =&gt; <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自 PHP 5.4 起</span></span><br><span class="line"><span class="variable">$array</span> = [</span><br><span class="line">    <span class="string">&quot;foo&quot;</span> =&gt; <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span> =&gt; <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>与Javascript区别较大，PHP中的数组也是个<strong>有序</strong>映射，描述了keys到values的映射。array使用<code>array()</code>初始化，在5.4版本后支持字面量定义。<strong>key可以是integer或string</strong>（integer时是数组，string时是键值对），value可以是任何类型。使用<code>[]</code>访问和修改数组元素，通过<code>unset()</code>删除某键值对（类似与Javascript的<code>delete</code>）。有趣的是，使用<code>[]</code>不指定键名时，则取当前最大整数索引值（曾经存在即可），新的键名在之上加1。可以使用<code>array_values()</code>重建索引。</p>
<p>转换为数组时，除object、NULL类型外，其余类型得到只有一个元素的数组。object类型转换时，单元为对象的属性，键名为成员变量名，还有其他特殊情况见文档<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.types.array.php">数组</a>部分。NULL会转换为一个空数组。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$A</span>; <span class="comment">// This will become &#x27;\0A\0A&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$A</span>; <span class="comment">// This will become &#x27;\0B\0A&#x27;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$AA</span>; <span class="comment">// This will become &#x27;AA&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>((<span class="keyword">array</span>) <span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br></pre></td></tr></table></figure>

<h4 id="object"><a href="#object" class="headerlink" title="object"></a>object</h4><p>对象，通过new来实例化一个类产生。转换为对象时，PHP会创建一个内置类stdClass的实例，可以通过<code>new stdClass()</code>创建一个空对象。php 7后，还有<code>new class&#123;&#125;</code>和<code>(object) []</code>方法。</p>
<h4 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h4><p>用于保存到外部资源的一个引用，通过专门的函数建立和使用，由Zend引擎维护资源回收。</p>
<h4 id="NULL"><a href="#NULL" class="headerlink" title="NULL"></a>NULL</h4><p>表示一个变量没有值。可细分为被赋值为<code>NULL</code>，尚未赋值和被<code>unset()</code>。<strong>NULL不区分大小写</strong>。</p>
<h4 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h4><p>类似Javascript中的function类型，一些函数如<code>call_user_func()</code>可以接收用户定义的回调函数作为参数。传递时，以string类型传递函数名。5.3.0后可以直接传递closure给回调参数。</p>
<p>其余伪类型多用于代码的说明注释中，如<code>mixed</code>表述多种不确定类型，<code>void</code>表述函数返回值无用或不接受任何参数等。</p>
<h4 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h4><p>使用<code>var_dump()</code>查看值和类型，<code>gettype()</code>查看类型，<code>is_int</code>&#x2F;<code>is_string</code>&#x2F;…判断类型，<code>(type)</code>或<code>settype()</code>强制类型转换。PHP的强制转换和C非常相似。目前支持<code>(int)</code>, <code>(bool)</code>, <code>(float)</code>, <code>(string)</code>, <code>(array)</code>, <code>(object)</code>, <code>(unset)</code>（转换为<code>NULL</code>）。5.2版本后支持<code>(binary)</code>转换。</p>
<p>除了强制转换，PHP中会根据需要对变量自动转换，如加法。与Javascript的<code>+</code>不大不同，PHP会优先将操作数转为float，否则会将操作数解释为integer。数组的键名会优先转换为integer（仅十进制），再转换为string。下面就是一个有趣的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$foo</span> = <span class="string">&quot;0&quot;</span>;  <span class="comment">// $foo is a string</span></span><br><span class="line">  <span class="variable">$foo</span> += <span class="number">2</span>;   <span class="comment">// $foo is an int now</span></span><br><span class="line">  <span class="variable">$foo</span> = <span class="variable">$foo</span> + <span class="number">1.3</span>;  <span class="comment">// $foo is a float now (3.3)</span></span><br><span class="line">  <span class="variable">$foo</span> = <span class="number">5</span> + <span class="string">&quot;10 Little Piggies&quot;</span>; <span class="comment">// $foo is an integer (15)</span></span><br><span class="line">  <span class="variable">$foo</span> = <span class="number">5</span> + <span class="string">&quot;Small Pigs&quot;</span>;     <span class="comment">// $foo is an integer (5)</span></span><br></pre></td></tr></table></figure>

<h3 id="变量-amp-常量"><a href="#变量-amp-常量" class="headerlink" title="变量 &amp; 常量"></a>变量 &amp; 常量</h3><p>PHP变量以<code>$</code>符号开头，只能包含数字字母（这里说的字母包含ASCII字符）和下划线且不能以数字开头。变量区分大小写。<code>$this</code>是特殊变量不能赋值。可以在<code>$</code>前加<code>&amp;</code>符号<strong>引用赋值</strong>，在改变原变量时，目标变量也会改动。<code>isset()</code>可以检查变量是否已被赋值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$var</span> = <span class="string">&#x27;Bob&#x27;</span>;</span><br><span class="line"><span class="variable">$Var</span> = <span class="string">&#x27;Joe&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$var</span>, <span class="subst">$Var</span>&quot;</span>;      <span class="comment">// 输出 &quot;Bob, Joe&quot;</span></span><br><span class="line"></span><br><span class="line">$<span class="number">4</span>site = <span class="string">&#x27;not yet&#x27;</span>;     <span class="comment">// 非法变量名；以数字开头</span></span><br><span class="line"><span class="variable">$_4site</span> = <span class="string">&#x27;not yet&#x27;</span>;    <span class="comment">// 合法变量名；以下划线开头</span></span><br><span class="line"><span class="variable">$i</span>站点is = <span class="string">&#x27;mansikka&#x27;</span>;  <span class="comment">// 合法变量名；可以用中文</span></span><br></pre></td></tr></table></figure>

<p>用户在为变量命名时，有几点要注意的。function, class, interface, 常量和函数外定义的变量会进入全局命名空间；建议在函数名中用<code>_</code>区分，类名中用驼峰或首字母大写的驼峰命名。注意：很多情况下，PHP会自动将变量名中的点转换成下划线。</p>
<h4 id="可变变量"><a href="#可变变量" class="headerlink" title="可变变量"></a>可变变量</h4><p>PHP中的变量名可以很方便地改变，而且可变变量可以用在数组或对象中，如下面的例子，。使用可变变量时，注意通过花括号给属性名清晰定界。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Given these variables ...</span></span><br><span class="line"><span class="variable">$nameTypes</span>    = <span class="keyword">array</span>(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;last&quot;</span>, <span class="string">&quot;company&quot;</span>);</span><br><span class="line"><span class="variable">$name_first</span>   = <span class="string">&quot;John&quot;</span>;</span><br><span class="line"><span class="variable">$name_last</span>    = <span class="string">&quot;Doe&quot;</span>;</span><br><span class="line"><span class="variable">$name_company</span> = <span class="string">&quot;PHP.net&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Then this loop is ...</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$nameTypes</span> <span class="keyword">as</span> <span class="variable">$type</span>)</span><br><span class="line">  <span class="keyword">print</span> $&#123;<span class="string">&quot;name_<span class="subst">$type</span>&quot;</span>&#125; . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... equivalent to this print statement.</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;<span class="subst">$name_first</span>\n<span class="subst">$name_last</span>\n<span class="subst">$name_company</span>\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="预定义变量"><a href="#预定义变量" class="headerlink" title="预定义变量"></a>预定义变量</h4><p>PHP提供许多预定义的变量。PHP中的许多预定义变量都是“超全局的”，这意味着它们在脚本的全部作用域都可见。这种类型在4.1版本中被引入，有<code>$GLOBALS</code>, <code>$_SERVER</code>, <code>$_GET</code>, <code>$_POST</code>, <code>$_FILES</code>, <code>$_COOKIE</code>, <code>$_SESSION</code>, <code>$_REQUEST</code>, <code>$_ENV</code>。它们在5.4版本后不能作为函数的输入参数。通过这些预设的超全局变量，PHP可以轻松地获取请求的各种参数。</p>
<p>除了上述超全局变量外，还有<code>$php_errormsg</code>, <code>$HTTP_RAW_POST_DATA</code>（使用php:&#x2F;&#x2F;input代替）, <code>$http_response_header</code>(使用HTTP包装其时，该变量会被自动填充)，<code>$argc</code>和<code>$argv</code>分别代表传递给脚本的参数数目和参数数组（运行在命令行下时）。</p>
<h4 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h4><p>变量作用域通常为文件作用域。函数内部的声明的变量被限制在函数作用域内。同时，和Javascript相同，<strong>PHP没有块级作用域</strong>。注意，PHP中定义全局变量需使用<code>global</code>关键字。在函数内部，变量优先视作局部变量。下面的脚本不会有任何输出，因为<code>echo</code>引用了一个局部变量<code>$a</code>，但是在函数作用域内它并没有被赋值。要想$a在函数作用域内可见，需要在引用前声明<code>global</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="number">1</span>; <span class="comment">/* global scope */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a</span>; <span class="comment">/* reference to local scope variable */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">Test</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">Test2</span>();</span><br></pre></td></tr></table></figure>

<p>静态变量通过<code>static</code>声明，<strong>仅在局部作用域存在</strong>，程序离开作用域时内容不丢失。静态变量不能使用表达式初始化。在下面的例子中，函数仅在第一次调用时初始化<code>$a</code>变量，之后每次调用都会输出<code>$a</code>，并加一。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$a</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="variable">$a</span>++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h4><p>在类外，常量通过<code>define(name. value)</code>函数定义。在类内使用<code>const</code>定义常量（5.3.0后）。常量的命名规范同C。常量只能是标量。<strong>在访问常量值时，名字前不带<code>$</code><strong>。常量名事先无法确定时，使用<code>constant()</code>获取常量。</strong>常量没有作用域的限制</strong>，可以在任何位置访问。</p>
<p>PHP定义了大量的魔术常量，都以两个下划线开头和结尾。有<code>__LINE__</code>，<code>__FILE__</code>, <code>__DIR__</code>, <code>__FUNCTION__</code>, <code>__CLASS__</code>, <code>__TRAIT__</code>, <code>METHOD__</code>, <code>__NAMESPACE__</code>。具体解释见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/language.constants.predefined.php">官方文档</a>。</p>
<h3 id="表达式-amp-流程"><a href="#表达式-amp-流程" class="headerlink" title="表达式 &amp; 流程"></a>表达式 &amp; 流程</h3><p>PHP的表达式根据官方的定义表述，是<em>任何有值的东西</em>。表达式的组成类似于其他语言，从略。值得注意的有以下几点：</p>
<ul>
<li>PHP的逻辑运算符同时有<code>&amp;&amp;</code>, <code>||</code>以及<code>and</code>, <code>xor</code>, <code>or</code>两套，但是<strong>后一套的优先级最低</strong>。</li>
<li>PHP提供<code>@</code>作为错误控制运算符，放置在表达式前可以忽略产生的任何错误信息。<strong>强烈不建议使用</strong>。</li>
<li>反引号``执行其中的shell命令，并将输出结果返回，等同于执行<code>shell_exec()</code>。</li>
<li><code>+</code>, <code>==</code>, <code>===</code>还可以用于数组间的运算，进行数组的连接，键值对相同的检测。</li>
<li><code>instanceof</code>用于确定变量是否属于某个类的实例。用法如<code>$a instanceof MyClass</code></li>
</ul>
<p>算法流程上，PHP类似C风格。不同点有：</p>
<ul>
<li>提供在<code>&lt;?php&gt;</code>闭合标签内使用<code>for endfor</code>这种用法</li>
<li><code>foreach(array as $key =&gt; $value)</code>便于遍历数组。（注意：在<code>$value</code>前<code>&amp;</code>可以在<code>foreach</code>循环中改变<code>value</code>的值）</li>
<li><code>break</code>可以接受一个可选的数字决定跳出几层循环</li>
<li><code>continue</code>接受一个可选的数字参数来决定跳过几重循环到循环结尾。默认值是<code>1</code></li>
<li><code>declare</code>设定一段代码的施行指令，目前只支持<code>ticks</code>和<code>encoding</code>。前者控制执行计时的若干条命令后的操作，后者决定代码的运行编码。</li>
<li><code>require</code>和<code>include</code>效果类似，用法同C，它们也有带后缀<code>_once</code>的操作符</li>
</ul>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>PHP的函数定义和其他语言类似，定义的函数都具有全局作用域。不同的是</p>
<ul>
<li>PHP可以使用<code>create_function(args, code)</code>这样的函数定义函数（类似JS中的<code>new Function()</code>）</li>
<li>函数需要先定义后使用（这个只是与Javascript不同）</li>
<li>PHP可以定义有条件的函数，通过用if包裹和放在function定义内</li>
</ul>
<p>和C&#x2F;C++风格很像的是：</p>
<ul>
<li>PHP函数参数接收的是一个复制，需要传递引用改变原值；</li>
<li>支持默认参数，需放在最右；</li>
<li>5.0之后支持对输入参数类型检查，到5.4为止支持class &#x2F; array &#x2F; callable类型，7.0以后支持标量类型。如果给出的值类型不对，那么将会产生一个错误</li>
<li>7.0之后支持不对输入参数强制类型转换。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> <span class="keyword">extends</span> <span class="title">C</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This doesn&#x27;t extend C.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">C <span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">get_class</span>(<span class="variable">$c</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">f</span>(<span class="keyword">new</span> C);</span><br><span class="line"><span class="title function_ invoke__">f</span>(<span class="keyword">new</span> D);</span><br><span class="line"><span class="title function_ invoke__">f</span>(<span class="keyword">new</span> E);</span><br></pre></td></tr></table></figure>

<p>和Js相似的一点时，5.6版之后支持使用<code>...</code>符号获取参数列表。</p>
<p>和可变变量一样，PHP中有可变函数，用法和可变变量一样。在调用对象的静态方法时，函数调用要优于静态属性，下面是一个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$variable</span> = <span class="string">&#x27;static property&#x27;</span>;</span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">Variable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Method Variable called&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title class_">Foo</span>::<span class="variable">$variable</span>; <span class="comment">// This prints &#x27;static property&#x27;. It does need a $variable in this scope.</span></span><br><span class="line"><span class="variable">$variable</span> = <span class="string">&quot;Variable&quot;</span>;</span><br><span class="line"><span class="title class_">Foo</span>::<span class="variable">$variable</span>();  <span class="comment">// This calls $foo-&gt;Variable() reading $variable in this scope.</span></span><br></pre></td></tr></table></figure>

<p>5.3之后，PHP也支持匿名函数，并可以传递给一个变量储存。实际中，这种表达式会被转换为内置类Closure的对象实例。闭包可以从父作用域继承变量，但是此类变量需要用<em>use结构</em>传递进去，类似于<code>function() use($a)&#123;&#125;</code>这样的形式。</p>
<h3 id="类-amp-对象"><a href="#类-amp-对象" class="headerlink" title="类 &amp; 对象"></a>类 &amp; 对象</h3><p>PHP承袭着面向对象语言对类和对象的处理。类以<code>class</code>开头，里面包含属性和方法等，可以包含自己的常量。通过<code>new</code>实例化，通过<code>extends</code>实现继承。子类使用<code>parent::</code>访问被覆盖的属性或方法，使用<code>self::</code>自身的静态属性和方法。5.5之后使用<code>ClassName::class</code>可以获取带有命名空间的完整类名。轻量级的类可以通过强制转换关联数组实现。</p>
<p>类中的静态属性通过<code>::</code>访问，非静态属性通过<code>-&gt;</code>访问。定义常量时使用<code>const</code>，常量的值必须是一个定值（5.6之后可以是数学运算结果）。PHP 5新增了关键字<code>final</code>，修饰方法或者类不可被继承。</p>
<p>PHP 5中，**<code>__autoload()</code>函数会在使用未定义的类时自动调用**，5.3.0之后通常使用<code>spl_autoload_register()</code>作为<code>autoload</code>的替代。<code>__construct()</code>和<code>__destruct()</code>分别是构造和析构函数，5.3.3之前，在没有<code>__construct()</code>函数也没有父类时，会寻找命名空间中与类名同名的方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">spl_autoload_register</span>(function (<span class="variable">$class_name</span>) &#123;</span><br><span class="line">    <span class="keyword">require_once</span> <span class="variable">$class_name</span> . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span>  = <span class="keyword">new</span> <span class="title class_">MyClass1</span>();</span><br><span class="line"><span class="variable">$obj2</span> = <span class="keyword">new</span> <span class="title class_">MyClass2</span>();</span><br></pre></td></tr></table></figure>

<h4 id="trait-amp-匿名类"><a href="#trait-amp-匿名类" class="headerlink" title="trait &amp; 匿名类"></a>trait &amp; 匿名类</h4><p>在访问控制，继承，抽象类，接口等方面PHP和传统的面向对象语言很像。在5.4.0后，PHP提供了<strong>trait作为类之间代码水平复用的特性（很像mixin）</strong>。在class定义中使用<code>use</code>来获取trait，类似interface，一个类可以插入多个trait，trait会覆盖基类方法而被当前类方法覆盖。在多个trait的同名方法发生冲突时，通过<code>insteadof</code>和<code>as</code>来决定使用哪个，具体见<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.traits.php">trait文档</a>。trait的功能使用依赖注入也可以完成，相关讨论见<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7892749/traits-in-php-any-real-world-examples-best-practices">stackoverflow trait practives</a>与<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9205083/traits-vs-interfaces">trait vs interface</a>。trait甚至还支持抽象成员和静态成员。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">smallTalk</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bigTalk</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">smallTalk</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bigTalk</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Talker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">A</span>, <span class="title">B</span> &#123;</span><br><span class="line">        <span class="title">B</span>::<span class="title">smallTalk</span> <span class="title">insteadof</span> <span class="title">A</span>;</span><br><span class="line">        A::<span class="variable constant_">bigTalk</span> <span class="keyword">insteadof</span> B;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Aliased_Talker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">A</span>, <span class="title">B</span> &#123;</span><br><span class="line">        <span class="title">B</span>::<span class="title">smallTalk</span> <span class="title">insteadof</span> <span class="title">A</span>;</span><br><span class="line">        A::<span class="variable constant_">bigTalk</span> <span class="keyword">insteadof</span> B;</span><br><span class="line">        B::<span class="variable constant_">bigTalk</span> <span class="keyword">as</span> talk;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PHP7.0之后支持匿名类，用于创建一次性的简单对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// PHP 7 之前的代码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$msg</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$util</span>-&gt;<span class="title function_ invoke__">setLogger</span>(<span class="keyword">new</span> <span class="title class_">Logger</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用了 PHP 7+ 后的代码</span></span><br><span class="line"><span class="variable">$util</span>-&gt;<span class="title function_ invoke__">setLogger</span>(<span class="keyword">new</span> <span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_ invoke__">log</span>(<span class="variable">$msg</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="“重载”"><a href="#“重载”" class="headerlink" title="“重载”"></a>“重载”</h4><p>PHP提供的<strong>重载（overload）</strong>语义和其他大部分OOP语言不同，指在调用当前环境下未定义或不可见的类属性或方法时调用重载方法。PHP借助<strong>魔术方法</strong>实现重载。读写不可访问属性时，<code>__get()</code>和<code>__set()</code>分别被调用；对不可访问属性调用<code>isset</code>和<code>unset</code>时，<code>__isset()</code>和<code>__unset()</code>分别被调用。<strong>属性重载只能在对象中进行</strong>。调用不可访问的方法和静态方法时，<code>__call()</code>和<code>__callStatic()</code>分别被调用，方法重载用法类似属性重载。重载的示例见文档。（<em>不建议使用这个特性，这会影响ide补全和代码的可读性</em>）。</p>
<p>PHP5提供foreach方法遍历对象，默认情况可见属性都会被遍历，可以让类实现<code>Iterator</code>接口从而自行决定如何处理遍历。实现<code>IteratorAggregate</code>接口可以代替实现所有的Iterator方法，<code>IteratorAggregate</code>只需实现<code>IteratorAggregate::getIterator()</code>方法即可。</p>
<h4 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h4><p>PHP将所有<code>__</code>开头的类方法保留为<strong>魔术方法</strong>，<code>__sleep()</code>方法在<code>serialize()</code>函数前调用，应返回一个包含对象中所有应被序列化的变量名称的数组，相对的<code>__wakeup()</code>在反序列化函数前调用。<code>__toString()</code>在把一个类视作字符串时怎样回应时调用。<code>__invoke()</code>在把一个类视作函数调用时调用。更多方法见<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php">魔术方法页面</a>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$link</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$server</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$db</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$server</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$db</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;server = <span class="variable">$server</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">connect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;link = <span class="title function_ invoke__">mysql_connect</span>(<span class="variable">$this</span>-&gt;server, <span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">        <span class="title function_ invoke__">mysql_select_db</span>(<span class="variable">$this</span>-&gt;db, <span class="variable">$this</span>-&gt;link);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;server&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;db&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">connect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PHP使用<code>clone</code>创造对象的浅复制（即只创造属性的引用），魔术方法<code>__clone()</code>在clone完成后调用。PHP 5中的对象甚至可以相互比较，使用<code>==</code>判断属性和属性值是否一致，<code>===</code>判断变量是否是同一个实例。</p>
<p>自5.3.0起，PHP增加了<code>static::</code>关键字和<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.late-static-bindings.php">后期静态绑定</a>的功能，用于在继承范围内引用静态调用的类。静态环境下绑定静态方法可以让子类在<strong>自己的环境</strong>下（自己的this）调用继承自基类的方法。这种方式绑定非静态方法时，会出现不同结果，尽量避免使用。</p>
<p>对象通过<code>serialize()</code>和<code>unserialize()</code>来序列化和反序列化一个对象，对象的方法和静态成员不会保留。<strong>在解序列的文件域内需要包含类的定义</strong>。</p>
<h4 id="预定义接口"><a href="#预定义接口" class="headerlink" title="预定义接口"></a>预定义接口</h4><p>PHP预定义了许多接口。<code>Traversal</code>接口监测一个类是否可以使用foreach进行遍历（仅供引擎使用）。<code>Iterator</code>接口用来实现对象的foreach迭代，有<code>rewind</code>, <code>current</code>, <code>key</code>, <code>next</code>, <code>valid</code>等成员方法。除此以外还有聚合迭代，数组式访问，序列化，生成器接口等接口和Closure类。这里从略。</p>
<h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><p>命名空间是PHP一个比较有特点的特性。在PHP中用命名空间解决<strong>类库和用户代码名字冲突的问题</strong>。实际上命名空间所做的事情就是代码模块化，正如Java的packages和Javascript里CommonJS规范一样。命名空间的命名方法类似变量，不允许使用PHP或php开头的命名空间。下面是一个命名空间的范例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">my</span>\<span class="title class_">name</span>; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myfunction</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MYCONST</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">MyClass</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> \my\name\MyClass; </span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">strlen</span>(<span class="string">&#x27;hi&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">namespace</span>\<span class="title class_">MYCONST</span>; </span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">__NAMESPACE__</span> . <span class="string">&#x27;\MYCONST&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">constant</span>(<span class="variable">$d</span>);</span><br></pre></td></tr></table></figure>

<p>除了<code>declare</code>语句以外，<strong>namespace的定义需在文件的最前面</strong>。PHP与其它的语言特征不同，同一个命名空间可以定义在多个文件中，即<strong>允许将同一个命名空间的内容分割存放在不同的文件中</strong>。在命名空间中使用define定义常量时，需要带上<code>__NAMESPACE__</code>，否则意味着定义在全局空间下。</p>
<p>PHP中的命名空间和文件目录很像，也支持层级化的定义方法，即定义子命名空间，父子间通过反斜线<code>\</code>隔开。可以在单文件内定义多个namespace（<strong>不提倡</strong>），建议namespace间通过大括号隔离开。PHP命名空间可以和文件系统进行类比，类名非限定时，会在当前空间寻找，以<code>\</code>开头时从全局空间寻找（相对目录），否则从当前空间起向下寻找（绝对目录）。下面是一个使用了三种方法的样例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Foo</span>\<span class="title class_">Bar</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;file1.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FOO</span> = <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">staticmethod</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 非限定名称 */</span></span><br><span class="line"><span class="title function_ invoke__">foo</span>();     <span class="comment">// 解析为 Foo\Bar\foo</span></span><br><span class="line">foo::<span class="title function_ invoke__">staticmethod</span>();     <span class="comment">// 解析为类 Foo\Bar\foo的静态方法static method</span></span><br><span class="line"><span class="keyword">echo</span> FOO; <span class="comment">// 解析为常量 Foo\Bar\FOO</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 限定名称 */</span></span><br><span class="line">subnamespace\<span class="title function_ invoke__">foo</span>(); <span class="comment">// 解析为函数 Foo\Bar\subnamespace\foo</span></span><br><span class="line">subnamespace\foo::<span class="title function_ invoke__">staticmethod</span>(); <span class="comment">// 解析为类 Foo\Bar\subnamespace\foo, 以及类的方法 staticmethod</span></span><br><span class="line"><span class="keyword">echo</span> subnamespace\FOO; <span class="comment">// 解析为常量 Foo\Bar\subnamespace\FOO</span></span><br><span class="line">                                  </span><br><span class="line"><span class="comment">/* 完全限定名称 */</span></span><br><span class="line">\Foo\Bar\<span class="title function_ invoke__">foo</span>(); <span class="comment">// 解析为函数 Foo\Bar\foo</span></span><br><span class="line">\Foo\Bar\foo::<span class="title function_ invoke__">staticmethod</span>(); <span class="comment">// 解析为类 Foo\Bar\foo, 以及类的方法 staticmethod</span></span><br><span class="line"><span class="keyword">echo</span> \Foo\Bar\FOO; <span class="comment">// 解析为常量 Foo\Bar\FOO</span></span><br></pre></td></tr></table></figure>

<p>命名空间的装载和名称的解析是在编译期完成的。命名空间有三种定义方法：</p>
<ul>
<li>非限定名称：名称中不包含命名空间分割符，即\，如Foo</li>
<li>限定名称：名称中包含命名空间分割符，如Foo\Bar</li>
<li>完全限定名称：名称中包含命名空间分割符，且以\开始的标识符，如\Foo\Bar</li>
</ul>
<p>PHP支持使用<code>namespace</code>关键字或<code>__NAMESPACE__</code>魔术常量获取当前所在命名空间。所有支持命名空间的PHP版本支持三种别名或导入方式：<strong>为类名称使用别名</strong>、<strong>为接口使用别名</strong>、<strong>为命名空间名称使用别名</strong>。这么做类似于在操作系统中创建符号连接。别名通过操作符<code>use as</code>实现。注意：导入命名空间后文件内的类名，接口名等会收到导入的影响。在一个命名空间中，当PHP遇到一个非限定的类、函数或常量名称时，它使用不同的优先策略来解析该名称。对于函数和常量来说，如果当前命名空间中不存在该函数或常量，PHP会退而使用全局空间中的函数或常量。因此在访问系统内部或不包含在命名空间中的类名称时，必须使用完全限定名称。</p>
<h3 id="错误和异常"><a href="#错误和异常" class="headerlink" title="错误和异常"></a>错误和异常</h3><p>PHP的错误类型有很多，可以见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/errorfunc.constants.php">类型列表</a>。PHP对错误的汇报方式由<code>php.ini</code>中的<code>error_reporting</code>命令控制，可以在运行时通过<code>error_reporting()</code>函数动态修改。在开发环境，建议将级别设置到<code>E_ALL</code>，同时在脚本的开头设置级别。<code>php.ini</code>中的<code>display_errors</code>指令控制是否将错误显示在脚本输出中，建议在生产环境中关闭。<code>log_errors</code>指令控制错误记录。</p>
<p>PHP 5中异常可以被抛出，由try&#x2F;catch语句块获取。<code>catch</code>获得的是一个<code>Exception</code>类的实例。类似Java，可以在catch后加上finally语句块。Exception是一个类，有<code>getMessage</code>，<code>getTraceAsString</code>等方法可以使用和拓展，详见介绍。PHP 7中，大多数错误都被作为Error异常抛出，可以被第一个匹配的try&#x2F;catch语句块捕获，否则交给PHP相应的异常处理函数处理，如果尚未通过<code>set_exception_handler()</code>注册童永刚异常处理函数，则会报告一个Fatal Error。注意：捕获错误或异常时，若在自定义命名空间下，Exception需要用完全限定方式书写。</p>
<p>7.0以后的版本中，<code>Error</code>和<code>Exception</code>同属于<code>Throwable</code>类型，这一点与5.x版本不同。代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//To catch both exceptions and errors in PHP 5.x and 7, add a catch block for Exception AFTER catching Throwable first.</span></span><br><span class="line"><span class="comment">//Once PHP 5.x support is no longer needed, the block catching Exception can be removed.</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Code that may throw an Exception or Error.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$t</span>)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Executed only in PHP 7, will not match in PHP 5</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Executed only in PHP 5, will not be reached in PHP 7</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="生成器（generator）"><a href="#生成器（generator）" class="headerlink" title="生成器（generator）"></a>生成器（generator）</h3><p>PHP中的生成器的概念与Java等高级语言中生成器的概念无二。生成器函数看起来像一个普通的函数，不同的是普通函数返回一个值，而一个生成器可以<code>yield</code>生成许多它所需要的值。当一个生成器被调用的时候，它返回一个可以被遍历的对象。PHP 将会在每次需要值的时候调用生成器函数，并在产生一个值之后保存生成器的状态。<strong>生成器不可以返回值</strong>。return语句只会终止生成器继续执行。</p>
<p><strong>yield会返回一个值给循环调用此生成器的代码并且只是暂停执行生成器函数</strong>。可以使用yield返回键值对，引用或<code>NULL</code>等。在PHP 7以后，使用<code>yield from</code>可以从实现了Iterator接口的对象或使用yield的函数中yield值。如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">count_to_ten</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> [<span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="keyword">new</span> <span class="built_in">ArrayIterator</span>([<span class="number">5</span>, <span class="number">6</span>]);</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="title function_ invoke__">seven_eight</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">yield</span> <span class="keyword">from</span> <span class="title function_ invoke__">nine_ten</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">seven_eight</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="title function_ invoke__">eight</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eight</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nine_ten</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$gen</span> = <span class="title function_ invoke__">count_to_ten</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$gen</span> <span class="keyword">as</span> <span class="variable">$num</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$num</span> &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$gen</span>-&gt;<span class="title function_ invoke__">getReturn</span>();</span><br></pre></td></tr></table></figure>

<p>对比生成器和实现Iterator接口的类来看，生成器的代码可读性更高，代码量也更少，缺憾在于不能多次迭代和回退，除非重建或使用clone。</p>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p><strong>PHP的引用意味着不同的名字访问同一个变量内容</strong>，通过在变量前加上<code>&amp;</code>使用。在对一个未定义的变量进行引用参数传递或引用返回时，会自动创建该变量。不使用<code>&amp;</code>符号时，意味着生成一个拷贝。</p>
<p>在进行引用传递时，只能传递变量，New语句和函数中返回的引用；引用返回时，需要在函数名前加上&amp;符号，同时接受返回值的变量也需写为接收引用的形式。<br>通过<code>unset</code>销毁引用，销毁引用的同时不会销毁原变量（类似于删除符号链接）。<code>global $var</code>实际上就是创建了到<code>$GLOBALS[]</code>的引用。<code>$this</code>也是同理。</p>
<h3 id="支持的协议"><a href="#支持的协议" class="headerlink" title="支持的协议"></a>支持的协议</h3><p>PHP带有内置URL风格的封装协议，可用于类似<code>fopen()</code>、<code>copy()</code>、<code>file_exists()</code>和<code>filesize()</code>的文件系统函数，如file, http, ftp, php, zlib, data等。其中<code>php://</code>提供的是输入输出流和错误描述符的访问能力。创建数据流前，可以通过<code>stream_context_create()</code>创建上下文选项，定义数据流的选项。</p>
<h2 id="函数参考"><a href="#函数参考" class="headerlink" title="函数参考"></a>函数参考</h2><p>PHP本身提供了海量的函数。且都可以全局访问到。</p>
<h3 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h3><p>内核部分的函数，不能通过编译选项去除。PHP这部分的函数和介绍相当多，这里只撷选了常用的部分。</p>
<h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h4><p>这部分的函数主要用来进行和数组相关的操作，由于PHP中的数组包括了键值对这样类似对象的功能，函数的数量很多，甚至有些冗余。</p>
<ul>
<li><code>array_chunk</code> 将数组分割为多个，单元数目由size决定。返回一个多维数组。</li>
<li><code>array_merge</code> 将多个数组的单元合并在一起，字符串键名相同时，后面的值会覆盖前一个。类似的还有array_merge_recursive。</li>
<li><code>array_count_values</code> 统计数组中所有的值出现的次数，返回一个关联数组</li>
<li><code>array_diff</code> 计算数组的差集，返回在array1但不在array2的元素</li>
<li><code>array_intersect</code> 计算数组的交集，返回一个在array1中出现同时也在其他所有参数数组中出现的值。在差和交的名称前加上u的函数可以自己指定比较方法。</li>
<li><code>array_fill</code> 用给定的值填充数组的num个条目，start_index为返回数组的第一个索引值。array_fill_keys函数可以填充键值对。<code>array_pad</code> 用值将数组填充到指定长度。键从第一个整型数开始，否则从0开始。</li>
<li><code>array_flip</code> 返回一个交换键和值的数组。不合法的值将不会反转。类似的<code>array_reverse</code>返回一个单元顺序相反的数组。</li>
<li><code>array_combine(array $keys , array $values)</code>返回一个由<code>keys</code>数组作键，<code>values</code>数组作值的新数组，两个数组长度不一样时抛出异常。<code>array_keys(array $array [, mixed $search_value [, bool $strict= false ]])</code>返回所有值为<code>search_value</code>的键名，<code>strict</code>表示是否进行严格比较。类似地，<code>array_values(array $input)</code>返回一个由所有值组成的数组，并建立起数字索引。</li>
<li><code>array_multisort</code>用来一次多多个数组排序，输入数组被当作一个数据表的若干列来排序。常用在对数据库数据的排序。返回值为bool类型。</li>
<li><code>array_push</code>和<code>array_pop</code>分别在array的末尾弹出或压入一个元素。</li>
<li><code>array_shift</code>和<code>array_uinshift</code>完成类似于上面的功能，不过是在数组开头。</li>
<li><code>array_product()</code>和<code>array_sum()</code>分别返回数组的乘积和总和。</li>
<li><code>array_filter</code>用回调函数过滤数组单元。没有回调函数时将删除input中等值于FALSE的条目。</li>
<li><code>array_map</code>返回一个arr1所有单元经过callback作用后的单元。callback 接受的参数数目应该和传递给 array_map() 函数的数组数目一致。</li>
<li><code>array_walk</code>使用用户自定义的函数对数组每个函数做回调处理。</li>
<li><code>array_reduce</code>根据回调将array简化为一个值。function变量可以读取result和item。</li>
<li><code>array_replace(array $array1 , array $array2 [, array $... ])</code>将前面的数组的键值对覆盖为后面的键值对。多维数组下有recursive版本。</li>
<li><code>array_key_exists</code>检查键名是否存在于数组中。<code>array_search(mixed $needle , array $haystack [, bool $strict = false ])</code>在数组中搜索给定值。</li>
<li><code>array_slice</code>根据offset和length从数组中取出一段。</li>
<li><code>array_splice</code>把input数组中由offset和length指定的单元去掉，如果提供了replacement参数，则用其中的单元取代。</li>
<li><code>array_unique</code>用于移除数组中重复的值</li>
</ul>
<p>除了这些，还有<code>is_array()</code>，<code>explode()</code>，<code>split()</code>等不以array开头的函数和数组相关，大多用来进行一些简单的操作，列表见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/ref.array.php">数组参考</a>。和数组排序相关的函数也有很多，它们在排序依据，是否稳定等方面各不相同，更多内容参考对数组进行排序。</p>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p>和字符串相关的函数也很多，但只有以str开头的是严格意义上的字符串函数。下面列举了部分：</p>
<ul>
<li><code>addslashes</code>转义字符串中的单引号，双引号，反斜线和NUL</li>
<li><code>chr</code>返回ASCII码对应的字符，<code>ord()</code>是其互补函数</li>
<li><code>chunk_split($body[,int $chunklen = 76 [,string $end = &quot;\r\n&quot; ]] )</code>拆分<code>$body</code>为<code>$chunklen</code>的小块，每块后用<code>$end</code>结尾</li>
<li><code>crypt</code>返回一个单向字符串散列，<code>md5</code>计算字符串的MD5散列值，<code>sha1</code>计算sha1散列值</li>
<li>echo 输出一组字符串</li>
<li><code>explode</code>使用一个字符串分割另一个字符串；类似地，<code>implode</code>将一个一维数组的值转为字符串。又写作<code>join</code>。</li>
<li><code>htmlentites</code>转义所有的特殊字符为HTML实体；<code>html_entity_decode()</code>实现相反的步骤。</li>
<li><code>htmlspecialchars()</code>和<code>htmlspecialchars_decode()</code>完成的功能和上面相似，但是转义的字符只有<code>&amp;</code>，<code>&quot;</code>，<code>&#39;</code>，<code>&lt;</code>，<code>&gt;</code>。</li>
<li><code>lcfirst</code>将首字母小写，<code>ucfirst</code>将首字母大写，<code>ucwords</code>将每个单词的首字母大写</li>
<li><code>ltrim</code>，<code>rtrim</code>和<code>trim</code>删除字符串首部，尾端和两端的空白。</li>
<li><code>str_getcsv</code>解析csv字符串为一个数组</li>
<li><code>str_pad</code>使用另一个字符串填充字符串到指定长度</li>
<li><code>str_repeat</code> 重复一个字符串</li>
<li><code>str_replace</code> 字符串替换，<code>preg_replace</code>的特殊情况</li>
<li><code>str_shuffle</code>随机打乱一个字符串</li>
<li><code>str_split</code>将一个字符串转换为数组</li>
<li><code>strstr</code>查找字符串的第一次出现。<code>stristr()</code>则不区分大小写地查找</li>
<li><code>strcmp</code>二进制安全字符串比较大小，<code>strncmp</code>类似，不过允许指定比较的长度，<code>strnatcmp</code>以自然顺序比较字符串</li>
<li><code>strlen</code>获取字符串长度</li>
<li><code>strpos</code>查找字符串初次出现位置，<code>strrpos</code>查找最后一次出现，<code>strripos</code>不区分大小写查找最后一次出现</li>
<li><code>strrev</code>反转字符串</li>
<li><code>strip_tags</code>去除str中的空字符，HTML标记和PHP标记，和<code>fgetss()</code>机制一样</li>
<li><code>strtoupper</code>将字符串转化为大写，<code>strtolower</code>将字符串转换为小写</li>
<li><code>strtr()</code>翻译、转换指定字符</li>
<li><code>substr</code>返回字符串的子串</li>
<li><code>substr_count</code>返回子字符串在字符串中出现的次数。</li>
</ul>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><ul>
<li><code>boolvar()</code>转换变量为bool类型</li>
<li><code>empty()</code>判断变量是否为空</li>
<li><code>isset()</code>检测变量是否已设置</li>
<li><code>intval()</code>获取变量整数值，<code>floatval()</code>获取变量浮点数值，<code>strval()</code>获取变量的字符串表示</li>
<li><code>get_resource_type()</code>获取资源类型</li>
<li><code>gettype()</code>获取变量类型，<code>settype($var, string $type)</code>设置变量类型</li>
<li><code>is_array</code>, <code>is_bool</code>, <code>is_callable</code>, <code>is_float</code>, <code>is_int</code>, <code>is_null</code>, <code>is_numeric</code>, <code>is_object</code>, <code>is_resource</code>, <code>is_scalar</code>, <code>is_string</code>用来检测各种类型。</li>
<li><code>print_r()</code>和<code>var_dump()</code>打印变量的相关信息，<code>var_export()</code>以合法PHP代码的形式返回变量的字符串表示</li>
<li><code>serialize()</code>序列化一个变量，<code>unserialize()</code>反序列化一个变量</li>
<li><code>unset()</code>销毁指定的变量</li>
</ul>
<h4 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h4><ul>
<li><code>spl_autoload_register()</code>尝试在类名未定义时启动类的自动加载</li>
<li><code>class_alias</code>为一个类创建别名。</li>
<li><code>class_exists</code>检查指定的类是否定义</li>
<li><code>get_class()</code>返回对象实例所属类的名字。类似地还有<code>get_class_vars</code>和<code>get_class_methods</code>函数。</li>
<li><code>get_declare_classes</code>和<code>get_declare_interfaces</code>以及<code>get_declare_traits</code>获取脚本中已定义的类、接口、trait数组。</li>
<li><code>method_exists( mixed $object , string $method_name )</code>检查类方法是否存在于指定object中，类似地还有<code>property_exsits</code>，<code>interface_exists</code>和<code>trait_exist</code>等</li>
</ul>
<h4 id="日期和时间"><a href="#日期和时间" class="headerlink" title="日期和时间"></a>日期和时间</h4><p>PHP中的时间以64为数字存储。使用时需要配置好<code>php.ini</code>中时区等信息。<code>DateTime</code>，<code>DateTimeZone</code>，<code>DateInterval</code>等对象便于进行相关的操作。PHP同时提供了OOP风格和过程化风格两种方式使用函数。其中<code>DateTime</code>和<code>DateTimeImmutable</code>都继承自<code>DateTimeInterface</code>接口，有着<code>diff</code>，<code>format</code>，<code>getTimestamp</code>，<code>getTimezone</code>等方法。</p>
<p>DateTime中的部分方法如下：</p>
<ul>
<li><code>add(DateInterval $interval)</code>在当前时间上加上一个时间段</li>
<li><code>sub(DateInterval $interval)</code>在当前时间上减去一个时间段。</li>
<li><code>__construct()</code>，创建一个对象，过程化风格: <code>date_create()</code></li>
<li><code>createFromFormat</code>创建一种时间格式format的写法格式见<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/datetime.createfromformat.php">参考</a>。</li>
<li><code>modify</code>修改当前时间，modify为合法的时间格式。</li>
<li><code>setDate(int $year, int $month, int $day )</code>设置日期</li>
<li><code>setTime(int $hour ,int $minute [,int $second = 0 ])</code>设置时间。</li>
<li><code>setTimestamp()</code>设置时间戳。</li>
</ul>
<p>上述方法都有对应的过程化风格的对应函数。</p>
<p>DatePeriod和DateTimeZone等的介绍从略。除了以上的对象方法过程化的函数外，还有以下一些常用方法：</p>
<ul>
<li><code>date($format[, $timestamp)</code>，格式化一个本地时间</li>
<li><code>getdate()</code>，获得日期时间信息，<code>localtime</code>功能类似，返回一个数组。</li>
<li><code>mktime</code>获得一个日期的时间戳，默认为当前。类似的还有<code>time</code>，<code>microtime</code>，返回一个时间戳类型</li>
<li><code>strtotime</code>将英文文本的日期时间解析为Unix时间戳</li>
<li>有意思的是<code>date_sunset</code>和<code>date_sunrise</code>可以获取指定时间戳的日出日落时间</li>
</ul>
<h4 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h4><ul>
<li><code>basename()</code>返回路径的文件名部分；<code>dirname()</code>返回路径中的目录部分，<code>realpath()</code>返回规范的绝对路径名</li>
<li><code>chgrp()</code>改变文件所属组，类似的还有<code>chmod</code>和<code>chown</code></li>
<li><code>copy</code>用于拷贝文件，<code>rename</code>用于移动和重命名文件。注意，这里没有delete函数。<code>unlink</code>用于删除文件</li>
<li><code>link ()</code>建立一个硬连接，<code>linkinfo</code>, <code>lstat</code>给出连接信息。<code>symlink</code>创建一个符号连接。</li>
<li><code>mkdir</code>和<code>rmdir</code>用来创建和删除文件夹</li>
<li><code>file</code>把整个文件都入到一个数组中，一行一个元素，可以使用URL作为文件名。<code>file_exists</code>检查文件或目录是否已存在。<code>tmpfile</code>则会建立一个关闭后自动删除的临时文件。</li>
<li><code>file_get_contents</code>将文件读入到字符串中，可以使用<code>stream_context_create</code>创建上下文进行更细致的操作。</li>
<li><code>file_put_contents()</code>写文件，和依次调用<code>fopen()</code>, <code>fwrite()</code>, <code>fclose()</code>效果一样。</li>
<li><code>fileatime</code>, <code>filectime</code>, <code>filemtime</code>, <code>filegroup</code>, <code>fileowner</code>, <code>fileperms</code>, <code>filesize</code>, <code>filetype</code>, <code>stat</code>等和字面意义一样获取文件的各方面信息。它们接收文件路径作为参数。</li>
<li><code>is_dir</code>, <code>is_executable</code>, <code>is_file</code>, <code>is_link</code>, <code>is_readable</code>, <code>is_uploaded_file</code>, <code>is_writable</code>检查文件各种属性</li>
<li><code>fopen</code>打开一个文件，返回一个resource句柄，可以交给<code>fread</code>, <code>fwrite</code>, <code>fscanf</code>, <code>fclose</code>等函数做读写操作。</li>
<li><code>fgets</code>从当前指针处读取一行，<code>fgetc</code>读取一个字符，<code>fstat</code>返回文件信息，<code>ftruncate</code>将文件阶段到给定长度。</li>
<li><code>glob()</code>寻找和pattern匹配的文件路径</li>
</ul>
<p>Directory类通过<code>dir()</code>创建。Directory实例有<code>close</code>，<code>read</code>，<code>rewind</code>三种方法。分别用来释放句柄，读取条目和倒回开头。初次以外还有下面这些常用的目录相关函数。</p>
<ul>
<li><code>chdir(string $directory)</code>用来改变当前目录，</li>
<li><code>getcwd</code>取得当前工作目录</li>
<li><code>scandir()</code>返回一个包含目录中所有文件和目录的数组</li>
<li><code>closedir()</code>关闭通过<code>opendir()</code>打开的目录流。</li>
<li><code>readdir()</code>返回目录中下一个文件的文件名。文件名以在文件系统中的排序返回。</li>
</ul>
<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><p>下面这些函数允许你定义自己的错误处理规则，以及修改错误记录的方式：</p>
<ul>
<li><code>debug_backtrace()</code>产生一条PHP的回溯跟踪，返回数组类型；<code>debug_print_backtrace()</code>则将回溯打印出来。</li>
<li><code>error_get_last()</code>获取最后一个发生错误的信息，<code>error_clear_last()</code>清除最后一个错误信息</li>
<li><code>error_log()</code>发送错误信息到web服务器的错误日志或是一个文件里。</li>
<li><code>error_reporting()</code>设置应该报告的PHP错误级别。</li>
<li><code>set_error_handler</code>, <code>set_exception_handler</code>, <code>restore_error_handler</code>, <code>restore_exception_handler</code>分别是设置和重置错误以及异常处理的函数</li>
<li><code>trigger_error()</code>触发一个用户级别的错误条件，在运行出现异常时，需要产生一个特定响应时很有用。</li>
</ul>
<h4 id="session"><a href="#session" class="headerlink" title="session"></a>session</h4><p>在会话支持下，每个访问网站的用户都有一个唯一的id标识，这个标识可以存储在cookie中，也可以通过URL传递。当一个访问者访问网站时，PHP将自动检查(如果<code>session.auto_start</code>被设置为1）或者在你要求下检查(明确通过<code>session_start()</code>或者隐式通<code> session_register()</code>) 当前会话 id 是否是先前发送的请求创建. 如果是这种情况，那么先前保存的环境将被重建。</p>
<p>安全方面需要注意以下几点：</p>
<ul>
<li><code>session.cookie_lifetime=0</code>, 即浏览器不持久化存储cookie数据</li>
<li><code>session.use_cookies=On</code> 并且<code>session.use_only_cookies=On</code>，即通过HTTP cookie实现会话ID管理</li>
<li><code>session.use_strict_mode=On</code>，即禁止使用未初始化会话id的会话，从而防止Javascript进行会话ID的注入</li>
<li><code>session.cookie_httponly=On</code>，禁止Javascript访问会话ID</li>
<li><code>session.cookie_secure=On</code>，仅在HTTPS协议下访问session ID，用在仅支持HTTPS的站点</li>
<li><code>session.hash_function=&quot;sha256&quot;</code>。 高强度的散列函数可以产生高强度的会话ID</li>
</ul>
<p>其他注意事项可以在PHP的<a target="_blank" rel="noopener" href="http://php.net/manual/zh/session.security.php">会话与安全章节</a>找到，根据实际需要选择。下面是一些session函数的使用:</p>
<ul>
<li><code>session_destroy()</code>, 销毁一个会话里的全部数据，但不会重置相关全局变量也不会重置cookie，再次使用时需要重新调用<code>session_start()</code>函数。为彻底删除session，需要调用<code>setcookie()</code>清除cookie中的session ID。</li>
<li><code>session_cache_expire()</code>设置或读取当前缓存到期时间（这个只和浏览器页面刷新缓存有关）</li>
<li><code>session_id()</code>获取&#x2F;设置当前会话ID，PHP仅允许会话ID包括a-z A-Z 0-9 ,（逗号） -（减号）.如果不是用cookie来存储session ID，session ID通常附在SID常量中，放在URL里。</li>
<li><code>session_regenerate_id()</code>在不修改当前session数据的前提下使用新的ID替换原有会话ID。如果启用了<code>session.use_trans_sid</code>选项,那么必须在调用<code>session_regenerate_id()</code>函数之后开始进行输出工作，否则会导致使用原有的会话 ID</li>
<li><code>session_start()</code>创建新会话或者重用现有会话。 如果通过GET或者POST方式，或者使cookie提交了会话ID，则会重用现有会话。</li>
<li><code>session_status()</code>返回当前会话状态</li>
<li><code>session_write_close()</code>写入session数据，然后关闭会话</li>
<li><code>session_name()</code>设置或返回当前回话名称，名称应短小易懂，且不能由纯数字组成，如<code>website_id</code>。</li>
<li><code>session_save_path()</code>读取&#x2F;设置当前会话的保存路径</li>
<li><code>session_unset()</code>释放当前会话注册的所有会话变量</li>
</ul>
<h4 id="进程控制"><a href="#进程控制" class="headerlink" title="进程控制"></a>进程控制</h4><p>这部分函数提供执行系统本身命令的能力。注意，<strong>以加锁方式打开的文件，必须在执行后台程序前关闭</strong>。</p>
<ul>
<li><code>escapeshellarg(string $arg)</code>和<code>escapeshellcmd(string $command)</code>对参数和命令元字符转义，保证安全。</li>
<li><code>exec()</code>和<code>passthru()</code>都能执行一个外部程序，区别是前者返回结果的最后一行，后者返回未经处理的全部输出数据。</li>
<li><code>shell_exec()</code>在shell环境下执行命令，以字符串的形式返回完整的字符串。</li>
<li><code>system(string $command[, int &amp;$return_var ] )</code>执行 command 参数所指定的命令，并且输出执行结果。</li>
</ul>
<h4 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h4><ul>
<li><code>call_user_func(callable $callback [, mixed $parameter [, mixed $... ]])</code>把第一个参数作为回掉函数调用。在参数很多时，建议使用$callback(…values)的形式传入数组。类似的还有<code>forward_static_call</code>和<code>forward_static_call_array</code>用来调用静态方法。</li>
<li><code>func_get_arg(int $arg_num)</code>和<code>func_get_arg()</code>返回自定义函数的参数和参数列表，用在函数体内。</li>
<li><code>function_exists()</code>判断函数是否定义</li>
<li><code>register_shutdown_function</code>, <code>register_tick_function</code>用来注册<code>exit</code>之后和每个tick后执行的函数</li>
</ul>
<h4 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h4><p>这部分函数自5.1.2版本后成为核心的一部分。</p>
<ul>
<li><code>hash()</code>根据指定的哈希算法生成哈希值。类似的还有<code>hash_file</code>。</li>
<li><code>hash_hmac()</code>使用HMAC方法生成带有密钥的哈希值，类似的还有<code>hash_hmac_file</code>。</li>
<li><code>hash_init()</code>初始化一个哈希运算上下文，返回resource类型</li>
<li><code>hash_update(resource $context , string $data)</code>向活跃的哈希运算上下文中填充数据。细化的，还有<code>hash_update_file</code>和<code>hash_update_stream</code>两个函数。</li>
<li><code>hash_final()</code>结束哈希上下文，返回摘要内容。</li>
<li><code>hash_copy()</code>返回一个哈希运算上下文副本。</li>
</ul>
<h4 id="PHP自身"><a href="#PHP自身" class="headerlink" title="PHP自身"></a>PHP自身</h4><p>这些函数允许你获得许多关于PHP本身的参数。</p>
<ul>
<li><code>assert()</code>检查一个断言是否为FALSE，并在失败的时候调用<code>assert_options()</code>中指定的回调函数</li>
<li><code>dl()</code>运行时加载一个PHP扩展</li>
<li><code>get_cfg_var()</code>获取PHP配置选项的值</li>
<li><code>get_current_user()</code>获取当前PHP脚本所有者名称</li>
<li><code>get_included_files()</code>返回被include和require文件名的 array</li>
<li><code>ini_get()</code>获取一个配置选项的值</li>
<li><code>ini_set()</code>设置指定配置选项的值。这个选项会在脚本运行时保持新的值，并在脚本结束时恢复</li>
<li><code>ini_restore()</code>恢复指定的配置选项到它的原始值</li>
<li><code>memory_get_usage()</code>返回当前分配给你的 PHP 脚本的内存量，单位是字节（byte）</li>
<li><code>php_sapi_name()</code>返回web服务器和PHP之间的接口类型</li>
<li><code>php_uname()</code>返回运行PHP的系统的有关信息</li>
<li><code>phpinfo([int $what = INFO_ALL])</code>输出关于 PHP 配置的信息。可以通过<code>what</code>筛选输出内容。</li>
<li><code>phpversion()</code>获取当前的PHP版本</li>
<li><code>version_compare()</code>对比两个「PHP 规范化」的版本数字字符串</li>
</ul>
<h4 id="数学"><a href="#数学" class="headerlink" title="数学"></a>数学</h4><p>这部分函数处理integer和float范围内的计算。预定义常量包括<code>M_PI</code>, <code>M_E</code>, <code>M_LOG2E</code>, <code>M_LN2</code>, <code>M_PI_2</code>, <code>M_1_PI</code>, <code>M_SQRT2</code>, <code>M_SQRT3</code>, <code>INF</code>等诸多数学常量。函数名和其他语言类似。</p>
<ul>
<li>三角函数相关：<code>sin</code>, <code>cos</code>, <code>tan</code>, <code>asin</code>, <code>acos</code>, <code>atan</code>计算单位为弧度</li>
<li>双曲函数相关：<code>sinh</code>, <code>cosh</code>, <code>tanh</code>, <code>asinh</code>, <code>acosh</code>, <code>atanh</code>, <code>atan2</code></li>
<li>对数相关：<code>log</code>, <code>log10</code>, <code>log1p</code></li>
<li>指数相关：<code>pow</code>, <code>exp</code>, <code>expm</code></li>
<li>近似相关：<code>round</code>, <code>floor</code>, <code>ceil</code></li>
<li>随机数相关： <code>rand(int $min , int $max)</code>, <code>mt_rand</code>（用法同<code>rand</code>，性能更好）, <code>srand</code>和<code>mt_srand</code>（现已不需要使用）</li>
<li>进制转换相关：<code>bindec</code>, <code>octdec</code>, <code>hexdec</code>转为十进制数（读取字符串，输出数字），相对应还有<code>decbin</code>, <code>decbin</code>, <code>dechex</code>。<code>base_convert()</code>可以做任意进制转换</li>
<li>角度相关：<code>deg2rad</code>角度转弧度</li>
<li>运算相关：<code>intdiv</code>返回商的整数部分，<code>fmod</code>返回浮点数余数。<code>abs</code>计算绝对值，<code>sqrt</code>计算开根号</li>
<li>判断相关：<code>is_finite</code>, <code>is_infinite</code>, <code>is_nan</code>,</li>
<li>其他：<code>max</code>, <code>min</code>（可以输入数组）, <code>pi</code>, <code>hypot</code>（根据直角边计算三角形斜边长）</li>
</ul>
<h4 id="输出控制"><a href="#输出控制" class="headerlink" title="输出控制"></a>输出控制</h4><p>PHP脚本有输出时，输出控制函数可以用这些来控制输出。如通过<code>ob_start()</code>将下文的输出放在缓冲区直到调用<code>ob_end_flush()</code>。通常配合<code>header()</code>使用，在真正返回数据前写入header和cookie。</p>
<p>从略。</p>
<h4 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h4><ul>
<li><code>constant()</code>返回一个常量的值</li>
<li><code>define()</code>定义一个常量</li>
<li><code>exit()</code>输出一个消息并且退出当前脚本，<code>die</code>是<code>exit</code>的同名函数。</li>
<li><code>highlight_file()</code>语法高亮一个文件</li>
<li><code>highlight_string()</code>语法高亮一个字符串，使用方法同上。</li>
<li><code>sleep()</code>延迟指定秒数执行。类似的还有<code>usleep</code>以指定微秒数暂缓执行，<code>time_sleep_until</code>使脚本睡眠到指定时间</li>
<li><code>uniqid()</code>返回一个基于当前微秒级时间的带前缀的唯一ID。</li>
</ul>
<h3 id="绑定拓展库"><a href="#绑定拓展库" class="headerlink" title="绑定拓展库"></a>绑定拓展库</h3><p>下面的拓展库绑定在PHP发行包中。较之内核部分的函数，更偏向为解决某类问题而设计。这里也只摘选部分常用的介绍。</p>
<h4 id="Ctype"><a href="#Ctype" class="headerlink" title="Ctype"></a>Ctype</h4><p>用来检测 在当前的区域设定下，一个字符或者字符串 是否仅包含指定类型的字符。根据官方描述，<strong>“如果可以满足需求，请优先考虑使用 ctype 函数， 而不是正则表达式或者对应的 “str_*” 和 “is_*” 函数。 因为 ctype 使用的是原生 C 库，所以会有明显的性能优势”</strong>。在4.2.0版本后，这些函数是默认启动的。</p>
<ul>
<li><code>ctype_alpha()</code>纯字符检测</li>
<li><code>ctype_upper()</code>大写字母检测</li>
<li><code>ctype_lower()</code>小写字母检测</li>
<li><code>ctype_digit()</code>纯数字检测</li>
<li><code>ctype_alnum()</code>检查字符串内的字符否全部为字母或数字</li>
<li><code>ctype_cntrl()</code>控制字符检测</li>
<li><code>ctype_print()</code>字符是否都可以打印</li>
<li><code>ctype_graph()</code>字符输出是否都是可见的</li>
<li><code>ctype_punct()</code>字符是否都可打印却不是字母数组和空白</li>
<li><code>ctype_space()</code>空白字符检测</li>
<li><code>ctype_xdigit()</code>十六进制字符串检测</li>
</ul>
<h4 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h4><p>在PHP5.3版本后，原来的POSIX Regex不再推荐使用。兼容Perl的正则表达式库PCRE仍可以使用，且默认开启。这里仅介绍PCRE相关函数，它们均以<code>preg</code>开头。</p>
<ul>
<li><code>preg_match()</code>返回pattern在subject中的匹配次数</li>
<li><code>preg_match_all()</code>搜索subject中所有匹配pattern给定正则表达式的匹配结果并且将它们以指定顺序输出到matches结果中.</li>
<li><code>preg_replace()</code>执行一个正则表达式的搜索和替换，当$pattern和$replacement都是数组时，会进行相对应位置的替换。</li>
<li><code>preg_grep(string $pattern , array $input [, int $flags = 0 ])</code>返回给定数组input中与模式pattern 匹配的元素组成的数组.</li>
<li><code>preg_split()</code>通过正则表达式分割字符串，返回一个数组。</li>
</ul>
<h4 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h4><p>自5.2.0起，JSON拓展默认内置并编译进PHP。</p>
<ul>
<li><code>json_encode()</code>JSON编码一个变量。</li>
<li><code>json_decode()</code>解码一个JSON格式的字符串</li>
<li><code>json_last_error()</code>返回JSON编码时最后的错误</li>
</ul>
<h4 id="多字节字符串"><a href="#多字节字符串" class="headerlink" title="多字节字符串"></a>多字节字符串</h4><p>在汉语中，每个字符通常占用2个字节，在使用string的相关函数时，可能会出现意外问题。多字节字符串即为了解决此问题。这不是一个默认扩展，需要在configure选项中显式激活。详见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/mbstring.installation.php">安装</a>。另外，<code>mbstring</code>支持“函数重载”，即使用<code>mb_xxx</code>替代原有的字符串函数。</p>
<ul>
<li><code>mb_detect_encoding()</code>检测字符的编码</li>
<li><code>mb_ereg_xxx</code>打头的与<code>preg_xxx</code>同名的函数为正则匹配多字节版</li>
<li><code>mb_strlen()</code>获取字符串长度。</li>
<li><code>mb_split()</code>使用正则表达式分割多字节字符串</li>
<li><code>mb_substr()</code>执行一个多字节安全的<code>substr()</code>操作</li>
<li><code>mb_strpos()</code>查找字符串在另一个字符串中首次出现的位置；类似地，<code>mb_strrpos</code>查找最后出现的位置。</li>
<li><code>mb_strstr ()</code>查找字符串在另一个字符串里的首次出现；类似地，<code>mb_strrchr()</code>查找指定字符在另一个字符串中最后一次的出现</li>
</ul>
<h4 id="BCMath"><a href="#BCMath" class="headerlink" title="BCMath"></a>BCMath</h4><p>这部分函数进行任意大小和精度的数字的二进制计算。自4.0.4后随PHP一起发布。Windows版本下是默认支持的。</p>
<ul>
<li><code>string bcadd(string $left_operand , string $right_operand [, int $scale ] )</code>加法。scale用来决定小数点位数，输入输出均未string类型，下同。</li>
<li><code>bcsub()</code>减法</li>
<li><code>int bccomp()</code>比较</li>
<li><code>bcmul()</code>乘法</li>
<li><code>bcdiv()</code>除法</li>
<li><code>bcmod()</code>取模</li>
<li><code>bcpow()</code>乘方</li>
<li><code>bcsqrt()</code>二次方根</li>
<li><code>bcscale()</code>设置所有bc数学函数的默认小数点位数</li>
</ul>
<h4 id="图像处理"><a href="#图像处理" class="headerlink" title="图像处理"></a>图像处理</h4><p>PHP可以处理各种格式的图像，并把它们输出到浏览器。这需要在编译时指定GD库（除了<code>getimagesize()</code>函数）。GD库不仅能处理图像，还能对字体进行处理。使用PHP可以动态修改图像文件，或为图像添加水印信息，甚至创建一个图像。</p>
<p>下面是和图像信息相关的函数：</p>
<ul>
<li><code>gd_info()</code>获取当前安装的GD库信息</li>
<li><code>getimagesize()</code>获取图像大小，返回数组类型，按顺序分别是宽度，高度，类型，描述宽高的字符串。<code>getimagesizefromstring</code>函数则通过打开的图片信息（字符串格式）中读取图像尺寸信息</li>
<li><code>image_type_to_extension()</code>获取图像类型的文件后缀</li>
<li><code>imageistruecolor(resource $image)</code>检查图像是否为真彩色</li>
<li><code>imagesx()</code>返回image所代表的图像宽度；<code>imagesy()</code>返回所代表的图像高度</li>
<li><code>imagetypes()</code>返回PHP支持的图像类型，int类型。</li>
</ul>
<p>剩下还有众多以<code>image</code>开头的和创建、输出、删除图像，画图、编辑图片、设置颜色、设置字体相关的函数，见<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/book.image.php">参考</a>。</p>
<h4 id="Exif"><a href="#Exif" class="headerlink" title="Exif"></a>Exif</h4><p>通过Exif拓展，可以操作图像元数据。必须使用<code>--enable-exif</code>选项编译PHP，Windows用户还需要启用mbstring扩展。</p>
<ul>
<li><code>exif_imagetype()</code>读取一个图像的第一个字节并检查其签名</li>
<li><code>exif_read_data()</code>函数从JPEG或TIFF图像文件中读取EXIF头信息</li>
<li><code>exif_thumbnail()</code>读取TIFF或JPEG图像中的嵌入缩略图。如果图像不包含缩略图则返回FALSE</li>
</ul>
<h4 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h4><p>Socket拓展基于流行的BSD sockets，实现了和socket通讯功能的底层接口。在编译PHP时必须在配置中添加—enable-sockets配置项。利用这部分函数可以很方便地搭建起socket服务器和客户端，示例见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/sockets.examples.php">官网</a>。</p>
<ul>
<li><code>socket_create(int $domain , int $type , int $protocol)</code>创建并返回一个套接字（resource类型）。其中<code>domain</code>指定使用的网络协议族，<code>type</code>指定建立的套接字类型，<code>protocol</code>指定使用的具体协议。</li>
<li><code>socket_create_listen()</code>在某端口打开socket以接收连接。</li>
<li><code>socket_bind()</code>绑定网络地址到套接字的源。</li>
<li><code>socket_connect()</code>使用address作为目的地址，建立套接字连接。</li>
<li><code>socket_listen()</code>在创建好socket资源，并绑定了source address后，可以调用此函数监听进入的数据流。</li>
<li><code>socket_accept()</code>在依次使用socket_create创建套接字，使用<code>socket_bind</code>绑定端口，使用<code>socket_listen</code>监听连接后。该函数允许到此套接字上的连接，返回一个新的socket资源用来通信。</li>
<li><code>socket_read()</code>从已连接的socket中读取一段长度的数据，返回读出的数据。</li>
<li><code>socket_recv()</code>功能同上，返回字节数并将数据存放在<code>$buf</code>中。</li>
<li><code>socket_recvfrom() </code>从已连接和还未连接的socket中读取数据。</li>
<li><code>socket_write()</code>向socket中写入数据</li>
<li><code>socket_send()</code>向已连接的socket中写入数据。</li>
<li><code>socket_sendto()</code>向socket中发送数据而不管是否已连接</li>
<li><code>socket_getsockname()</code>和<code>socket_getpeername()</code>获取本地和远端socket信息</li>
<li><code>socket_set_block()</code>和<code>socket_set_nonblock()</code>设置socket是否阻塞</li>
<li><code>socket_set_option()</code>设置套接字选项</li>
<li><code>socket_shutdown()</code>停止从socket中读写数据</li>
<li><code>socket_close()</code>关闭给定的socket资源</li>
</ul>
<h3 id="外部拓展库"><a href="#外部拓展库" class="headerlink" title="外部拓展库"></a>外部拓展库</h3><p>这些扩展库已经绑定在PHP发行包中，但是要编译以下扩展库，需要外部的库文件。这里仅介绍常用的cURL库。Mysqli和Mongo等可能会用得到的库介绍从略。</p>
<h4 id="client-URL"><a href="#client-URL" class="headerlink" title="client URL"></a>client URL</h4><p>PHP支持Daniel Stenberg创建的libcurl库，能够连接通讯各种服务器、使用各种协议。这些curl函数在PHP 4.0.2中引入。需要安装libcurl包才能使用PHP的cURL函数。安装过程从略。curl的使用流程思路和socket，mysql等十分相似，先使用<code>curl_init()</code>初始化会话，再使用<code>curl_setopt()</code>设置选项，然后通过<code>curl_exec()</code>执行会话，最后使用<code>curl_close()</code>关闭。</p>
<ul>
<li><code>curl_setopt()</code>设置一个传输选项，常用的设置包括<code>CURLOPT_URL</code>, <code>CURLOPT_HEADER</code>, <code>CURLOPT_RETURNTRANSFER</code>, <code>CURLOPT_TIMEOUT</code>等。类似的，还有<code>curl_setopt_array</code>函数。</li>
<li><code>curl_reset()</code>重置一个libcurl会话句柄的所有的选项</li>
<li><code>curl_exec()</code>执行一个cURL会话。返回TRUE或执行的结果，或是FALSE。</li>
<li><code>curl_close()</code>关闭一个会话，释放所有相关资源</li>
<li><code>curl_getinfo()</code>获取最后一次传输的相关信息。</li>
<li><code>curl_error()</code>返回一条最近一次cURL操作明确的文本的错误信息</li>
<li><code>curl_version()</code>获取cURL版本信息</li>
</ul>
<h2 id="特色"><a href="#特色" class="headerlink" title="特色"></a>特色</h2><p>这里列举的特点更多是PHP语言的特殊使用方式与应用特性。如HTTP用户认证（介绍见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/features.http-auth.php">官网</a>），cookie等。</p>
<p>PHP透明地支持HTTP cookie，在PHP的网络函数中可以用<code>setcookie()</code>或<code>setrawcookie()</code>函数来设置cookie。cookie是HTTP标头的一部分，因此<code>setcookie()</code>函数必须在其它信息被输出到浏览器前调用，这和对header()函数的限制类似。可以使用输出缓冲函数来延迟脚本的输出，直到按需要设置好了所有的cookie或者其它HTTP标头。</p>
<p>PHP允许用户使用POST方法上传文本和二进制文件。一个上传文件的HTML表单代码类似如下，其中的<code>MAX_FILE_SIZE</code>隐藏字段在浏览器端限制了文件大小（单位字节，不建议依赖于此）：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- The data encoding type, enctype, MUST be specified as below --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span> <span class="attr">action</span>=<span class="string">&quot;__URL__&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MAX_FILE_SIZE must precede the file input field --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;MAX_FILE_SIZE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Name of input element determines name in $_FILES array --&gt;</span></span><br><span class="line">    Send this file: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;userfile&quot;</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Send File&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>全局变量<code>$_FILES</code>自PHP4.1.0起存在，包含了所有上传的文件信息。<code>$_FILES[&#39;userfile&#39;]</code>数组有<code>name</code>, <code>type</code>, <code>size</code>, <code>tmp_name</code>, <code>error</code>等字段。error字段状态码在0-7间，分别表示上传成功&#x2F;文件过大&#x2F;部分上传&#x2F;没有文件&#x2F;找不到临时文件夹&#x2F;写入失败。文件被上传后，默认地会被储存到服务端的默认临时目录中。</p>
<p>PHP支持同时上传多个文件并将它们的信息自动以数组的形式组织。要完成这项功能，需要在HTML表单中对文件上传域使用和多选框与复选框相同的数组式提交语法。像下面的代码那样：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;file-upload.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">  Send these files:<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;userfile[]&quot;</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;userfile[]&quot;</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Send files&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同时，PHP还支持PUT方法上传文件，内容见官方文档。下面是一个允许用户上传图片的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/plain; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Undefined | Multiple Files | $_FILES Corruption Attack</span></span><br><span class="line">    <span class="comment">// If this request falls under any of them, treat it invalid.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        !<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]) ||</span><br><span class="line">        <span class="title function_ invoke__">is_array</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;error&#x27;</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;Invalid parameters.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check $_FILES[&#x27;upfile&#x27;][&#x27;error&#x27;] value.</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> UPLOAD_ERR_OK:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> UPLOAD_ERR_NO_FILE:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;No file sent.&#x27;</span>);</span><br><span class="line">        <span class="keyword">case</span> UPLOAD_ERR_INI_SIZE:</span><br><span class="line">        <span class="keyword">case</span> UPLOAD_ERR_FORM_SIZE:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;Exceeded filesize limit.&#x27;</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;Unknown errors.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// You should also check filesize here. </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1000000</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;Exceeded filesize limit.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DO NOT TRUST $_FILES[&#x27;upfile&#x27;][&#x27;mime&#x27;] VALUE !!</span></span><br><span class="line">    <span class="comment">// Check MIME Type by yourself.</span></span><br><span class="line">    <span class="variable">$finfo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">finfo</span>(FILEINFO_MIME_TYPE);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$ext</span> = <span class="title function_ invoke__">array_search</span>(</span><br><span class="line">        <span class="variable">$finfo</span>-&gt;<span class="title function_ invoke__">file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]),</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;jpg&#x27;</span> =&gt; <span class="string">&#x27;image/jpeg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;png&#x27;</span> =&gt; <span class="string">&#x27;image/png&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;gif&#x27;</span> =&gt; <span class="string">&#x27;image/gif&#x27;</span>,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    )) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;Invalid file format.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// You should name it uniquely.</span></span><br><span class="line">    <span class="comment">// DO NOT USE $_FILES[&#x27;upfile&#x27;][&#x27;name&#x27;] WITHOUT ANY VALIDATION !!</span></span><br><span class="line">    <span class="comment">// On this example, obtain safe unique name from its binary data.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">move_uploaded_file</span>(</span><br><span class="line">        <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],</span><br><span class="line">        <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;./uploads/%s.%s&#x27;</span>,</span><br><span class="line">            <span class="title function_ invoke__">sha1_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]),</span><br><span class="line">            <span class="variable">$ext</span></span><br><span class="line">        )</span><br><span class="line">    )) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;Failed to move uploaded file.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;File is uploaded successfully.&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在php.ini文件中激活了<code>allow_url_fopen</code>选项后，可以在大多数需要用文件名作为参数的函数中使用HTTP和FTP的URL来代替文件名。同时，也可以在<code>include</code>、<code>include_once</code>、<code>require</code>及<code>require_once</code>语句中使用URL。如果有合法的访问权限，以一个用户的身份和某FTP服务器建立了链接，还可以向该FTP服务器端的文件进行写操作。</p>
<p>持久的数据库连接是指在脚本结束运行时不关闭的连接。当收到一个持久连接的请求时。PHP将检查是否已经存在一个（前面已经开启的）相同的持久连接。如果存在，将直接使用这个连接；如果不存在，则建立一个新的连接。所谓“相同”的连接是指用相同的用户名和密码到相同主机的连接。</p>
<p>PHP 5.3后使用GC作为新的垃圾回收机制。每个php变量存在一个叫”zval”的变量容器中。一个zval变量容器，除了包含变量的类型和值，还包括两个字节的额外信息。第一个是”is_ref”，是个bool值，用来标识这个变量是否是属于引用集合(reference set)。第二个额外字节是”refcount”，用以表示指向这个zval变量容器的变量(也称符号即symbol)个数。通常，PHP中的垃圾回收机制，仅仅在循环回收算法确实运行时会有时间消耗上的增加。但是在平常的(更小的)脚本中应根本就没有性能影响。</p>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><p>PHP作为一种强大的语言，无论是以模块还是CGI的方式安装，它的解释器都可以在服务器上访问文件、运行命令以及创建网络连接等。这些功能也许会给服务器添加很多不安全因素，但是只要正确地安装和配置PHP，以及编写安全的代码，那么PHP相对于Perl和C来说，是能创建出更安全的CGI程序的。这部分提出一些原则，在不同环境下尽可能提高安全性。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>以CGI模式安装PHP时，它的设计可以用以避免访问系统文件和服务器的任意目录。在安装时配置一些选项可以有助避免这类攻击。具体见<a target="_blank" rel="noopener" href="http://php.net/manual/zh/security.cgi-bin.attacks.php">文档介绍</a>。同理，以Apache模块安装时，权限的注意也请见<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/security.apache.php">官网介绍</a>。</p>
<h3 id="Session安全"><a href="#Session安全" class="headerlink" title="Session安全"></a>Session安全</h3><p>这部分见<a href="####session">Session部分</a>的安全介绍。</p>
<h3 id="文件系统-1"><a href="#文件系统-1" class="headerlink" title="文件系统"></a>文件系统</h3><p>PHP被设计为以用户级别来访问文件系统，所以完全有可能通过编写一段PHP代码来读取系统文件如<code>/etc/passwd</code>，更改网络连接以及发送大量打印任务等等。因此必须确保PHP代码读取和写入的是合适的文件。</p>
<p>由于PHP的文件系统操作是基于C语言的函数的，Null字符在C语言中用于标识字符串结束，一个完整的字符串是从其开头到遇见Null字符为止。因此，任何用于操作文件系统的字符串（特别是程序外部输入的字符串）都必须经过适当的检查。</p>
<p>这种安全问题也会出现在执行来自用户输入的命令。通常有两条路可以选择：1）检查所有来自外部的变量（<strong>黑名单</strong>）；2）后台写死可以执行的文件名或命令有限集（<strong>白名单</strong>）</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>由于敏感数据和机密数据通常存储在数据库中，数据库安全和保护显得尤为重要。<strong>PHP本身并不能保护数据库的安全</strong>。这里只是讲述怎样用PHP脚本对数据库进行基本的访问和操作。</p>
<p><strong>设计数据库时，永远不要使用数据库所有者或超级用户帐号来连接数据库</strong>，因为这些帐号可以执行任意的操作。应该为程序的每个方面创建不同的数据库帐号，并赋予对数据库对象的极有限的权限。同时，一些功能可以用视图（view）、触发器（trigger）或者规则（rule）在数据库层面完成。</p>
<p><strong>连接数据库</strong>时，把连接建立在 SSL 加密技术上可以增加客户端和服务器端通信的安全性，或者SSH也可以用于加密客户端和数据库之间的连接。</p>
<p><strong>存储模型</strong>中，可以散列一些没必要明文显示的数据，建议加盐散列，同时采用新的SHA散列算法（如SHA-2或SHA-3）以增加安全程度。</p>
<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><p>这部分内容是极为常见的网络安全问题，通过构造特殊的SQL语句，获取数据库信息甚至主机权限，介绍从略。</p>
<p>在预防措施上，<strong>永远不要信任外部输入的任何数据，包括表单里和cookie的信息</strong>。</p>
<ul>
<li>使用权限被严格限制的帐号访问数据库</li>
<li>检查输入的数据是否具有所期望的数据格式</li>
<li>减少SQL语句的拼接使用</li>
<li>使用数据库特定的敏感字符转义函数</li>
<li>还可以选择使用数据库的存储过程和预定义指针等特性来抽象数库访问，使用户不能直接访问数据表和视图</li>
</ul>
<h3 id="错误报告"><a href="#错误报告" class="headerlink" title="错误报告"></a>错误报告</h3><p>错误报告是一把双刃剑。一方面可以提高安全性，另一方面又有利于攻击者收集服务器的信息以便寻找弱点。PHP的独有的错误提示风格可以说明系统在运行 PHP，一个函数错误可能暴露系统正在使用的数据库，一个文件系统或者PHP的错误就会暴露web服务器具有什么权限，以及文件在服务器上的组织结构等。</p>
<p>有三个常用的办法处理这些问题。第一个是彻底地检查所有函数，并尝试弥补大多数错误。第二个是对在线系统彻底关闭错误报告。第三个是使用 PHP 自定义的错误处理函数创建自己的错误处理机制</p>
<p>可以通过<code>error_reporting()</code>帮助找到错误所在并使代码更安全。发布程序前，设置为<code>E_ALL</code>找到所有使用不当的地方；正式发布后，设为0彻底关闭错误报告或设置<code>php.ini</code>中的<code>display_errors</code>为<code>off</code>。</p>
<h3 id="隐藏PHP"><a href="#隐藏PHP" class="headerlink" title="隐藏PHP"></a>隐藏PHP</h3><p>一些简单的方法可以帮助隐藏 PHP，这样做可以提高攻击者发现系统弱点的难度。在<code>php.ini</code>文件里设置<code>expose_php = off</code>，可以减少他们能获得的有用信息。</p>
<p>另一个策略就是让web服务器用PHP解析不同扩展名。无论是通过<code>.htaccess</code>文件还是Apache的配置文件，都可以设置能误导攻击者的文件扩展名。</p>
<p>更多机智的隐藏方法见官网<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/security.hiding.php">隐藏PHP</a>一节。</p>
<h2 id="内核-1"><a href="#内核-1" class="headerlink" title="内核"></a>内核</h2><p>考虑到重点所在，这部分内容仅简单地介绍一些涉及到PHP内部原理的东西。由于PHP运行在C语言的基础上，以下的内容和C语言编程靠近。</p>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>用C语言编程时，开发者要手工地进行内存管理。因为PHP经常用作Web服务器的模块，内存管理与预防内存泄漏紧密关联。此外，Zend引擎要面对一个十分特殊的使用模式：在一段比较短的时间内，许多zval结构大小的内存块和其他的小内存块被请求又再被释放。为了满足以上的需求，Zend引擎提供为了处理请求相关数据提供了一种特殊的内存管理器。请求相关数据是指只需要服务于单个请求，最迟会在请求结束时释放的数据。<em>API介绍从略</em>。</p>
<p>因为安全原因，在请求结束时，Zend引擎会释放所有由上面提到的API所分配的内存。</p>
<h3 id="变量使用"><a href="#变量使用" class="headerlink" title="变量使用"></a>变量使用</h3><p>PHP变量，通常来说，由两部分组成：标签（例如，可能是符号表中的一个条目）和实际变量容器。变量容器，在代码中称为zval，掌握了所需处理变量的所有数据。 包括实际值、当前类型、统计指向此容器的标签的数量，和指示这些标签是引用还是副本的标志。在PHP 5.3中，结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> <span class="title">zval</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">zvalue_value</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> lval;                 <span class="comment">/* long value */</span></span><br><span class="line">    <span class="type">double</span> dval;               <span class="comment">/* double value */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span>                   <span class="comment">/* string type */</span></span><br><span class="line">        <span class="type">char</span> *val;</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">    &#125; str;</span><br><span class="line">    HashTable *ht;             <span class="comment">/* hash table value */</span></span><br><span class="line">    zend_object_value obj;</span><br><span class="line">&#125; zvalue_value;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Variable information */</span></span><br><span class="line">    zvalue_value value;        <span class="comment">/* value */</span></span><br><span class="line">    zend_uint refcount__gc;</span><br><span class="line">    zend_uchar type;           <span class="comment">/* active type */</span></span><br><span class="line">    zend_uchar is_ref__gc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>有关函数，类和对象，流等的介绍从略。</p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>Q: PHP 版本之间有什么联系？<br>A: PHP&#x2F;FI 2.0是最早的PHP版本，已经不再支持。PHP 3是PHP&#x2F;FI 2.0的后继者，要好很多。PHP 5是目前一代的PHP，内部使用了Zend 2引擎，除了很多新功能之外还提供了许多附加的面向对象编程（OOP）特性。<br><br><br>Q: 可以同时运行几个不同版本的PHP吗？<br>A: 可以，请参阅见PHP源程序发行包中的 INSTALL文件。<br><br><br>Q: 应该上哪儿去找我的<code>php.ini</code>文件<br>A: UNIX中默认在<code>/usr/local/lib</code>目录中，也就是<code>&lt;install-path&gt;/lib</code>。可以在编译时通过 <code>--with-config-file-path</code>标记来改变路径。Windows中<code>php.ini</code>文件的默认路径在Windows目录下。如果使用的是Apache服务器，则会首先在Apache的安装目录中寻找<code>php.ini</code>。<br><br><br>Q: PHP是否仅限于处理GET和POST请求方法？<br>A: 不是，PHP有可能处理任何请求方法，例如<code>CONNECT</code>。适当的回应状态可以用<code>header()</code>发送。<br><br><br>Q: 我忘了PHP函数的参数顺序，它们是随机的吗？<br>A: 通常情况下，数组函数的参数里，needle在前，haystack在后；字符串函数中，haystack在前，needle在后。<br><br><br>Q: PHP选项<code>register_globals</code>对我有什么影响？<br>A: 强烈不建议开启此选项，<code>register_globals</code>会自动生成变量。<br><br><br>Q: 我需要直接访问请求报头中的信息，怎么能办到？<br>A: 如果以Apache的模块方式运行PHP，那么函数<code>getallheaders()</code>可以做这件事。<br><br><br>Q: 如果不建议使用常用散列函数保护密码， 那么我应该如何对密码进行散列处理？<br>A: 当进行密码散列处理的时候，有两个必须考虑的因素： 计算量以及“盐”。 散列算法的计算量越大，暴力破解所需的时间就越长。PHP 5.5提供了一个原生密码散列API， 它提供一种安全的方式来完成密码散列和验证。 PHP 5.3.7及后续版本中都提供了一个纯PHP的兼容库。PHP 5.3及后续版本中，还可以使用<code>crypt()</code>函数，它支持多种散列算法。针对每种受支持的散列算法，PHP都提供了对应的原生实现。<br><br><br>Q: “盐”是什么？<br>A: 加解密领域中的“盐”是指在进行散列处理的过程中 加入的一些数据，用来避免从已计算的散列值表（被称作“彩虹表”中对比输出数据从而获取明文密码的风险。<br><br><br>Q: 我在使用<code>&lt;input type=&quot;image&quot;&gt;</code>标记，但是没有<code>$foo.x</code>和<code>$foo.y</code>变量，它们哪去了？<br>A: 当提交表单时，可以用图片代替标准的提交按钮，用类似这样的标记<br><code>&lt;input type=&quot;image&quot; src=&quot;image.gif&quot; name=&quot;foo&quot; /&gt;</code><br>当用户点击了图片的任何部分，该表单会被发送到服务器并加上两个额外的变量：<code>foo.x</code>和<code>foo.y</code>。因为<code>foo.x</code>和 <code>foo.y</code>在PHP中会成为非法的变量名，它们被自动转换成了<code>foo_x</code>和<code>foo_y</code>。也就是用下划线代替了点。<br><br><br>Q: PHP 5中还能用MySQL吗？好像找不到了。<br>A: MySQL依然被支持，唯一区别是PHP 5中默认为不激活。这意味着在PHP的configure一行中不包含有<code>--with-mysql</code>选项，因此必须在编译时手工加入。Windows用户可以编辑<code>php.ini</code>并激活<code>php_mysql.dll</code>。<br><br><br>Q: 在函数定义中，参数旁边的<code>&amp;</code>是什么意思？<br>A: 这表示该参数是引用传递，该函数会修改其值。鼓励使用的方法是在函数定义中指定哪些参数应该用引用传递。在函数调用时通过引用传递参数是不推荐的，因为它影响到了代码的整洁。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://php.net/manual/zh/book.password.php">php.net</a></li>
<li><a target="_blank" rel="noopener" href="https://laravel-china.github.io/php-the-right-way/">PHP之道中文版</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/blog/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/blog/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/31/">31</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/blog/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2014 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shenlvmeng</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">1.1m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">29:45</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/schemes/muse.js"></script><script src="/blog/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.14.3/algoliasearch-lite.umd.js" integrity="sha256-dyJcbGuYfdzNfifkHxYVd/rzeR6SLLcDFYEidcybldM=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.49.2/instantsearch.production.min.js" integrity="sha256-Nu8yqoXoRZEVYyZf4/eY1V4FsenbiCw85RY3gWjN3zQ=" crossorigin="anonymous"></script><script src="/blog/js/third-party/search/algolia-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/blog/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"shenlvmengs-blog","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/blog/js/third-party/comments/disqus.js"></script>

</body>
</html>
